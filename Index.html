<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS | Emergency Patient Flow</title>
    <!-- Load Firebase/Tailwind/Icons/Tone.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');
        
        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Instances (Initialized inside initializeFirebase)
        let app, db, auth, userId = null;
        let isAuthReady = false; // Flag to ensure DB operations only run after auth/mock is ready
        let useMockDb = false; // Flag for mock data mode
        
        // All patients loaded from DB/Mock DB
        let allPatients = []; 
        // Derived lists for UI
        let receivingPatients = []; 
        let stationPatients = [];
        let archivedPatients = [];
        let mockPatients = []; // Mock database for when Firebase is unavailable
        let updateTimerInterval; // Interval for real-time timer updates

        // Tone.js Synth for the Bell Alert
        let alertSynth = null; 
        
        // Mock Staff for assignment feature
        const mockStaff = [
            { id: 'DR101', name: 'Dr. Emily Carter', role: 'Doctor' },
            { id: 'DR102', name: 'Dr. Ben Jones', role: 'Doctor' },
            { id: 'NR201', name: 'Nurse Lisa Kim', role: 'Nurse' },
            { id: 'NR202', name: 'Nurse David Chen', role: 'Nurse' },
        ];
        
        // Dictionary for multilingual content
        const dictionary = {
            en: {
                title: "SAMS | Emergency Patient Flow",
                slogan: "Real-time Clinical Intake & Triage",
                userIdText: "User ID:",
                nav: {
                    home: "Home",
                    patientEntry: "Patient Entry",
                    receiving: "Receiving",
                    station: "Station View",
                    archive: "Archive",
                    contact: "Contact"
                },
                home: {
                    heading: "Welcome to SAMS Intake System",
                    p1: "This interface is designed for rapid patient entry and triage management in the Emergency Room. Please use the Patient Entry tab to log incoming patients immediately.",
                    p2: "The Receiving tab shows all pending patients awaiting clinical assignment. The Station tab tracks active patients, and the Archive tab holds discharged records. This list is updated in real-time.",
                },
                patientEntry: {
                    heading: "ER Patient Quick Entry",
                    nameLabel: "Patient Full Name",
                    dobLabel: "Date of Birth (DOB)",
                    complaintLabel: "Chief Complaint (Symptoms/Injury)",
                    vitalsHeading: "Initial Vitals", 
                    bpmLabel: "BPM (Heart Rate)", 
                    bpLabel: "Blood Pressure (Sys/Dia)", 
                    paramedicLabel: "Paramedic/Sending Team Name", 
                    priorityLabel: "Triage Priority",
                    priorities: { low: "Low (Scheduled/Stable)", medium: "Medium (Urgent)", high: "High (Critical)" },
                    submitBtn: "Log Patient Entry",
                    success: "Patient entry logged successfully. The Receiving team has been notified.",
                    error: "Error saving patient. Check console for details (Mock DB is active if no Firebase connection).",
                },
                receiving: {
                    heading: "Incoming Patients (Awaiting Triage)",
                    loading: "Loading patients...",
                    empty: "No patients currently awaiting triage.",
                    receiveBtn: "Assign & Move to Station", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time in Receiving:", 
                    submitter: "Submitted by:",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                    // NEW STATION CHOICES
                    stationLabel: "Assign Station Location",
                    stationLocations: { 
                        icu: "ICU (Intensive Care Unit)", 
                        recovery: "Recovery Ward", 
                        discharge: "Discharge Prep Area" 
                    },
                },
                station: {
                    heading: "Active Patients (Assigned Station)",
                    loading: "Loading active patients...",
                    empty: "No patients currently assigned to a station.",
                    releaseBtn: "Release Patient / Archive", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time at Station:", 
                    submitter: "Triage/Assignment by:",
                    assigned: "Assigned Staff:",
                    currentStation: "Current Station:", // NEW
                    assignBtn: "Change Staff",
                    unassigned: "Unassigned",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                    updateVitalsBtn: "Update Vitals", // NEW
                },
                archive: {
                    heading: "Archived/Discharged Patients",
                    loading: "Loading archived records...",
                    empty: "No patients currently in the archive.",
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Archived:",
                    dischargedBy: "Discharged by:", 
                    dischargeDate: "Discharge Date:", 
                    submitter: "Triage/Assignment by:", 
                    cleared: "Archive cleared successfully.",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                },
                contact: {
                    heading: "Contact Us",
                    addressTitle: "Our Location",
                    detailsTitle: "General Inquiries",
                    formTitle: "Send a Message",
                    namePlaceholder: "Your Name",
                    emailPlaceholder: "Your Email",
                    messagePlaceholder: "Your Message",
                    submitBtn: "Send Message",
                },
                modal: { 
                    title: "Confirm Patient Discharge",
                    staffLabel: "Staff Name (Doctor/Nurse)",
                    dateLabel: "Discharge Date",
                    cancelBtn: "Cancel",
                    confirmBtn: "Confirm & Archive",
                    dischargeFailed: "Discharge failed. Please check the form and try again."
                },
                footer: {
                    rights: "All rights reserved."
                }
            },
            de: {
                title: "SAMS | Notfall Patientenfluss",
                slogan: "Echtzeit Klinische Aufnahme & Triage",
                userIdText: "Benutzer-ID:",
                nav: {
                    home: "Startseite",
                    patientEntry: "Patienteneingabe",
                    receiving: "Empfang",
                    station: "Stationsansicht",
                    archive: "Archiv",
                    contact: "Kontakt"
                },
                home: {
                    heading: "Willkommen beim SAMS Aufnahmesystem",
                    p1: "Diese Oberfläche dient der schnellen Patientenaufnahme und dem Triage-Management in der Notaufnahme. Bitte verwenden Sie den Reiter Patienteneingabe, um eintreffende Patienten sofort zu protokollieren.",
                    p2: "Der Empfangs-Reiter zeigt alle ausstehenden Patienten an, die auf eine klinische Zuweisung warten. Der Stations-Reiter verfolgt aktive Patienten, und das Archiv enthält entlassene Aufzeichnungen. Diese Listen werden in Echtzeit aktualisiert.",
                },
                patientEntry: {
                    heading: "Notfall Patientenschnelleingabe",
                    nameLabel: "Voller Name des Patienten",
                    dobLabel: "Geburtsdatum (Geb.)",
                    complaintLabel: "Hauptbeschwerde (Symptome/Verletzung)",
                    vitalsHeading: "Anfangsvitalwerte", 
                    bpmLabel: "BPM (Herzfrequenz)", 
                    bpLabel: "Blutdruck (Sys/Dia)", 
                    paramedicLabel: "Name des Notarztes/Teams", 
                    priorityLabel: "Triage-Priorität",
                    priorities: { low: "Niedrig (Geplant/Stabil)", medium: "Mittel (Dringend)", high: "Hoch (Kritisch)" },
                    submitBtn: "Patienteneintrag Protokollieren",
                    success: "Patienteneintrag erfolgreich protokolliert. Das Empfangsteam wurde benachrichtigt.",
                    error: "Fehler beim Speichern des Patienten. Überprüfen Sie die Konsole (Mock-Datenbank ist aktiv, wenn keine Firebase-Verbindung besteht).",
                },
                receiving: {
                    heading: "Eintreffende Patienten (Warten auf Triage)",
                    loading: "Patienten werden geladen...",
                    empty: "Derzeit warten keine Patienten auf die Triage.",
                    receiveBtn: "Zuweisen & Auf Station Verschieben", 
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit im Empfang:",
                    submitter: "Eingereicht von:",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                    // NEW STATION CHOICES
                    stationLabel: "Stationsort Zuweisen",
                    stationLocations: { 
                        icu: "ICU (Intensivstation)", 
                        recovery: "Aufwachraum", 
                        discharge: "Entlassungsvorbereitungsbereich" 
                    },
                },
                station: {
                    heading: "Aktive Patienten (Zugewiesene Station)",
                    loading: "Aktive Patienten werden geladen...",
                    empty: "Derzeit ist kein Patient einer Station zugewiesen.",
                    releaseBtn: "Patient Entlassen / Archiv",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit auf Station:",
                    submitter: "Triage/Zuweisung durch:",
                    assigned: "Zugewiesener Mitarbeiter:",
                    currentStation: "Aktuelle Station:", // NEW
                    assignBtn: "Mitarbeiter Wechseln",
                    unassigned: "Nicht Zugewiesen",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                    updateVitalsBtn: "Vitalwerte Aktualisieren", // NEW
                },
                archive: {
                    heading: "Archivierte/Entlassene Patienten",
                    loading: "Archivierte Aufzeichnungen werden geladen...",
                    empty: "Derzeit keine Patienten im Archiv.",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Archiviert:",
                    dischargedBy: "Entlassen durch:",
                    dischargeDate: "Entlassungsdatum:",
                    submitter: "Triage/Zuweisung durch:",
                    cleared: "Archiv erfolgreich gelöscht.",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                },
                contact: {
                    heading: "Kontaktieren Sie uns",
                    addressTitle: "Unser Standort",
                    detailsTitle: "Allgemeine Anfragen",
                    formTitle: "Nachricht senden",
                    namePlaceholder: "Ihr Name",
                    emailPlaceholder: "Ihre E-Mail",
                    messagePlaceholder: "Ihre Nachricht",
                    submitBtn: "Nachricht senden",
                },
                modal: { 
                    title: "Bestätigung der Patientenentlassung",
                    staffLabel: "Mitarbeitername (Arzt/Krankenschwester)",
                    dateLabel: "Entlassungsdatum",
                    cancelBtn: "Abbrechen",
                    confirmBtn: "Bestätigen & Archivieren",
                    dischargeFailed: "Entlassung fehlgeschlagen. Bitte überprüfen Sie das Formular und versuchen Sie es erneut."
                },
                footer: {
                    rights: "Alle Rechte vorbehalten."
                }
            }
        };

        // --- Core Application State & Logic ---
        
        const tabs = ['home', 'patientEntry', 'receiving', 'station', 'archive', 'contact'];
        
        // Load initial state from localStorage or use defaults
        const savedLang = localStorage.getItem('samsAppLanguage');
        const savedTab = localStorage.getItem('samsAppActiveTab');

        let currentState = {
            // Load language, default to 'en' if not found or invalid
            language: (savedLang && dictionary[savedLang]) ? savedLang : 'en', 
            // Load active tab, default to 'home' if not found or invalid
            activeTab: (savedTab && tabs.includes(savedTab)) ? savedTab : 'home'
        };
        
        // State for the modal
        let modalPatientId = null;

        /**
         * Initializes the Tone.js Synth for the bell alert.
         */
        function initializeAudio() {
            try {
                if (Tone) {
                    // Use a simple FM Synth to emulate a metallic bell sound
                    alertSynth = new Tone.FMSynth().toDestination();
                    console.log("Tone.js Audio initialized.");
                }
            } catch (e) {
                console.warn("Tone.js initialization failed, audio alerts will be disabled.", e);
                alertSynth = null;
            }
        }

        /**
         * Plays a short bell sound to alert of a new incoming patient.
         */
        function playNewPatientAlert() {
            if (alertSynth) {
                // Play a high, short note (like a small bell/chime)
                alertSynth.triggerAttackRelease("G5", "8n"); 
            }
        }

        // Utility to format date to YYYY-MM-DD
        const getTodayDateString = () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        // Utility to safely retrieve DOM elements
        const getEl = (id) => document.getElementById(id);

        /**
         * Converts Firestore Timestamp or JS Date to a standardized Date object.
         * Handles mock DB numbers and Firestore objects.
         */
        const toJsDate = (timestamp) => {
            if (!timestamp) return null;
            if (typeof timestamp === 'number') { // Mock DB timestamp (ms)
                return new Date(timestamp);
            }
            if (timestamp.toDate) { // Firestore Timestamp object
                return timestamp.toDate();
            }
            return new Date(timestamp); // Fallback for other Date-like strings/objects
        };

        /**
         * Formats time elapsed since a timestamp.
         * @param {object} timestamp - The Firestore Timestamp or mock timestamp.
         * @returns {string} Formatted elapsed time (e.g., 5m ago, 2h ago)
         */
        const formatTimeSince = (timestamp) => {
            const date = toJsDate(timestamp);
            if (!date) return '--';

            const now = Date.now();
            const seconds = Math.floor((now - date.getTime()) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            return Math.floor(seconds) + "s";
        };

        /**
         * Sets the active tab and saves it to localStorage.
         */
        window.setTab = (tab) => {
            if (currentState.activeTab !== tab) {
                currentState.activeTab = tab;
                localStorage.setItem('samsAppActiveTab', tab);
                render();
            }
        };

        /**
         * Toggles the application language.
         */
        window.toggleLanguage = () => {
            currentState.language = currentState.language === 'en' ? 'de' : 'en';
            localStorage.setItem('samsAppLanguage', currentState.language);
            render();
        };

        /**
         * Opens the discharge confirmation modal.
         */
        window.openModal = (patientId) => {
            modalPatientId = patientId;
            const patient = allPatients.find(p => p.id === patientId);
            const modal = getEl('discharge-modal');
            const content = dictionary[currentState.language].modal;

            if (patient && modal) {
                getEl('modal-patient-name').textContent = `${content.title}: ${patient.name}`;
                getEl('discharge-date').value = getTodayDateString();
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100');
            }
        };

        /**
         * Closes the discharge confirmation modal.
         */
        window.closeModal = () => {
            const modal = getEl('discharge-modal');
            if (modal) {
                modal.classList.add('opacity-0');
                modal.classList.remove('opacity-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalPatientId = null;
                }, 300); // Wait for transition
            }
        };

        /**
         * Renders the patient card HTML for a given patient and view.
         */
        const renderPatientCard = (patient, view) => {
            const content = dictionary[currentState.language];
            const priorityClass = {
                high: 'bg-red-100 text-red-800 border-red-500',
                medium: 'bg-yellow-100 text-yellow-800 border-yellow-500',
                low: 'bg-green-100 text-green-800 border-green-500'
            }[patient.priority] || 'bg-gray-100 text-gray-800 border-gray-500';

            // Patient card blinking logic removed as requested.
            
            const timeKey = view === 'station' ? 'timeAtStation' : 'timeAtEntry';
            const timeSince = patient[timeKey] ? formatTimeSince(patient[timeKey]) : '--';
            const timeLabel = view === 'archive' ? content.archive.time : (view === 'station' ? content.station.time : content.receiving.time);

            let actionButton = '';
            let assignedStaffInfo = '';
            let dischargeDetails = '';
            let vitalsDisplayAndUpdater = '';

            if (view === 'receiving') {
                // Staff assignment and Station selection dropdowns
                const staffOptions = mockStaff.map(staff => `<option value="${staff.name}" ${patient.assignedStaff === staff.name ? 'selected' : ''}>${staff.role}: ${staff.name}</option>`).join('');
                
                // NEW: Station Location Dropdown
                const stationOptions = Object.entries(content.receiving.stationLocations).map(([key, value]) => 
                    `<option value="${key}">${value}</option>`
                ).join('');

                actionButton = `
                    <div class="flex flex-col space-y-2">
                        <select id="staff-select-${patient.id}" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm font-medium">
                            <option value="" disabled selected>${content.station.assignBtn}</option>
                            ${staffOptions}
                        </select>
                        
                        <select id="station-select-${patient.id}" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm font-medium">
                            <option value="" disabled selected>${content.receiving.stationLabel}</option>
                            ${stationOptions}
                        </select>

                        <button onclick="window.moveToStation('${patient.id}', document.getElementById('staff-select-${patient.id}').value, document.getElementById('station-select-${patient.id}').value)" 
                                class="w-full bg-red-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-red-700 transition duration-200 text-sm flex items-center justify-center">
                            <span data-lucide="chevrons-right" class="w-4 h-4 mr-2"></span>
                            ${content.receiving.receiveBtn}
                        </button>
                    </div>
                `;
            } else if (view === 'station') {
                // Assigned staff info, Current Station, and Discharge button for station
                const staffOptions = mockStaff.map(staff => `<option value="${staff.name}" ${patient.assignedStaff === staff.name ? 'selected' : ''}>${staff.role}: ${staff.name}</option>`).join('');
                
                assignedStaffInfo = `
                    <p class="text-sm mb-1">
                        <span class="font-semibold">${content.station.currentStation}</span>
                        <span class="text-indigo-700 font-medium">${content.receiving.stationLocations[patient.stationLocation] || 'N/A'}</span>
                    </p>
                    <p class="text-sm">
                        <span class="font-semibold">${content.station.assigned}</span>
                        <span class="text-blue-700 font-medium">${patient.assignedStaff || content.station.unassigned}</span>
                        <select id="staff-select-${patient.id}" class="w-full mt-1 p-2 border border-gray-300 rounded-lg bg-white text-xs font-medium" onchange="window.updateStaffAssignment('${patient.id}', this.value)">
                            <option value="" disabled selected>${content.station.assignBtn}</option>
                            ${staffOptions}
                        </select>
                    </p>
                `;
                
                actionButton = `
                    <button onclick="window.openModal('${patient.id}')" class="w-full bg-blue-600 text-white font-medium py-2 px-3 rounded-lg hover:bg-blue-700 transition duration-200 text-sm flex items-center justify-center">
                        <span data-lucide="archive" class="w-4 h-4 mr-2"></span>
                        ${content.station.releaseBtn}
                    </button>
                `;
            } else if (view === 'archive') {
                // Discharge details for archive
                dischargeDetails = `
                    <p class="text-sm">
                        <span class="font-semibold">${content.archive.dischargedBy}</span>
                        <span class="text-gray-700">${patient.dischargedBy || 'N/A'}</span>
                    </p>
                    <p class="text-sm">
                        <span class="font-semibold">${content.archive.dischargeDate}</span>
                        <span class="text-gray-700">${patient.dischargeDate || 'N/A'}</span>
                    </p>
                `;
            }

            // --- Vitals Display and Updater ---
            vitalsDisplayAndUpdater = `
                <div class="space-y-1">
                    <p class="text-sm font-semibold text-gray-800 mb-1">${content.receiving.vitals}</p>
                    <p class="text-xs text-red-600 font-medium">BPM: <span id="bpm-val-${patient.id}">${patient.bpm || 'N/A'}</span></p>
                    <p class="text-xs text-red-600 font-medium">BP: <span id="bp-val-${patient.id}">${patient.bp || 'N/A'}</span></p>
            `;
            
            if (view === 'station') {
                vitalsDisplayAndUpdater += `
                    <button id="vitals-btn-${patient.id}" onclick="document.getElementById('vitals-form-${patient.id}').classList.toggle('hidden')" 
                            class="mt-2 w-full text-xs bg-red-100 text-red-700 font-medium py-1 px-2 rounded-lg hover:bg-red-200 transition duration-200 flex items-center justify-center">
                        <span data-lucide="activity" class="w-3 h-3 mr-1"></span>
                        ${content.station.updateVitalsBtn}
                    </button>
                    
                    <!-- Inline Vitals Update Form (hidden by default) -->
                    <form id="vitals-form-${patient.id}" class="hidden space-y-2 mt-3 p-3 bg-gray-50 rounded-lg" onsubmit="event.preventDefault(); window.updatePatientVitals('${patient.id}', document.getElementById('new-bpm-${patient.id}').value, document.getElementById('new-bp-${patient.id}').value)">
                        <input type="number" id="new-bpm-${patient.id}" placeholder="New BPM" class="w-full p-1 text-xs border border-gray-300 rounded">
                        <input type="text" id="new-bp-${patient.id}" placeholder="New BP (e.g., 120/80)" class="w-full p-1 text-xs border border-gray-300 rounded">
                        <button type="submit" class="w-full bg-red-600 text-white text-xs font-medium py-1 rounded hover:bg-red-700">Save Vitals</button>
                    </form>
                `;
            }
            vitalsDisplayAndUpdater += `</div>`;
            // --- End Vitals Display and Updater ---

            return `
                <div id="patient-card-${patient.id}" class="bg-white p-4 sm:p-6 rounded-xl shadow-md border-l-4 ${priorityClass}">
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="text-xl font-bold text-gray-900">${patient.name} (${new Date().getFullYear() - new Date(patient.dob).getFullYear()})</h3>
                        <span class="text-xs font-semibold px-3 py-1 rounded-full ${priorityClass}">${content.patientEntry.priorities[patient.priority]}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-3 border-gray-100">
                        <!-- Details Column 1 -->
                        <div class="space-y-1">
                            <p class="text-sm">
                                <span class="font-semibold">${content.receiving.complaint}</span>
                                <span class="text-gray-700 block">${patient.complaint}</span>
                            </p>
                            <p class="text-sm">
                                <span class="font-semibold">${content.receiving.paramedic}</span>
                                <span class="text-gray-700 block">${patient.paramedic}</span>
                            </p>
                            ${assignedStaffInfo}
                            ${dischargeDetails}
                        </div>
                        
                        <!-- Details Column 2 (Vitals & Update) -->
                        ${vitalsDisplayAndUpdater}

                        <!-- Status/Time/Action Column 3 -->
                        <div class="space-y-3 flex flex-col justify-between">
                            <div class="space-y-1">
                                <p class="text-xs">
                                    <span class="font-semibold">${timeLabel}</span>
                                    <span id="timer-${patient.id}" class="text-gray-700 font-mono block">${timeSince}</span>
                                </p>
                                <p class="text-xs">
                                    <span class="font-semibold">${content.receiving.submitter}</span>
                                    <span class="text-gray-700 block">${patient.submittedBy}</span>
                                </p>
                            </div>
                            ${actionButton}
                        </div>
                    </div>
                </div>
            `;
        };

        /**
         * Renders the UI elements based on the current state (language and activeTab).
         */
        function render() {
            const lang = currentState.language;
            const content = dictionary[lang];
            const activeTab = currentState.activeTab;

            // 1. Update Global Text Elements
            document.title = content.title;
            getEl('header-slogan').textContent = content.slogan;
            getEl('page-title').textContent = content.title.split(' | ')[0];
            getEl('current-lang-text').textContent = lang.toUpperCase();
            getEl('user-id-text').textContent = content.userIdText;
            
            // Update User ID Display
            const userIdDisplay = getEl('user-id-display');
            if(userIdDisplay) {
                userIdDisplay.textContent = userId || (useMockDb ? 'MOCK-USER' : 'Loading...');
            }

            // 2. Determine if Receiving Tab needs to blink (unreceived patients exist)
            const shouldBlink = activeTab !== 'receiving' && receivingPatients.length > 0;

            // 3. Render Navigation Tabs
            const tabNav = getEl('tab-nav');
            tabNav.innerHTML = tabs.map(tab => {
                const isActive = tab === activeTab;
                let baseClasses = "tab-btn px-3 py-2 sm:px-4 sm:py-2 text-sm font-medium rounded-lg transition duration-200 cursor-pointer whitespace-nowrap";
                let activeClasses = "bg-blue-600 text-white shadow-lg";
                let inactiveClasses = "text-gray-700 hover:bg-gray-100";
                
                // Add blinking class if conditions met (Only the tab button blinks now)
                if (tab === 'receiving' && shouldBlink) {
                    baseClasses += ' blinking-red';
                    inactiveClasses = "text-red-800 hover:bg-red-100";
                }

                return `
                    <button id="btn-${tab}" data-tab="${tab}" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}" onclick="window.setTab('${tab}')">
                        ${content.nav[tab]}
                    </button>
                `;
            }).join('');

            // 4. Update Content Sections and Visibility
            tabs.forEach(tab => {
                const tabEl = getEl(`tab-${tab}`);
                if (tabEl) {
                    tabEl.classList.toggle('hidden', tab !== activeTab);
                }
            });

            // Home Tab Content
            getEl('home-heading').textContent = content.home.heading;
            getEl('home-paragraph-1').textContent = content.home.p1;
            getEl('home-paragraph-2').textContent = content.home.p2;

            // Patient Entry Tab Content (Update labels and options)
            getEl('patientEntry-heading').innerHTML = `<span data-lucide="user-plus" class="w-6 h-6 mr-2 text-green-600"></span>${content.patientEntry.heading}`;
            getEl('p-name-label').textContent = content.patientEntry.nameLabel;
            getEl('p-dob-label').textContent = content.patientEntry.dobLabel;
            getEl('p-complaint-label').textContent = content.patientEntry.complaintLabel;
            
            // NEW VITALS LABELS
            getEl('vitals-heading').innerHTML = `<span data-lucide="heart-pulse" class="w-5 h-5 mr-2 text-red-500"></span>${content.patientEntry.vitalsHeading}`;
            getEl('p-bpm-label').textContent = content.patientEntry.bpmLabel;
            getEl('p-bp-label').textContent = content.patientEntry.bpLabel;
            // NEW PARAMEDIC LABEL
            getEl('p-paramedic-label').textContent = content.patientEntry.paramedicLabel;

            getEl('p-priority-label').textContent = content.patientEntry.priorityLabel;
            getEl('patientEntry-submit-btn').textContent = content.patientEntry.submitBtn;

            const prioritySelect = getEl('p-priority');
            if (prioritySelect) {
                // Keep the current selection if one exists, otherwise rebuild
                const currentPriority = prioritySelect.value;
                prioritySelect.innerHTML = Object.entries(content.patientEntry.priorities).map(([key, value]) => 
                    `<option value="${key}" ${key === currentPriority ? 'selected' : ''}>${value}</option>`
                ).join('');
            }
            // Set initial date for DOB to something sensible (e.g., 20 years ago)
            const dobInput = getEl('p-dob');
            if (dobInput && dobInput.value === '') {
                const twentyYearsAgo = new Date();
                twentyYearsAgo.setFullYear(twentyYearsAgo.getFullYear() - 20);
                const yyyy = twentyYearsAgo.getFullYear();
                const mm = String(twentyYearsAgo.getMonth() + 1).padStart(2, '0');
                const dd = String(twentyYearsAgo.getDate()).padStart(2, '0');
                dobInput.value = `${yyyy}-${mm}-${dd}`;
            }

            // Receiving Tab Content
            getEl('receiving-heading').innerHTML = `<span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-red-600"></span>${content.receiving.heading} (${receivingPatients.length})`;
            const receivingListContainer = getEl('receiving-list-container');
            if (receivingPatients.length === 0) {
                receivingListContainer.innerHTML = `<p class="text-gray-500 italic text-center py-6">${content.receiving.empty}</p>`;
            } else {
                receivingListContainer.innerHTML = receivingPatients.map(p => renderPatientCard(p, 'receiving')).join('');
            }

            // Station Tab Content
            getEl('station-heading').innerHTML = `<span data-lucide="hospital" class="w-6 h-6 mr-2 text-blue-600"></span>${content.station.heading} (${stationPatients.length})`;
            const stationListContainer = getEl('station-list-container');
            if (stationPatients.length === 0) {
                stationListContainer.innerHTML = `<p class="text-gray-500 italic text-center py-6">${content.station.empty}</p>`;
            } else {
                stationListContainer.innerHTML = stationPatients.map(p => renderPatientCard(p, 'station')).join('');
            }

            // Archive Tab Content
            getEl('archive-heading').innerHTML = `<span data-lucide="archive" class="w-6 h-6 mr-2 text-gray-600"></span>${content.archive.heading} (${archivedPatients.length})`;
            const archiveListContainer = getEl('archive-list-container');
            if (archivedPatients.length === 0) {
                archiveListContainer.innerHTML = `<p class="text-gray-500 italic text-center py-6">${content.archive.empty}</p>`;
            } else {
                archiveListContainer.innerHTML = archivedPatients.map(p => renderPatientCard(p, 'archive')).join('');
            }

            // Contact Tab Content
            getEl('contact-heading').innerHTML = `<span data-lucide="mail" class="w-6 h-6 mr-2 text-gray-600"></span>${content.contact.heading}`;
            getEl('contact-address-title').textContent = content.contact.addressTitle;
            getEl('contact-details-title').textContent = content.contact.detailsTitle;
            getEl('contact-form-title').textContent = content.contact.formTitle;
            getEl('contact-name-placeholder').placeholder = content.contact.namePlaceholder;
            getEl('contact-email-placeholder').placeholder = content.contact.emailPlaceholder;
            getEl('contact-message-placeholder').placeholder = content.contact.messagePlaceholder;
            getEl('contact-submit-btn').textContent = content.contact.submitBtn;

            // Modal Content
            getEl('modal-title').innerHTML = `<span data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></span>${content.modal.title}`;
            getEl('modal-staff-label').textContent = content.modal.staffLabel;
            getEl('modal-date-label').textContent = content.modal.dateLabel;
            getEl('modal-cancel-btn').textContent = content.modal.cancelBtn;
            getEl('modal-confirm-btn').textContent = content.modal.confirmBtn;

            // Footer
            getEl('footer-year').textContent = new Date().getFullYear();
            getEl('footer-rights').textContent = content.footer.rights;

            // Rerender Lucide icons (needed for dynamically injected content)
            lucide.createIcons();
        }

        /**
         * Tracks the previous count of receiving patients to trigger the audio alert.
         */
        let previousReceivingCount = 0;

        /**
         * Real-time listener for patient data.
         * Updates the global patient lists and triggers a UI render.
         */
        function setupPatientListener() {
            if (!isAuthReady) {
                console.warn("Auth not ready. Skipping Firestore listener setup.");
                return;
            }

            if (useMockDb) {
                // Initial mock data setup
                if (mockPatients.length === 0) {
                    mockPatients = [
                        { id: 'm1', name: 'John Doe', dob: '1985-01-15', complaint: 'Severe chest pain', paramedic: 'EMT Alpha', priority: 'high', bpm: '110', bp: '140/90', status: 'receiving', timeAtEntry: Date.now() - 300000, submittedBy: 'MOCK-USER', timeAtStation: null, assignedStaff: null, stationLocation: null }, // 5 min ago
                        { id: 'm2', name: 'Jane Smith', dob: '1992-11-20', complaint: 'Broken arm from fall', paramedic: 'Team 3', priority: 'medium', bpm: '85', bp: '120/80', status: 'station', timeAtEntry: Date.now() - 900000, submittedBy: 'MOCK-USER', timeAtStation: Date.now() - 300000, assignedStaff: 'Dr. Emily Carter', stationLocation: 'recovery' }, // 15 min ago, 5 min at station
                        { id: 'm3', name: 'Sam Wilson', dob: '1950-05-01', complaint: 'Routine checkup/stable', paramedic: 'Self-Check-In', priority: 'low', bpm: '70', bp: '110/70', status: 'archive', timeAtEntry: Date.now() - 3600000, submittedBy: 'MOCK-USER', timeAtStation: Date.now() - 1800000, assignedStaff: 'Dr. Ben Jones', dischargedBy: 'Dr. Ben Jones', dischargeDate: getTodayDateString(), stationLocation: 'discharge' },
                    ];
                }
                updatePatientLists(mockPatients);
                return;
            }

            // Firestore Setup (Public data for collaboration)
            if (!db) {
                console.error("Firestore DB instance is null. Cannot set up listener.");
                return;
            }
            
            const publicPatientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
            
            // Set up real-time listener
            onSnapshot(publicPatientsRef, (snapshot) => {
                const patients = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updatePatientLists(patients);
            }, (error) => {
                console.error("Error listening to patients collection: ", error);
                // Fallback to mock data if Firestore connection fails after auth success
                if (!useMockDb) {
                    console.log("Falling back to mock database.");
                    useMockDb = true;
                    // Re-run listener setup which will now hit the mock DB path
                    setupPatientListener(); 
                }
            });
        }

        /**
         * Updates the derived patient lists and triggers a UI render.
         */
        function updatePatientLists(patients) {
            allPatients = patients;
            const newReceivingPatients = patients
                .filter(p => p.status === 'receiving')
                .sort((a, b) => (toJsDate(a.timeAtEntry) - toJsDate(b.timeAtEntry))); // Oldest first
            
            // --- NEW: Audio Alert Logic ---
            // If the number of receiving patients has increased AND we are not on the receiving tab, play the alert.
            if (newReceivingPatients.length > previousReceivingCount && currentState.activeTab !== 'receiving') {
                playNewPatientAlert();
            }
            previousReceivingCount = newReceivingPatients.length;
            // --- End Audio Alert Logic ---

            receivingPatients = newReceivingPatients;

            stationPatients = patients
                .filter(p => p.status === 'station')
                .sort((a, b) => (toJsDate(a.timeAtStation) - toJsDate(b.timeAtStation))); // Oldest first
            archivedPatients = patients
                .filter(p => p.status === 'archive')
                .sort((a, b) => (toJsDate(b.timeAtDischarge) - toJsDate(a.timeAtDischarge) || toJsDate(b.timeAtEntry) - toJsDate(a.timeAtEntry))); // Newest first

            render();
        }

        /**
         * Handles the patient entry form submission.
         */
        async function handlePatientEntry(event) {
            event.preventDefault();
            const form = getEl('patient-entry-form');
            const messageBox = getEl('patient-message-box');
            messageBox.classList.add('hidden');
            
            if (!isAuthReady) {
                console.error("App not ready for DB operations.");
                messageBox.textContent = dictionary[currentState.language].patientEntry.error;
                messageBox.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700 block';
                return;
            }


            const name = getEl('p-name').value.trim();
            const dob = getEl('p-dob').value;
            const complaint = getEl('p-complaint').value.trim();
            const paramedic = getEl('p-paramedic').value.trim();
            const priority = getEl('p-priority').value;
            const bpm = getEl('p-bpm').value.trim(); 
            const bp = getEl('p-bp').value.trim(); 

            if (!name || !dob || !complaint || !paramedic || !priority) {
                console.error("Missing required fields.");
                return;
            }

            const newPatient = {
                name: name,
                dob: dob,
                complaint: complaint,
                paramedic: paramedic,
                priority: priority,
                bpm: bpm, 
                bp: bp, 
                status: 'receiving', // Always start at receiving
                timeAtEntry: useMockDb ? Date.now() : serverTimestamp(), // Use serverTimestamp for Firebase
                timeAtStation: null, // Initially null
                assignedStaff: null, // Initially null
                stationLocation: null, // NEW: Initially null
                submittedBy: userId,
            };

            try {
                if (useMockDb) {
                    newPatient.id = 'm' + (mockPatients.length + 1);
                    mockPatients.push(newPatient);
                    updatePatientLists(mockPatients);
                } else {
                    const publicPatientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'patients');
                    await addDoc(publicPatientsRef, newPatient);
                }

                form.reset();
                messageBox.textContent = dictionary[currentState.language].patientEntry.success;
                messageBox.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-700 block';
                window.setTab('receiving'); // Auto-switch to receiving view
            } catch (e) {
                console.error("Error adding document: ", e);
                messageBox.textContent = dictionary[currentState.language].patientEntry.error;
                messageBox.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-700 block';
            }
        }

        /**
         * Moves patient from 'receiving' to 'station' with staff and location assignment.
         */
        window.moveToStation = async (patientId, staffName, stationLocation) => {
            if (!staffName || staffName === '' || !stationLocation || stationLocation === '') {
                console.warn("Please select a staff member AND a station location before moving to station.");
                return;
            }
            if (!isAuthReady) { console.error("App not ready for DB operations."); return; }


            const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientId);
            const updateData = {
                status: 'station',
                assignedStaff: staffName,
                stationLocation: stationLocation, // NEW: Assign location
                timeAtStation: useMockDb ? Date.now() : serverTimestamp()
            };

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        updatePatientLists(mockPatients);
                    }
                } else {
                    await updateDoc(patientRef, updateData);
                }
                console.log(`Patient ${patientId} assigned to ${staffName} at ${stationLocation} and moved to Station.`);
                window.setTab('station');
            } catch (e) {
                console.error("Error moving patient to station: ", e);
            }
        };

        /**
         * Updates staff assignment for a patient already in 'station'.
         */
        window.updateStaffAssignment = async (patientId, staffName) => {
            if (!staffName || staffName === '') {
                console.warn("Please select a staff member for assignment update.");
                return;
            }
            if (!isAuthReady) { console.error("App not ready for DB operations."); return; }


            const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientId);
            const updateData = {
                assignedStaff: staffName,
            };

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        updatePatientLists(mockPatients);
                    }
                } else {
                    await updateDoc(patientRef, updateData);
                }
                console.log(`Patient ${patientId} staff updated to ${staffName}.`);
            } catch (e) {
                console.error("Error updating staff assignment: ", e);
            }
        };

        /**
         * Updates Vitals for a patient already in 'station'.
         */
        window.updatePatientVitals = async (patientId, newBpm, newBp) => {
            if ((!newBpm || newBpm.trim() === '') && (!newBp || newBp.trim() === '')) {
                console.warn("Vitals fields cannot be empty.");
                return;
            }
            if (!isAuthReady) { console.error("App not ready for DB operations."); return; }

            const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', patientId);
            const updateData = {};

            if (newBpm && newBpm.trim() !== '') updateData.bpm = newBpm.trim();
            if (newBp && newBp.trim() !== '') updateData.bp = newBp.trim();
            
            // Close the form
            getEl(`vitals-form-${patientId}`).classList.add('hidden');

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        updatePatientLists(mockPatients);
                    }
                } else {
                    await updateDoc(patientRef, updateData);
                }
                console.log(`Patient ${patientId} vitals updated.`);
            } catch (e) {
                console.error("Error updating patient vitals: ", e);
            }
        };


        /**
         * Discharges and archives a patient.
         */
        async function handleDischarge(event) {
            event.preventDefault();
            
            if (!isAuthReady) { console.error("App not ready for DB operations."); return; }

            const staffName = getEl('discharge-staff-name').value.trim();
            const dischargeDate = getEl('discharge-date').value;

            if (!modalPatientId || !staffName || !dischargeDate) {
                console.error("Missing discharge details.");
                return;
            }

            const patientRef = doc(db, 'artifacts', appId, 'public', 'data', 'patients', modalPatientId);
            const updateData = {
                status: 'archive',
                dischargedBy: staffName,
                dischargeDate: dischargeDate,
                timeAtDischarge: useMockDb ? Date.now() : serverTimestamp(),
            };

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === modalPatientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        updatePatientLists(mockPatients);
                    }
                } else {
                    await updateDoc(patientRef, updateData);
                }
                console.log(`Patient ${modalPatientId} archived.`);
                window.closeModal();
                window.setTab('archive');
            } catch (e) {
                console.error("Error archiving patient: ", e);
                // Show message box error if possible, but for simplicity, console log here
            }
        }

        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeFirebase() {
            if (firebaseConfig) {
                try {
                    // Initialize app and services
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Sign in with custom token or anonymously
                    const user = auth.currentUser;
                    if (!user) {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }

                    // Set up Auth State Change Listener
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            isAuthReady = true;
                            console.log(`Authenticated. User ID: ${userId}`);
                            setupPatientListener(); // Start data listener ONLY after auth is confirmed
                            startUpdateTimer();
                        } else {
                            // Should not happen if token is provided, but handle anonymous fallback
                            userId = crypto.randomUUID();
                            isAuthReady = true;
                            console.log("Signed in anonymously. Using random UUID.");
                            setupPatientListener();
                            startUpdateTimer();
                        }
                        render(); // Initial render to show user ID
                    });

                } catch (e) {
                    console.error("Firebase initialization failed. Falling back to Mock DB.", e);
                    // Critical failure, use mock DB
                    useMockDb = true;
                    isAuthReady = true;
                    userId = 'MOCK-USER';
                    setupPatientListener();
                    startUpdateTimer();
                    render(); // Initial render for mock DB
                }
            } else {
                console.error("Firebase config not available. Using Mock DB.");
                // Critical failure, use mock DB
                useMockDb = true;
                isAuthReady = true;
                userId = 'MOCK-USER';
                setupPatientListener();
                startUpdateTimer();
                render(); // Initial render for mock DB
            }
        }

        /**
         * Starts the interval to refresh timers every second.
         */
        function startUpdateTimer() {
            // Clear any existing interval
            if (updateTimerInterval) clearInterval(updateTimerInterval);

            updateTimerInterval = setInterval(() => {
                // Only update the timers in the active view
                let patientsToUpdate = [];
                if (currentState.activeTab === 'receiving') {
                    patientsToUpdate = receivingPatients;
                } else if (currentState.activeTab === 'station') {
                    patientsToUpdate = stationPatients;
                }

                patientsToUpdate.forEach(patient => {
                    const timerEl = getEl(`timer-${patient.id}`);
                    if (timerEl) {
                        const timeKey = currentState.activeTab === 'station' ? 'timeAtStation' : 'timeAtEntry';
                        timerEl.textContent = formatTimeSince(patient[timeKey]);
                    }
                });
                
                // Also check if the 'receiving' tab button needs to blink
                const receivingBtn = getEl('btn-receiving');
                if (receivingBtn && currentState.activeTab !== 'receiving') {
                    const shouldBlink = receivingPatients.length > 0;
                    receivingBtn.classList.toggle('blinking-red', shouldBlink);
                }

            }, 1000); // Update every second
        }


        // --- Event Listeners and Initialization ---

        window.onload = () => {
            initializeAudio(); // Initialize audio before Firebase
            initializeFirebase();
            render(); // Initial render before data loads

            getEl('language-toggle')?.addEventListener('click', window.toggleLanguage);
            getEl('patient-entry-form')?.addEventListener('submit', handlePatientEntry);
            getEl('discharge-form')?.addEventListener('submit', handleDischarge);
        };
        
        // Expose functions to global window scope for inline HTML handlers
        window.setTab = window.setTab;
        window.toggleLanguage = window.toggleLanguage;
        window.openModal = window.openModal;
        window.closeModal = window.closeModal;
        // Updated and new exposed functions
        window.moveToStation = window.moveToStation;
        window.updateStaffAssignment = window.updateStaffAssignment;
        window.updatePatientVitals = window.updatePatientVitals;

    </script>
    <style>
        /* Custom font import for a professional look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .main-container {
            min-height: calc(100vh - 80px); /* Account for header */
        }
        /* Custom focus state for accessibility */
        .tab-btn:focus, .lang-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); /* Blue ring */
        }
        /* CSS for the blinking effect (ONLY APPLIES TO THE TAB BUTTON) */
        .blinking-red {
            animation: blink-animation 1s steps(5, start) infinite;
            background-color: #fee2e2 !important; /* Red-100 */
            color: #991b1b !important; /* Red-800 */
            border-color: #f87171 !important; /* Red-400 */
        }
        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Brand -->
            <div class="flex items-center space-x-2">
                <div class="text-2xl font-extrabold text-blue-600">SAMS</div>
                <div id="header-slogan" class="text-sm text-gray-500 hidden sm:block"></div>
            </div>

            <div class="flex items-center space-x-4">
                <!-- User ID Display (Important for multi-user context) -->
                <div class="text-xs text-gray-500">
                    <span id="user-id-text">User ID:</span> <span id="user-id-display" class="font-mono text-gray-700">Loading...</span>
                </div>
                <!-- Language Toggle -->
                <button id="language-toggle" class="lang-btn flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-3 rounded-lg transition duration-200 text-sm">
                    <span id="current-lang-text">EN</span>
                    <span data-lucide="globe" class="w-4 h-4 ml-2"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Title -->
        <h1 id="page-title" class="text-3xl sm:text-4xl font-bold text-blue-800 mb-6 text-center"></h1>
        
        <!-- Tab Navigation (Desktop and Mobile) -->
        <div class="bg-white p-2 rounded-xl shadow-lg mb-8 overflow-x-auto">
            <nav id="tab-nav" class="flex space-x-1 sm:space-x-2 justify-center">
                <!-- Tab buttons will be inserted here by JavaScript -->
            </nav>
        </div>

        <!-- Dynamic Content Section -->
        <div id="content-container" class="space-y-8">
            
            <!-- Home/Start Content -->
            <div id="tab-home" class="tab-content bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-blue-600">
                <h2 id="home-heading" class="text-2xl font-semibold text-gray-900 mb-4"></h2>
                <p id="home-paragraph-1" class="text-gray-600 mb-4 leading-relaxed"></p>
                <p id="home-paragraph-2" class="text-gray-600 leading-relaxed"></p>
            </div>

            <!-- Patient Entry / Patienteneingabe Content -->
            <div id="tab-patientEntry" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-green-600">
                <h2 id="patientEntry-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="user-plus" class="w-6 h-6 mr-2 text-green-600"></span>
                </h2>
                
                <form id="patient-entry-form" class="space-y-4 max-w-lg mx-auto">
                    <!-- Patient Details -->
                    <div>
                        <label for="p-name" id="p-name-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <input type="text" id="p-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="p-dob" id="p-dob-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <input type="date" id="p-dob" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="p-complaint" id="p-complaint-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <textarea id="p-complaint" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>

                    <!-- Vitals Section (New) -->
                    <div class="pt-4 border-t border-gray-200">
                        <h3 id="vitals-heading" class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <span data-lucide="heart-pulse" class="w-5 h-5 mr-2 text-red-500"></span>
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="p-bpm" id="p-bpm-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                                <input type="number" id="p-bpm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="e.g. 85">
                            </div>
                            <div>
                                <label for="p-bp" id="p-bp-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                                <input type="text" id="p-bp" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="e.g. 120/80">
                            </div>
                        </div>
                    </div>

                    <!-- Paramedic & Priority Section -->
                    <div class="pt-4 border-t border-gray-200 space-y-4">
                        <div>
                            <label for="p-paramedic" id="p-paramedic-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                            <input type="text" id="p-paramedic" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="e.g. EMT Smith / Ambulance Team 4">
                        </div>
                        <div>
                            <label for="p-priority" id="p-priority-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                            <select id="p-priority" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                                <!-- Options populated by JS render function -->
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="patientEntry-submit-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-md"></button>
                    <div id="patient-message-box" class="mt-4 p-3 rounded-lg text-center hidden" role="alert"></div>
                </form>
            </div>

            <!-- Receiving / Empfang Content -->
            <div id="tab-receiving" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-red-600">
                <h2 id="receiving-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-red-600"></span>
                </h2>
                <div id="receiving-list-container" class="space-y-4">
                    <!-- Patient cards/loading/empty states will be rendered here by JS -->
                </div>
            </div>

            <!-- Station / Station Content -->
            <div id="tab-station" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-blue-600">
                <h2 id="station-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="hospital" class="w-6 h-6 mr-2 text-blue-600"></span>
                </h2>
                <div id="station-list-container" class="space-y-4">
                    <!-- Patient cards will be rendered here -->
                </div>
            </div>

            <!-- Archive / Archiv Content -->
            <div id="tab-archive" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-gray-400">
                <h2 id="archive-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="archive" class="w-6 h-6 mr-2 text-gray-600"></span>
                </h2>
                <div id="archive-list-container" class="space-y-4">
                    <!-- Patient cards will be rendered here -->
                </div>
            </div>

            <!-- Contact / Kontakt Content -->
            <div id="tab-contact" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-gray-600">
                <h2 id="contact-heading" class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <span data-lucide="mail" class="w-6 h-6 mr-2 text-gray-600"></span>
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 id="contact-address-title" class="font-bold text-lg text-gray-700 mb-2"></h3>
                        <p class="text-gray-600">
                            San Andres Medical Service (SAMS)<br>
                            123 Health Ave, San Andres City<br>
                            CA 90210, Country<br>
                        </p>
                    </div>
                    <div>
                        <h3 id="contact-details-title" class="font-bold text-lg text-gray-700 mb-2"></h3>
                        <p id="contact-phone" class="text-gray-600 mb-1">Phone: +1 555-SAMS-HELP</p>
                        <p id="contact-email" class="text-gray-600">Email: info@sams.com</p>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 id="contact-form-title" class="font-bold text-lg text-gray-700 mb-4"></h3>
                    <form>
                        <input id="contact-name-placeholder" type="text" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input id="contact-email-placeholder" type="email" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <textarea id="contact-message-placeholder" rows="4" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button id="contact-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-10 p-4">
        <div class="max-w-7xl mx-auto text-center text-sm">
            &copy; <span id="footer-year"></span> San Andres Medical Service (SAMS). <span id="footer-rights"></span>
        </div>
    </footer>

    <!-- Discharge Confirmation Modal -->
    <div id="discharge-modal" class="modal-backdrop hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <h3 id="modal-title" class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                <span data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></span>
            </h3>
            <p id="modal-patient-name" class="text-lg text-gray-700 mb-4"></p>
            
            <form id="discharge-form" class="space-y-4">
                <div>
                    <label for="discharge-staff-name" id="modal-staff-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="text" id="discharge-staff-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Dr. John Doe">
                </div>
                <div>
                    <label for="discharge-date" id="modal-date-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="date" id="discharge-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="window.closeModal()" id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-200"></button>
                    <button type="submit" id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Discharge Confirmation Modal -->

</body>
</html>
