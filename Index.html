<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">SAMS | Emergency Patient Flow</title>
    <!-- Load Firebase/Tailwind/Icons/Tone.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>

    <style>
        /* Custom CSS for a clean look and responsive layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .blinking-red {
            animation: blinker 1s cubic-bezier(.5, 0, 1, 1) infinite alternate;
        }
        @keyframes blinker {
            from { opacity: 1; box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
            to { opacity: 0.8; box-shadow: 0 0 15px rgba(255, 0, 0, 0.8); }
        }
        /* Style for the fixed header/nav */
        .header-fixed {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e0e0e0; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Ensure smooth transition for modals */
        .modal-overlay {
            transition: opacity 0.3s ease-out;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');
       
        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Instances (Initialized inside initializeFirebase)
        let app, db, auth, userId = null;
        let isAuthReady = false; // Flag to ensure DB operations only run after auth/mock is ready
        let useMockDb = false; // Flag for mock data mode
        let dbStatus = 'CONNECTING...'; // New status indicator
       
        // All patients loaded from DB/Mock DB
        let allPatients = []; 
        // Derived lists for UI
        let receivingPatients = []; 
        let stationPatients = [];
        let archivedPatients = [];
        let mockPatients = []; // Mock database for when Firebase is unavailable
        let updateTimerInterval; // Interval for real-time timer updates

        // Tone.js Synth for the Bell Alert
        let alertSynth = null; 
        let isAudioEnabled = false; // Flag to track if audio context is running
       
        // Mock Staff for assignment feature
        const mockStaff = [
            { id: 'DR101', name: 'Dr. Emily Carter', role: 'Doctor' },
            { id: 'DR102', name: 'Dr. Ben Jones', role: 'Doctor' },
            { id: 'NR201', name: 'Nurse Lisa Kim', role: 'Nurse' },
            { id: 'NR202', name: 'Nurse David Chen', role: 'Nurse' },
        ];
       
        const initialMockPatients = [
            { id: 'mock1', name: 'John Doe', dob: '1985-04-12', complaint: 'Severe headache, blurred vision', bpm: '95', bp: '130/85', paramedicTeam: 'Ambulance 1', priority: 'high', timeAtEntry: Date.now() - 3600000, status: 'receiving', submittedBy: 'System Mock' },
            { id: 'mock2', name: 'Jane Smith', dob: '1999-11-20', complaint: 'Ankle fracture (sports injury)', bpm: '80', bp: '110/70', paramedicTeam: 'Walk-in', priority: 'medium', timeAtEntry: Date.now() - 1200000, status: 'receiving', submittedBy: 'System Mock' },
            { id: 'mock3', name: 'Robert Brown', dob: '1965-01-01', complaint: 'Chest pain, shortness of breath', bpm: '110', bp: '145/95', paramedicTeam: 'Ambulance 3', priority: 'high', timeAtEntry: Date.now() - 60000, status: 'station', submittedBy: 'System Mock', stationLocation: 'icu', assignedStaff: 'Dr. Emily Carter', timeAtStation: Date.now() - 60000 },
        ];

        // Dictionary for multilingual content
        const dictionary = {
            en: {
                title: "SAMS | Emergency Patient Flow",
                slogan: "Real-time Clinical Intake & Triage",
                userIdText: "User ID:",
                dbStatus: {
                    connected: "Real-time (Firebase)",
                    mock: "Local Mock DB (No Sync)",
                    connecting: "Connecting...",
                },
                nav: {
                    home: "Home",
                    patientEntry: "Patient Entry",
                    receiving: "Receiving",
                    station: "Station View",
                    archive: "Archive",
                    contact: "Contact"
                },
                home: {
                    heading: "Welcome to SAMS Intake System",
                    p1: "This interface is designed for rapid patient entry and triage management in the Emergency Room. Please use the Patient Entry tab to log incoming patients immediately.",
                    p2: "The Receiving tab shows all pending patients awaiting clinical assignment. The Station tab tracks active patients, and the Archive tab holds discharged records. This list is updated in real-time.",
                    audioStatus: "Audio Status",
                    audioDesc: "The browser requires a user interaction to enable sound alerts.",
                    enableAudio: "Enable Audio",
                    audioEnabled: "Audio Enabled (Bell is active)",
                    audioBlocked: "Audio Blocked (Click to enable)",
                },
                patientEntry: {
                    heading: "ER Patient Quick Entry",
                    nameLabel: "Patient Full Name",
                    dobLabel: "Date of Birth (DOB)",
                    complaintLabel: "Chief Complaint (Symptoms/Injury)",
                    vitalsHeading: "Initial Vitals", 
                    bpmLabel: "BPM (Heart Rate)", 
                    bpLabel: "Blood Pressure (Sys/Dia)", 
                    paramedicLabel: "Paramedic/Sending Team Name", 
                    priorityLabel: "Triage Priority",
                    priorities: { low: "Low (Scheduled/Stable)", medium: "Medium (Urgent)", high: "High (Critical)" },
                    submitBtn: "Log Patient Entry",
                    success: "Patient entry logged successfully. The Receiving team has been notified.",
                    error: "Error saving patient. Check console for details (Mock DB is active if no Firebase connection).",
                    requiredFields: "Please fill in Name, DOB, and Chief Complaint."
                },
                receiving: {
                    heading: "Incoming Patients (Awaiting Triage)",
                    loading: "Loading patients...",
                    empty: "No patients currently awaiting triage.",
                    receiveBtn: "Assign & Move to Station", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time in Receiving:", 
                    submitter: "Submitted by:",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                    stationLabel: "Assign Station Location",
                    stationLocations: { 
                        icu: "ICU (Intensive Care Unit)", 
                        recovery: "Recovery Ward", 
                        discharge: "Discharge Prep Area" 
                    },
                    missingAssignment: "Please select both Staff and a Station Location to proceed."
                },
                station: {
                    heading: "Active Patients (Assigned Station)",
                    loading: "Loading active patients...",
                    empty: "No patients currently assigned to a station.",
                    releaseBtn: "Release Patient / Archive", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time at Station:", 
                    submitter: "Triage/Assignment by:",
                    assigned: "Assigned Staff:",
                    currentStation: "Current Station:", 
                    assignBtn: "Assign Staff",
                    unassigned: "Unassigned",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                    updateVitalsBtn: "Update Vitals", 
                },
                archive: {
                    heading: "Archived/Discharged Patients",
                    loading: "Loading archived records...",
                    empty: "No patients currently in the archive.",
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Archived:",
                    dischargedBy: "Discharged by:", 
                    dischargeDate: "Discharge Date:", 
                    submitter: "Triage/Assignment by:", 
                    clearAllBtn: "Clear All Archived Patients",
                    cleared: "Archive cleared successfully.",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                },
                contact: {
                    heading: "Contact Us",
                    addressTitle: "Our Location",
                    detailsTitle: "General Inquiries",
                    formTitle: "Send a Message",
                    namePlaceholder: "Your Name",
                    emailPlaceholder: "Your Email",
                    messagePlaceholder: "Your Message",
                    submitBtn: "Send Message",
                    success: "Thank you for your message! We will be in touch soon.",
                    error: "Error sending message. Please try again.",
                    requiredFields: "Please fill in all fields."
                },
                modal: { 
                    title: "Confirm Patient Discharge",
                    staffLabel: "Staff Name (Doctor/Nurse)",
                    dateLabel: "Discharge Date",
                    cancelBtn: "Cancel",
                    confirmBtn: "Confirm & Archive",
                    dischargeFailed: "Discharge failed. Please check the form and try again."
                },
                clearModal: {
                    title: "Confirmation: Clear All Patient Data",
                    message: "Are you sure you want to permanently delete ALL patient records (Receiving, Station, and Archive)? This action cannot be undone.",
                    cancelBtn: "Cancel",
                    confirmBtn: "Delete All Records",
                    success: "All patient records have been cleared.",
                    error: "Failed to clear all records. Check console.",
                },
                footer: {
                    rights: "All rights reserved."
                }
            },
            de: {
                title: "SAMS | Notfall Patientenfluss",
                slogan: "Echtzeit Klinische Aufnahme & Triage",
                userIdText: "Benutzer-ID:",
                dbStatus: {
                    connected: "Echtzeit (Firebase)",
                    mock: "Lokaler Testmodus (Keine Synchronisierung)",
                    connecting: "Verbinden...",
                },
                nav: {
                    home: "Startseite",
                    patientEntry: "Patienteneingabe",
                    receiving: "Empfang",
                    station: "Stationsansicht",
                    archive: "Archiv",
                    contact: "Kontakt"
                },
                home: {
                    heading: "Willkommen beim SAMS Aufnahmesystem",
                    p1: "Diese Oberfläche dient der schnellen Patientenaufnahme und dem Triage-Management in der Notaufnahme. Bitte verwenden Sie den Reiter Patienteneingabe, um eintreffende Patienten sofort zu protokollieren.",
                    p2: "Der Empfangs-Reiter zeigt alle ausstehenden Patienten an, die auf eine klinische Zuweisung warten. Der Stations-Reiter verfolgt aktive Patienten, und das Archiv enthält entlassene Aufzeichnungen. Diese Listen werden in Echtzeit aktualisiert.",
                    audioStatus: "Audio Status",
                    audioDesc: "Der Browser erfordert eine Benutzerinteraktion, um akustische Warnungen zu aktivieren.",
                    enableAudio: "Audio aktivieren",
                    audioEnabled: "Audio Aktiviert (Glocke ist aktiv)",
                    audioBlocked: "Audio Blockiert (Zum Aktivieren klicken)",
                },
                patientEntry: {
                    heading: "Notfall Patientenschnelleingabe",
                    nameLabel: "Voller Name des Patienten",
                    dobLabel: "Geburtsdatum (Geb.)",
                    complaintLabel: "Hauptbeschwerde (Symptome/Verletzung)",
                    vitalsHeading: "Anfangsvitalwerte", 
                    bpmLabel: "BPM (Herzfrequenz)", 
                    bpLabel: "Blutdruck (Sys/Dia)", 
                    paramedicLabel: "Name des Notarztes/Teams", 
                    priorityLabel: "Triage-Priorität",
                    priorities: { low: "Niedrig (Geplant/Stabil)", medium: "Mittel (Dringend)", high: "Hoch (Kritisch)" },
                    submitBtn: "Patienteneintrag Protokollieren",
                    success: "Patienteneintrag erfolgreich protokolliert. Das Empfangsteam wurde benachrichtigt.",
                    error: "Fehler beim Speichern des Patienten. Überprüfen Sie die Konsole (Mock-Datenbank ist aktiv, wenn keine Firebase-Verbindung besteht).",
                    requiredFields: "Bitte Name, Geburtsdatum und Hauptbeschwerde ausfüllen."
                },
                receiving: {
                    heading: "Eintreffende Patienten (Warten auf Triage)",
                    loading: "Patienten werden geladen...",
                    empty: "Derzeit warten keine Patienten auf die Triage.",
                    receiveBtn: "Zuweisen & Auf Station Verschieben", 
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit im Empfang:",
                    submitter: "Eingereicht von:",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                    stationLabel: "Stationsort Zuweisen",
                    stationLocations: { 
                        icu: "ICU (Intensivstation)", 
                        recovery: "Aufwachraum", 
                        discharge: "Entlassungsvorbereitungsbereich" 
                    },
                    missingAssignment: "Bitte wählen Sie sowohl Personal als auch einen Stationsort aus."
                },
                station: {
                    heading: "Aktive Patienten (Zugewiesene Station)",
                    loading: "Aktive Patienten werden geladen...",
                    empty: "Derzeit ist kein Patient einer Station zugewiesen.",
                    releaseBtn: "Patient Entlassen / Archiv",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit auf Station:",
                    submitter: "Triage/Zuweisung durch:",
                    assigned: "Zugewiesener Mitarbeiter:",
                    currentStation: "Aktuelle Station:", 
                    assignBtn: "Mitarbeiter Zuweisen",
                    unassigned: "Nicht Zugewiesen",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                    updateVitalsBtn: "Vitalwerte Aktualisieren", 
                },
                archive: {
                    heading: "Archivierte/Entlassene Patienten",
                    loading: "Archivierte Aufzeichnungen werden geladen...",
                    empty: "Derzeit keine Patienten im Archiv.",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Archiviert:",
                    dischargedBy: "Entlassen durch:",
                    dischargeDate: "Entlassungsdatum:",
                    submitter: "Triage/Zuweisung durch:",
                    clearAllBtn: "Alle Patienten Löschen",
                    cleared: "Archiv erfolgreich gelöscht.",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                },
                contact: {
                    heading: "Kontaktieren Sie uns",
                    addressTitle: "Unser Standort",
                    detailsTitle: "Allgemeine Anfragen",
                    formTitle: "Nachricht senden",
                    namePlaceholder: "Ihr Name",
                    emailPlaceholder: "Ihre E-Mail",
                    messagePlaceholder: "Ihre Nachricht",
                    submitBtn: "Nachricht senden",
                    success: "Vielen Dank für Ihre Nachricht! Wir melden uns in Kürze bei Ihnen.",
                    error: "Fehler beim Senden der Nachricht. Bitte versuchen Sie es erneut.",
                    requiredFields: "Bitte füllen Sie alle Felder aus."
                },
                modal: { 
                    title: "Bestätigung der Patientenentlassung",
                    staffLabel: "Mitarbeitername (Arzt/Krankenschwester)",
                    dateLabel: "Entlassungsdatum",
                    cancelBtn: "Abbrechen",
                    confirmBtn: "Bestätigen & Archivieren",
                    dischargeFailed: "Entlassung fehlgeschlagen. Bitte überprüfen Sie das Formular und versuchen Sie es erneut."
                },
                clearModal: {
                    title: "Bestätigung: Alle Patientendaten Löschen",
                    message: "Sind Sie sicher, dass Sie ALLE Patientenakten (Empfang, Station und Archiv) dauerhaft löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.",
                    cancelBtn: "Abbrechen",
                    confirmBtn: "Alle Datensätze Löschen",
                    success: "Alle Patientenakten wurden gelöscht.",
                    error: "Fehler beim Löschen aller Datensätze. Konsole prüfen.",
                },
                footer: {
                    rights: "Alle Rechte vorbehalten."
                }
            }
        };

        // --- Core Application State & Logic ---
       
        const tabs = ['home', 'patientEntry', 'receiving', 'station', 'archive', 'contact'];
       
        // Load initial state from localStorage or use defaults
        const savedLang = localStorage.getItem('samsAppLanguage');
        const savedTab = localStorage.getItem('samsAppActiveTab');

        let currentState = {
            language: (savedLang && dictionary[savedLang]) ? savedLang : 'en', 
            activeTab: (savedTab && tabs.includes(savedTab)) ? savedTab : 'home'
        };
       
        // State for the modals
        let modalPatientId = null;

        /**
         * Initializes the Tone.js Synth for the bell alert.
         */
        function initializeAudio() {
            if (isAudioEnabled) return; // Already initialized

            try {
                // Tone.start() must be called from a user-initiated event.
                Tone.start().then(() => {
                    // Use a simple FM Synth to emulate a metallic bell sound
                    alertSynth = new Tone.FMSynth().toDestination();
                    isAudioEnabled = true;
                    console.log("Tone.js Audio context started.");
                    renderAudioStatus(); // Update UI
                }).catch(e => {
                    console.warn("Tone.start() failed, keeping audio blocked.", e);
                    renderAudioStatus(); // Update UI to blocked state
                });
            } catch (e) {
                console.warn("Tone.js initialization failed, audio alerts will be disabled.", e);
                alertSynth = null;
                isAudioEnabled = false;
                renderAudioStatus(); // Update UI
            }
        }
       
        /**
         * Public function to enable audio, called by a user click.
         */
        window.enableAudio = () => {
             initializeAudio();
        };
       
        /**
         * Updates the audio status indicator in the UI.
         */
        function renderAudioStatus() {
            const statusEl = getEl('audio-status');
            const buttonEl = getEl('enable-audio-btn');
            const content = dictionary[currentState.language].home;
           
            if (!statusEl || !buttonEl) return;
           
            if (isAudioEnabled) {
                statusEl.innerHTML = `<span data-lucide="bell" class="w-4 h-4 mr-2 text-green-500"></span>${content.audioEnabled}`;
                buttonEl.classList.add('hidden');
                statusEl.classList.remove('text-red-600');
                statusEl.classList.add('text-green-600');
            } else {
                statusEl.innerHTML = `<span data-lucide="bell-off" class="w-4 h-4 mr-2 text-red-500"></span>${content.audioBlocked}`;
                buttonEl.textContent = content.enableAudio;
                buttonEl.classList.remove('hidden');
                statusEl.classList.remove('text-green-600');
                statusEl.classList.add('text-red-600');
            }
            lucide.createIcons();
        }

        /**
         * Plays a short bell sound to alert of a new incoming patient.
         */
        function playNewPatientAlert() {
            if (alertSynth && isAudioEnabled) {
                try {
                    // Play a high, short note (like a small bell/chime)
                    alertSynth.triggerAttackRelease("G5", "8n"); 
                    console.log("New patient alert sound played.");
                } catch (e) {
                    console.warn("Error playing audio alert:", e);
                }
            } else {
                console.log("Audio alert blocked or not initialized.");
            }
        }

        // Utility to format date to YYYY-MM-DD
        const getTodayDateString = () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        // Utility to safely retrieve DOM elements
        const getEl = (id) => document.getElementById(id);
       
        /**
         * Utility function to show a temporary message in the Patient Entry tab.
         */
        function displayMessage(message, type = 'info', elementId = 'patient-entry-message') {
            const messageEl = getEl(elementId);
            if (!messageEl) return;

            messageEl.textContent = message;
            messageEl.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'bg-yellow-100', 'text-green-800', 'text-red-800', 'text-yellow-800');
           
            if (type === 'success') {
                messageEl.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageEl.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'warning') {
                messageEl.classList.add('bg-yellow-100', 'text-yellow-800');
            }
           
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }

        /**
         * Converts Firestore Timestamp or JS Date to a standardized Date object.
         * Handles mock DB numbers and Firestore objects.
         */
        const toJsDate = (timestamp) => {
            if (!timestamp) return null;
            if (typeof timestamp === 'number') { // Mock DB timestamp (ms)
                return new Date(timestamp);
            }
            if (timestamp.toDate) { // Firestore Timestamp object
                return timestamp.toDate();
            }
            return new Date(timestamp); // Fallback for other Date-like strings/objects
        };

        /**
         * Formats time elapsed since a timestamp.
         * @param {object} timestamp - The Firestore Timestamp or mock timestamp.
         * @returns {string} Formatted elapsed time (e.g., 5m ago, 2h ago)
         */
        const formatTimeSince = (timestamp) => {
            const date = toJsDate(timestamp);
            if (!date) return '--';

            const now = Date.now();
            const seconds = Math.floor((now - date.getTime()) / 1000);
           
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            return Math.floor(seconds) + "s";
        };

        /**
         * Sets the active tab and saves it to localStorage.
         */
        window.setTab = (tab) => {
            if (currentState.activeTab !== tab) {
                currentState.activeTab = tab;
                localStorage.setItem('samsAppActiveTab', tab);
                render();
            }
        };

        /**
         * Toggles the application language.
         */
        window.toggleLanguage = () => {
            currentState.language = currentState.language === 'en' ? 'de' : 'en';
            localStorage.setItem('samsAppLanguage', currentState.language);
            render();
        };

        /**
         * Opens the discharge confirmation modal.
         */
        window.openModal = (patientId) => {
            modalPatientId = patientId;
            const patient = allPatients.find(p => p.id === patientId);
            const modal = getEl('discharge-modal');
            const content = dictionary[currentState.language].modal;

            if (patient && modal) {
                getEl('modal-patient-name').textContent = `${content.title}: ${patient.name}`;
                getEl('discharge-date').value = getTodayDateString();
                getEl('discharge-staff').value = patient.assignedStaff || ''; // Pre-fill with assigned staff
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100');
            }
        };
       
        /**
         * Opens the Clear All Data confirmation modal.
         */
        window.openClearModal = () => {
            const modal = getEl('clear-archive-modal');
            const content = dictionary[currentState.language].clearModal;
            if (modal) {
                getEl('clear-modal-title').textContent = content.title;
                getEl('clear-modal-message').textContent = content.message;
                getEl('clear-modal-cancel-btn').textContent = content.cancelBtn;
                getEl('clear-modal-confirm-btn').textContent = content.confirmBtn;
                modal.classList.remove('hidden', 'opacity-0');
                modal.classList.add('opacity-100');
            }
        };

        /**
         * Closes any confirmation modal.
         */
        window.closeModal = (modalId) => {
            const modal = getEl(modalId);
            if (modal) {
                modal.classList.add('opacity-0');
                modal.classList.remove('opacity-100');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    if (modalId === 'discharge-modal') modalPatientId = null;
                }, 300); // Wait for transition
            }
        };

        /**
         * Renders the patient card HTML for a given patient and view.
         */
        const renderPatientCard = (patient, view) => {
            const content = dictionary[currentState.language];
            const priorityClass = {
                high: 'bg-red-100 text-red-800 border-red-500 border-l-4',
                medium: 'bg-yellow-100 text-yellow-800 border-yellow-500 border-l-4',
                low: 'bg-green-100 text-green-800 border-green-500 border-l-4'
            }[patient.priority] || 'bg-gray-100 text-gray-800 border-gray-500 border-l-4';

            const timeKey = view === 'station' ? 'timeAtStation' : 'timeAtEntry';
            const timeSince = patient[timeKey] ? formatTimeSince(patient[timeKey]) : '--';
            const timeLabel = view === 'archive' ? content.archive.time : (view === 'station' ? content.station.time : content.receiving.time);
            const patientAge = patient.dob ? `${new Date().getFullYear() - new Date(patient.dob).getFullYear()} yrs` : 'N/A';

            let actionButton = '';
            let assignedStaffInfo = '';
            let dischargeDetails = '';
            let vitalsDisplayAndUpdater = '';
            
            // Flag for critical patients in Receiving view
            const isReceivingCritical = view === 'receiving' && patient.priority === 'high';

            // --- Vitals Display and Updater ---
            vitalsDisplayAndUpdater = `
                <div class="space-y-1">
                    <p class="text-sm font-semibold text-gray-800 mb-1">${content.receiving.vitals}</p>
                    <p class="text-xs ${isReceivingCritical ? 'text-red-700 font-bold' : 'text-red-600'} font-medium">BPM: <span id="bpm-val-${patient.id}">${patient.bpm || 'N/A'}</span></p>
                    <p class="text-xs ${isReceivingCritical ? 'text-red-700 font-bold' : 'text-red-600'} font-medium">BP: <span id="bp-val-${patient.id}">${patient.bp || 'N/A'}</span></p>
            `;
           
            if (view === 'station') {
                vitalsDisplayAndUpdater += `
                    <button id="vitals-btn-${patient.id}" onclick="document.getElementById('vitals-form-${patient.id}').classList.toggle('hidden'); lucide.createIcons();" 
                            class="mt-2 w-full text-xs bg-red-100 text-red-700 font-medium py-1 px-2 rounded-lg hover:bg-red-200 transition duration-200 flex items-center justify-center shadow-sm">
                        <span data-lucide="activity" class="w-3 h-3 mr-1"></span>
                        ${content.station.updateVitalsBtn}
                    </button>
                   
                    <!-- Inline Vitals Update Form (hidden by default) -->
                    <form id="vitals-form-${patient.id}" class="hidden space-y-2 mt-3 p-3 bg-gray-50 rounded-lg shadow-inner" onsubmit="event.preventDefault(); window.updatePatientVitals('${patient.id}', document.getElementById('new-bpm-${patient.id}').value, document.getElementById('new-bp-${patient.id}').value)">
                        <input type="text" id="new-bpm-${patient.id}" class="w-full p-2 border rounded-lg text-sm" placeholder="${content.patientEntry.bpmLabel}" value="${patient.bpm || ''}">
                        <input type="text" id="new-bp-${patient.id}" class="w-full p-2 border rounded-lg text-sm" placeholder="${content.patientEntry.bpLabel} (e.g. 120/80)" value="${patient.bp || ''}">
                        <button type="submit" class="w-full text-xs bg-red-600 text-white font-medium py-1 px-2 rounded-lg hover:bg-red-700 transition duration-200">
                            Update
                        </button>
                    </form>
                `;
            }
            vitalsDisplayAndUpdater += `</div>`; // Close the vitals div


            if (view === 'receiving') {
                const staffOptions = mockStaff.map(staff => `<option value="${staff.name}" ${patient.assignedStaff === staff.name ? 'selected' : ''}>${staff.role}: ${staff.name}</option>`).join('');
               
                const stationOptions = Object.entries(content.receiving.stationLocations).map(([key, value]) => 
                    `<option value="${key}">${value}</option>`
                ).join('');

                actionButton = `
                    <div class="flex flex-col space-y-2 pt-4 border-t border-gray-200">
                        <select id="staff-select-${patient.id}" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm font-medium">
                            <option value="" disabled selected>${content.station.assignBtn}</option>
                            ${staffOptions}
                        </select>
                       
                        <select id="station-select-${patient.id}" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm font-medium">
                            <option value="" disabled selected>${content.receiving.stationLabel}</option>
                            ${stationOptions}
                        </select>
                        <button onclick="window.assignPatientToStation('${patient.id}')"
                            class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                            <span data-lucide="chevrons-right" class="w-4 h-4 mr-2"></span>
                            ${content.receiving.receiveBtn}
                        </button>
                    </div>`;
                // Check if patient is high priority and apply blinking class to the entire card
                if (isReceivingCritical) {
                    priorityClass += ' blinking-red';
                }

            } else if (view === 'station') {
                const currentStationName = content.receiving.stationLocations[patient.stationLocation] || patient.stationLocation;
                assignedStaffInfo = `
                    <div class="space-y-1">
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold">${content.station.assigned}</span>
                            <span id="assigned-staff-val-${patient.id}" class="font-medium text-blue-700">${patient.assignedStaff || content.station.unassigned}</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="font-semibold">${content.station.currentStation}</span>
                            <span class="font-medium text-blue-700">${currentStationName}</span>
                        </p>
                        <button onclick="window.openStaffModal('${patient.id}')"
                            class="text-xs bg-indigo-100 text-indigo-700 font-medium py-1 px-2 rounded-lg hover:bg-indigo-200 transition duration-200 flex items-center shadow-sm">
                            <span data-lucide="users" class="w-3 h-3 mr-1"></span>
                            ${content.station.assignBtn}
                        </button>
                        <!-- Staff selection modal for assignment -->
                        <div id="staff-modal-${patient.id}" class="hidden absolute right-0 mt-1 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-10 p-2">
                             <h4 class="text-xs font-semibold mb-2">${content.station.assignBtn}</h4>
                             <ul class="text-sm space-y-1">
                             ${mockStaff.map(staff => `
                                 <li class="p-1 rounded-md cursor-pointer hover:bg-gray-100" onclick="window.updatePatientStaff('${patient.id}', '${staff.name}'); document.getElementById('staff-modal-${patient.id}').classList.add('hidden');">
                                     ${staff.role}: ${staff.name}
                                 </li>
                             `).join('')}
                             </ul>
                        </div>
                    </div>
                `;
                actionButton = `
                    <button onclick="window.openModal('${patient.id}')"
                        class="w-full py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200 flex items-center justify-center mt-4">
                        <span data-lucide="archive" class="w-4 h-4 mr-2"></span>
                        ${content.station.releaseBtn}
                    </button>`;

            } else if (view === 'archive') {
                const dischargeDate = patient.dischargeDate ? toJsDate(patient.dischargeDate).toLocaleDateString() : 'N/A';
                const dischargedBy = patient.dischargedBy || 'System';
                dischargeDetails = `
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">${content.archive.dischargedBy}</span>
                        <span class="font-medium text-purple-700">${dischargedBy}</span>
                    </p>
                    <p class="text-sm text-gray-600">
                        <span class="font-semibold">${content.archive.dischargeDate}</span>
                        <span class="font-medium text-purple-700">${dischargeDate}</span>
                    </p>
                `;
                // No action button in archive view
                actionButton = '';
            }
            
            // Patient card structure
            return `
                <div id="patient-card-${patient.id}" class="p-4 ${priorityClass} rounded-xl shadow-lg flex flex-col md:flex-row justify-between mb-4 transition duration-300">
                    <div class="md:w-3/4 space-y-2">
                        <!-- Patient Header -->
                        <div class="flex justify-between items-start">
                            <h3 class="text-xl font-bold text-gray-900 leading-tight">${patient.name}</h3>
                            <div class="flex flex-col items-end space-y-1">
                                <span class="text-xs font-semibold px-3 py-1 rounded-full text-white ${patient.priority === 'high' ? 'bg-red-600' : (patient.priority === 'medium' ? 'bg-yellow-600' : 'bg-green-600')}">
                                    ${content.patientEntry.priorities[patient.priority] || patient.priority}
                                </span>
                                <span class="text-xs text-gray-500">${patientAge}</span>
                            </div>
                        </div>

                        <!-- Patient Details -->
                        <p class="text-sm text-gray-700"><span class="font-semibold">${content.receiving.complaint}</span> ${patient.complaint}</p>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-y-1 text-xs text-gray-500">
                            <p><span class="font-semibold">${content.receiving.paramedic}</span> ${patient.paramedicTeam || 'N/A'}</p>
                            <p><span class="font-semibold">${timeLabel}</span> <span id="time-since-${patient.id}" class="font-bold">${timeSince}</span></p>
                            <p><span class="font-semibold">${content.receiving.submitter}</span> ${patient.submittedBy}</p>
                            ${dischargeDetails}
                        </div>
                    </div>

                    <div class="md:w-1/4 md:pl-4 mt-3 md:mt-0 flex flex-col justify-between space-y-4">
                        <!-- Vitals and Updater -->
                        ${vitalsDisplayAndUpdater}

                        <!-- Assigned Staff Info (Station View Only) -->
                        ${assignedStaffInfo}

                        <!-- Action Button (Receiving/Station View Only) -->
                        ${actionButton}
                    </div>
                </div>
            `;
        };
        
        // Helper function to dynamically open the staff assignment modal
        window.openStaffModal = (patientId) => {
            const modal = getEl(`staff-modal-${patientId}`);
            // Hide all other staff modals
            document.querySelectorAll('[id^="staff-modal-"]').forEach(m => {
                if(m.id !== `staff-modal-${patientId}`) m.classList.add('hidden');
            });

            if (modal) {
                modal.classList.toggle('hidden');
            }
        };

        // --- Firebase/Mock DB Functions ---

        /**
         * Determines the path to the 'patients' collection.
         */
        const getPatientsCollectionRef = () => {
            if (useMockDb || !db) {
                return null;
            }
            // Use the public shared collection path
            return collection(db, `artifacts/${appId}/public/data/patients`);
        };
        
        /**
         * Saves a new patient entry to the DB or Mock DB.
         */
        window.logPatientEntry = async (event) => {
            event.preventDefault();
            const content = dictionary[currentState.language].patientEntry;

            const name = getEl('patient-name').value.trim();
            const dob = getEl('patient-dob').value;
            const complaint = getEl('patient-complaint').value.trim();
            const bpm = getEl('patient-bpm').value.trim();
            const bp = getEl('patient-bp').value.trim();
            const paramedicTeam = getEl('patient-paramedic-team').value.trim();
            const priority = getEl('patient-priority').value;

            if (!name || !dob || !complaint) {
                displayMessage(content.requiredFields, 'error');
                return;
            }

            const newPatientData = {
                name,
                dob,
                complaint,
                bpm: bpm || 'N/A',
                bp: bp || 'N/A',
                paramedicTeam: paramedicTeam || 'Walk-in',
                priority,
                status: 'receiving', // Initial status is always 'receiving'
                timeAtEntry: useMockDb ? Date.now() : serverTimestamp(),
                submittedBy: userId,
            };

            try {
                if (useMockDb) {
                    // Mock DB logic
                    newPatientData.id = `mock-${Date.now()}`;
                    mockPatients.push(newPatientData);
                    // Re-run the data refresh for mock data
                    distributePatients(mockPatients);
                    displayMessage(content.success, 'success');
                } else {
                    // Firebase logic
                    const patientsRef = getPatientsCollectionRef();
                    if (!patientsRef) throw new Error("Database reference is null.");
                    await addDoc(patientsRef, newPatientData);
                    displayMessage(content.success, 'success');
                }

                // Clear form after successful submission
                getEl('patient-entry-form').reset();
                // Play audio alert for the new patient
                playNewPatientAlert();
                
            } catch (error) {
                console.error("Error logging patient entry:", error);
                displayMessage(content.error, 'error');
            }
        };
        
        /**
         * Updates a patient's status and assignment to move them to the Station view.
         */
        window.assignPatientToStation = async (patientId) => {
            const staffSelect = getEl(`staff-select-${patientId}`);
            const stationSelect = getEl(`station-select-${patientId}`);
            const content = dictionary[currentState.language].receiving;

            const assignedStaff = staffSelect ? staffSelect.value : null;
            const stationLocation = stationSelect ? stationSelect.value : null;
            
            if (!assignedStaff || !stationLocation) {
                 displayMessage(content.missingAssignment, 'warning');
                 return;
            }

            const updateData = {
                status: 'station',
                stationLocation: stationLocation,
                assignedStaff: assignedStaff,
                timeAtStation: useMockDb ? Date.now() : serverTimestamp(),
                // Retain existing timeAtEntry and other details
            };

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        distributePatients(mockPatients);
                    }
                } else {
                    const patientDocRef = doc(db, `artifacts/${appId}/public/data/patients`, patientId);
                    await updateDoc(patientDocRef, updateData);
                }
            } catch (error) {
                console.error("Error assigning patient to station:", error);
                displayMessage(dictionary[currentState.language].generalError, 'error');
            }
        };
        
        /**
         * Updates the assigned staff member for a patient already at a station.
         */
        window.updatePatientStaff = async (patientId, staffName) => {
             const updateData = { assignedStaff: staffName };
             try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        distributePatients(mockPatients);
                    }
                } else {
                    const patientDocRef = doc(db, `artifacts/${appId}/public/data/patients`, patientId);
                    await updateDoc(patientDocRef, updateData);
                }
            } catch (error) {
                console.error("Error updating patient staff:", error);
                displayMessage(dictionary[currentState.language].generalError, 'error');
            }
        };
        
        /**
         * Updates a patient's vitals (BPM and BP) in the Station view.
         */
        window.updatePatientVitals = async (patientId, newBpm, newBp) => {
            const updateData = {
                bpm: newBpm.trim() || 'N/A',
                bp: newBp.trim() || 'N/A'
            };

            // Hide the form regardless of success
            getEl(`vitals-form-${patientId}`).classList.add('hidden');

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        distributePatients(mockPatients);
                    }
                } else {
                    const patientDocRef = doc(db, `artifacts/${appId}/public/data/patients`, patientId);
                    await updateDoc(patientDocRef, updateData);
                }
            } catch (error) {
                console.error("Error updating patient vitals:", error);
                // Note: No general message needed as this happens silently/inline
            }
        };
        
        /**
         * Confirms and archives a patient, moving them out of the active flow.
         */
        window.dischargePatient = async (event) => {
            event.preventDefault();
            const content = dictionary[currentState.language].modal;

            const dischargedBy = getEl('discharge-staff').value.trim();
            const dischargeDate = getEl('discharge-date').value; // YYYY-MM-DD format
            const patientId = modalPatientId;

            if (!patientId || !dischargedBy || !dischargeDate) {
                console.error("Missing discharge data.", { patientId, dischargedBy, dischargeDate });
                displayMessage(content.dischargeFailed, 'error', 'discharge-modal-message');
                return;
            }
            
            // Convert YYYY-MM-DD date string to a Date object at midnight UTC
            const parsedDate = new Date(dischargeDate + 'T00:00:00Z');
            
            const updateData = {
                status: 'archive',
                dischargedBy: dischargedBy,
                dischargeDate: parsedDate,
                timeArchived: useMockDb ? Date.now() : serverTimestamp()
            };

            try {
                if (useMockDb) {
                    const patientIndex = mockPatients.findIndex(p => p.id === patientId);
                    if (patientIndex !== -1) {
                        mockPatients[patientIndex] = { ...mockPatients[patientIndex], ...updateData };
                        distributePatients(mockPatients);
                    }
                } else {
                    const patientDocRef = doc(db, `artifacts/${appId}/public/data/patients`, patientId);
                    await updateDoc(patientDocRef, updateData);
                }
                window.closeModal('discharge-modal');
                // Auto-switch to Archive view for confirmation
                window.setTab('archive'); 
            } catch (error) {
                console.error("Error discharging patient:", error);
                displayMessage(content.dischargeFailed, 'error', 'discharge-modal-message');
            }
        };

        /**
         * Clears all patient data from the DB or Mock DB.
         */
        window.clearAllPatients = async () => {
            const content = dictionary[currentState.language].clearModal;
            window.closeModal('clear-archive-modal'); // Close the confirmation modal

            try {
                if (useMockDb) {
                    // Clear all mock data and reset the view
                    mockPatients = [];
                    distributePatients([]);
                    displayMessage(content.success, 'success');
                } else {
                    // Firebase logic: delete all documents in the collection
                    const patientsRef = getPatientsCollectionRef();
                    if (!patientsRef) throw new Error("Database reference is null.");
                    
                    const querySnapshot = await getDocs(query(patientsRef));
                    const batch = writeBatch(db);
                    
                    querySnapshot.forEach((document) => {
                        batch.delete(document.ref);
                    });
                    
                    await batch.commit();
                    displayMessage(content.success, 'success');
                }
                
            } catch (error) {
                console.error("Error clearing all patient data:", error);
                displayMessage(content.error, 'error');
            }
        };
        
        /**
         * Distributes the complete patient list into view-specific arrays (Receiving, Station, Archive).
         */
        function distributePatients(patients) {
            allPatients = patients;
            receivingPatients = patients.filter(p => p.status === 'receiving').sort((a, b) => {
                const timeA = toJsDate(a.timeAtEntry)?.getTime() || 0;
                const timeB = toJsDate(b.timeAtEntry)?.getTime() || 0;
                return timeA - timeB; // Sort by earliest entry time
            });
            stationPatients = patients.filter(p => p.status === 'station').sort((a, b) => {
                const timeA = toJsDate(a.timeAtStation)?.getTime() || 0;
                const timeB = toJsDate(b.timeAtStation)?.getTime() || 0;
                return timeA - timeB; // Sort by earliest time at station
            });
            archivedPatients = patients.filter(p => p.status === 'archive').sort((a, b) => {
                const timeA = toJsDate(a.timeArchived || a.timeAtEntry)?.getTime() || 0;
                const timeB = toJsDate(b.timeArchived || b.timeAtEntry)?.getTime() || 0;
                return timeB - timeA; // Sort by latest archive time (most recent first)
            });

            // Re-render the current active view to reflect changes
            renderContent(currentState.activeTab);
        }

        /**
         * Main listener for Firebase data changes.
         */
        function startDataListener() {
            if (useMockDb || !isAuthReady || !db) return;

            const patientsRef = getPatientsCollectionRef();
            if (!patientsRef) {
                console.error("Cannot start listener: Invalid patients collection reference.");
                return;
            }
            
            // Listen to the entire collection and filter/sort client-side
            onSnapshot(patientsRef, (snapshot) => {
                const patients = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                distributePatients(patients);
                console.log("Firestore update received.");
            }, (error) => {
                console.error("Firestore listen error:", error);
                // Optionally revert to mock DB if critical error occurs
                if (!useMockDb) {
                    useMockDb = true;
                    dbStatus = dictionary[currentState.language].dbStatus.mock;
                    console.warn("Reverting to Mock DB due to Firestore error.");
                    distributePatients(initialMockPatients);
                    renderHeader(); // Update status indicator
                }
            });
        }

        /**
         * Sets up Firebase authentication and decides between Firebase and Mock DB.
         */
        async function initializeFirebase() {
            if (!firebaseConfig) {
                useMockDb = true;
                dbStatus = dictionary[currentState.language].dbStatus.mock;
                console.warn("Firebase config missing. Running in Mock DB mode.");
                distributePatients(initialMockPatients);
                isAuthReady = true;
                renderHeader();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                useMockDb = true;
                dbStatus = dictionary[currentState.language].dbStatus.mock;
                distributePatients(initialMockPatients);
                isAuthReady = true;
                renderHeader();
                return;
            }

            // Authentication setup
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    try {
                        // Attempt to sign in
                        if (initialAuthToken) {
                            const userCred = await signInWithCustomToken(auth, initialAuthToken);
                            userId = userCred.user.uid;
                        } else {
                            // Fallback to anonymous sign-in
                            const userCred = await signInAnonymously(auth);
                            userId = userCred.user.uid;
                        }
                    } catch (error) {
                        console.error("Auth sign-in failed:", error);
                        // If auth fails, use a unique mock ID and revert to mock DB
                        userId = 'anon-' + crypto.randomUUID().substring(0, 8);
                        useMockDb = true;
                    }
                }
                
                dbStatus = useMockDb ? dictionary[currentState.language].dbStatus.mock : dictionary[currentState.language].dbStatus.connected;
                isAuthReady = true;
                renderHeader();
                
                if (!useMockDb) {
                    startDataListener(); // Start listening to real-time updates
                } else {
                    // For mock DB, ensure data is distributed after userId is set
                    distributePatients(initialMockPatients);
                }
            });
        }

        // --- Rendering Functions ---

        /**
         * Renders the header, navigation, and user/DB status.
         */
        function renderHeader() {
            const content = dictionary[currentState.language];
            getEl('page-title').textContent = content.title;
            
            // Header HTML
            const headerHtml = `
                <div class="header-fixed bg-white shadow-lg border-b border-gray-200">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="flex justify-between items-center py-4">
                            <!-- Logo and Title -->
                            <div class="flex items-center">
                                <span data-lucide="ambulance" class="w-8 h-8 text-red-600 mr-3"></span>
                                <div class="text-2xl font-extrabold text-gray-900 leading-none">SAMS</div>
                                <span class="ml-4 text-sm text-gray-500 hidden sm:inline">${content.slogan}</span>
                            </div>

                            <!-- Nav Links -->
                            <nav class="hidden md:flex space-x-4">
                                ${tabs.map(tab => `
                                    <button onclick="window.setTab('${tab}')"
                                        class="px-3 py-2 text-sm font-medium rounded-lg transition-colors duration-200 
                                        ${currentState.activeTab === tab ? 'bg-red-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100 hover:text-red-600'}">
                                        ${content.nav[tab]}
                                        ${tab === 'receiving' && receivingPatients.length > 0 ? `<span class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-800 text-xs text-white">${receivingPatients.length}</span>` : ''}
                                        ${tab === 'station' && stationPatients.length > 0 ? `<span class="ml-1 inline-flex items-center justify-center h-5 w-5 rounded-full bg-blue-800 text-xs text-white">${stationPatients.length}</span>` : ''}
                                    </button>
                                `).join('')}
                            </nav>

                            <!-- Language Switch -->
                            <button onclick="window.toggleLanguage()" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200 transition duration-200 text-sm font-semibold">
                                ${currentState.language === 'en' ? 'DE' : 'EN'}
                            </button>
                        </div>

                        <!-- User/Status Bar (Only visible after auth is ready) -->
                        <div class="flex items-center justify-between text-xs py-1 border-t border-gray-100">
                            <div class="flex items-center text-gray-500">
                                <span data-lucide="database" class="w-3 h-3 mr-1"></span>
                                <span class="font-semibold mr-2">DB Status:</span>
                                <span class="font-medium text-blue-600">${dbStatus}</span>
                            </div>
                            <div class="flex items-center text-gray-500">
                                <span data-lucide="user" class="w-3 h-3 mr-1"></span>
                                <span class="font-semibold">${content.userIdText}</span>
                                <span class="font-medium ml-1 text-red-600">${userId || '---'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mobile Nav -->
                    <nav class="md:hidden flex justify-around border-t border-gray-200 bg-white py-2">
                        ${tabs.map(tab => `
                            <button onclick="window.setTab('${tab}')"
                                class="flex flex-col items-center px-2 py-1 text-xs font-medium rounded-lg transition-colors duration-200 
                                ${currentState.activeTab === tab ? 'text-red-600' : 'text-gray-500 hover:text-red-600'}">
                                ${tab === 'home' ? '<span data-lucide="home" class="w-5 h-5"></span>' : ''}
                                ${tab === 'patientEntry' ? '<span data-lucide="clipboard-plus" class="w-5 h-5"></span>' : ''}
                                ${tab === 'receiving' ? '<span data-lucide="list-checks" class="w-5 h-5"></span>' : ''}
                                ${tab === 'station' ? '<span data-lucide="monitor-dot" class="w-5 h-5"></span>' : ''}
                                ${tab === 'archive' ? '<span data-lucide="archive" class="w-5 h-5"></span>' : ''}
                                ${tab === 'contact' ? '<span data-lucide="phone" class="w-5 h-5"></span>' : ''}
                                <span class="mt-1">${content.nav[tab]}</span>
                                ${tab === 'receiving' && receivingPatients.length > 0 ? `<span class="absolute top-1 right-1 inline-flex items-center justify-center h-4 w-4 rounded-full bg-red-600 text-[10px] text-white">${receivingPatients.length}</span>` : ''}
                                ${tab === 'station' && stationPatients.length > 0 ? `<span class="absolute top-1 right-1 inline-flex items-center justify-center h-4 w-4 rounded-full bg-blue-600 text-[10px] text-white">${stationPatients.length}</span>` : ''}
                            </button>
                        `).join('')}
                    </nav>
                </div>
            `;
            getEl('app-header').innerHTML = headerHtml;
            lucide.createIcons();
        }

        /**
         * Renders the content area based on the active tab.
         */
        function renderContent(tab) {
            const contentContainer = getEl('app-content');
            if (!contentContainer) return;
            
            const langContent = dictionary[currentState.language];
            let html = '';

            // Stop the interval for timer updates if it's running
            clearInterval(updateTimerInterval);

            switch (tab) {
                case 'home':
                    html = renderHome(langContent);
                    renderAudioStatus(); // Make sure audio status is updated
                    break;
                case 'patientEntry':
                    html = renderPatientEntry(langContent);
                    break;
                case 'receiving':
                    html = renderPatientList(langContent.receiving, receivingPatients, 'receiving');
                    startTimerUpdates();
                    break;
                case 'station':
                    html = renderPatientList(langContent.station, stationPatients, 'station');
                    startTimerUpdates();
                    break;
                case 'archive':
                    html = renderPatientList(langContent.archive, archivedPatients, 'archive');
                    break;
                case 'contact':
                    html = renderContact(langContent);
                    break;
                default:
                    html = renderHome(langContent);
                    break;
            }

            contentContainer.innerHTML = html;
            lucide.createIcons();
        }
        
        /**
         * Renders the Home tab content.
         */
        function renderHome(content) {
            return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-8">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4 flex items-center">
                        <span data-lucide="layout-grid" class="w-6 h-6 mr-2 text-red-600"></span>
                        ${content.home.heading}
                    </h2>
                    <p class="text-gray-600 mb-6">${content.home.p1}</p>
                    <p class="text-gray-600 mb-8">${content.home.p2}</p>
                    
                    <div class="border-t border-gray-200 pt-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-3 flex items-center">
                            <span data-lucide="volume-2" class="w-5 h-5 mr-2 text-red-600"></span>
                            ${content.home.audioStatus}
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">${content.home.audioDesc}</p>
                        <div class="flex items-center space-x-4">
                            <p id="audio-status" class="text-sm font-medium flex items-center"></p>
                            <button id="enable-audio-btn" onclick="window.enableAudio()" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200"></button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the Patient Entry form.
         */
        function renderPatientEntry(content) {
            const priorities = Object.entries(content.patientEntry.priorities).map(([key, value]) => 
                `<option value="${key}" ${key === 'medium' ? 'selected' : ''}>${value}</option>`
            ).join('');
            
            return `
                <div class="max-w-xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-lg mt-8">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">
                        <span data-lucide="clipboard-plus" class="w-6 h-6 mr-2 text-red-600"></span>
                        ${content.patientEntry.heading}
                    </h2>
                    
                    <!-- Submission Message -->
                    <div id="patient-entry-message" class="hidden p-3 mb-4 rounded-lg text-sm font-medium"></div>

                    <form id="patient-entry-form" onsubmit="window.logPatientEntry(event)" class="space-y-4">
                        <!-- Patient Details -->
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-gray-700">${content.patientEntry.nameLabel} <span class="text-red-500">*</span></label>
                            <input type="text" id="patient-name" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="patient-dob" class="block text-sm font-medium text-gray-700">${content.patientEntry.dobLabel} <span class="text-red-500">*</span></label>
                            <input type="date" id="patient-dob" required max="${getTodayDateString()}" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div>
                            <label for="patient-complaint" class="block text-sm font-medium text-gray-700">${content.patientEntry.complaintLabel} <span class="text-red-500">*</span></label>
                            <textarea id="patient-complaint" required rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="e.g., Laceration to forearm, severe abdominal pain..."></textarea>
                        </div>

                        <!-- Vitals -->
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">${content.patientEntry.vitalsHeading}</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="patient-bpm" class="block text-sm font-medium text-gray-700">${content.patientEntry.bpmLabel}</label>
                                    <input type="text" id="patient-bpm" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="e.g., 85">
                                </div>
                                <div>
                                    <label for="patient-bp" class="block text-sm font-medium text-gray-700">${content.patientEntry.bpLabel}</label>
                                    <input type="text" id="patient-bp" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="e.g., 120/80">
                                </div>
                            </div>
                        </div>

                        <!-- Paramedic & Priority -->
                        <div>
                            <label for="patient-paramedic-team" class="block text-sm font-medium text-gray-700">${content.patientEntry.paramedicLabel}</label>
                            <input type="text" id="patient-paramedic-team" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500" placeholder="e.g., Ambulance 1, Walk-in, Local Clinic">
                        </div>
                        <div>
                            <label for="patient-priority" class="block text-sm font-medium text-gray-700">${content.patientEntry.priorityLabel}</label>
                            <select id="patient-priority" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-red-500 focus:border-red-500">
                                ${priorities}
                            </select>
                        </div>

                        <button type="submit" class="w-full py-3 px-4 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition duration-200 flex items-center justify-center text-lg">
                            <span data-lucide="save" class="w-5 h-5 mr-2"></span>
                            ${content.submitBtn}
                        </button>
                    </form>
                </div>
            `;
        }

        /**
         * Renders the list view for Receiving, Station, or Archive.
         */
        function renderPatientList(content, patients, view) {
            let listHtml = '';

            if (!isAuthReady) {
                listHtml = `<p class="text-center text-gray-500 p-8">${content.loading}</p>`;
            } else if (patients.length === 0) {
                listHtml = `<div class="bg-white p-8 rounded-xl shadow-lg mt-8 text-center text-gray-500">
                                <span data-lucide="folder-open" class="w-10 h-10 mx-auto text-gray-400 mb-3"></span>
                                <p class="text-lg">${content.empty}</p>
                            </div>`;
            } else {
                listHtml = patients.map(p => renderPatientCard(p, view)).join('');
            }
            
            let clearButton = '';
            if (view === 'archive' && patients.length > 0) {
                 clearButton = `
                    <button onclick="window.openClearModal()" 
                        class="mt-6 py-3 px-6 bg-gray-200 text-gray-700 font-semibold rounded-lg shadow-md hover:bg-gray-300 transition duration-200 flex items-center justify-center w-full md:w-auto">
                        <span data-lucide="trash-2" class="w-4 h-4 mr-2"></span>
                        ${content.clearAllBtn}
                    </button>`;
            }

            return `
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-3">
                        <h2 class="text-3xl font-bold text-gray-900 flex items-center">
                            <span data-lucide="${view === 'receiving' ? 'list-checks' : (view === 'station' ? 'monitor-dot' : 'archive')}" class="w-6 h-6 mr-2 text-red-600"></span>
                            ${content.heading}
                            <span class="ml-3 inline-flex items-center justify-center h-8 w-8 rounded-full ${patients.length > 0 ? 'bg-red-600' : 'bg-gray-400'} text-sm text-white font-bold">${patients.length}</span>
                        </h2>
                        ${view === 'archive' ? clearButton : ''}
                    </div>
                    
                    <!-- List Container -->
                    <div id="${view}-patient-list" class="space-y-4">
                        ${listHtml}
                    </div>
                    
                    ${view === 'archive' && patients.length > 0 ? '<div class="flex justify-end">' + clearButton + '</div>' : ''}
                </div>
            `;
        }
        
        /**
         * Renders the Contact tab content.
         */
        function renderContact(content) {
             return `
                <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-6">
                        <h2 class="text-3xl font-extrabold text-gray-900 mb-4 flex items-center">
                            <span data-lucide="phone" class="w-6 h-6 mr-2 text-red-600"></span>
                            ${content.contact.heading}
                        </h2>
                        
                        <!-- Address -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">${content.contact.addressTitle}</h3>
                            <p class="text-gray-600">123 Emergency Way</p>
                            <p class="text-gray-600">Health City, 90210</p>
                            <p class="text-gray-600">Global</p>
                        </div>
                        
                        <!-- Details -->
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">${content.contact.detailsTitle}</h3>
                            <p class="text-gray-600 flex items-center"><span data-lucide="mail" class="w-4 h-4 mr-2 text-red-500"></span> info@sams.com</p>
                            <p class="text-gray-600 flex items-center"><span data-lucide="phone" class="w-4 h-4 mr-2 text-red-500"></span> (555) 123-4567</p>
                        </div>
                    </div>

                    <!-- Contact Form -->
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">${content.contact.formTitle}</h3>
                        <div id="contact-message" class="hidden p-3 mb-4 rounded-lg text-sm font-medium"></div>

                        <form id="contact-form" onsubmit="event.preventDefault(); window.sendContactMessage(event);" class="space-y-4">
                            <div>
                                <input type="text" id="contact-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="${content.contact.namePlaceholder}" required>
                            </div>
                            <div>
                                <input type="email" id="contact-email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="${content.contact.emailPlaceholder}" required>
                            </div>
                            <div>
                                <textarea id="contact-message-body" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="${content.contact.messagePlaceholder}" required></textarea>
                            </div>
                            <button type="submit" class="w-full py-3 px-4 bg-red-600 text-white font-bold rounded-lg shadow-xl hover:bg-red-700 transition duration-200 flex items-center justify-center">
                                <span data-lucide="send" class="w-5 h-5 mr-2"></span>
                                ${content.contact.submitBtn}
                            </button>
                        </form>
                    </div>
                </div>
            `;
        }
        
        /**
         * Mock function for contact form submission (no actual backend needed).
         */
        window.sendContactMessage = (event) => {
            event.preventDefault();
            const content = dictionary[currentState.language].contact;
            
            const name = getEl('contact-name').value;
            const email = getEl('contact-email').value;
            const message = getEl('contact-message-body').value;
            
            if (!name || !email || !message) {
                 displayMessage(content.requiredFields, 'error', 'contact-message');
                 return;
            }

            // Simulate API call success
            setTimeout(() => {
                displayMessage(content.success, 'success', 'contact-message');
                getEl('contact-form').reset();
            }, 1000);
        };

        /**
         * Starts an interval to update the "Time since" displays every few seconds.
         */
        function startTimerUpdates() {
            // Update every 5 seconds for efficiency
            updateTimerInterval = setInterval(() => {
                // Only update the current active list
                const patients = currentState.activeTab === 'receiving' ? receivingPatients : stationPatients;
                const timeKey = currentState.activeTab === 'station' ? 'timeAtStation' : 'timeAtEntry';
                
                patients.forEach(patient => {
                    const timeEl = getEl(`time-since-${patient.id}`);
                    if (timeEl && patient[timeKey]) {
                        timeEl.textContent = formatTimeSince(patient[timeKey]);
                    }
                    
                    // Check for critical timing alerts (e.g., in receiving for > 30m)
                    if (currentState.activeTab === 'receiving' && patient.priority === 'high' && patient.timeAtEntry) {
                         const timeInMs = Date.now() - toJsDate(patient.timeAtEntry).getTime();
                         const cardEl = getEl(`patient-card-${patient.id}`);
                         // 30 minutes in milliseconds
                         if (timeInMs > 30 * 60 * 1000) { 
                             if (cardEl && !cardEl.classList.contains('blinking-red')) {
                                cardEl.classList.add('blinking-red');
                            }
                         } else {
                             if (cardEl) {
                                cardEl.classList.remove('blinking-red');
                            }
                         }
                    }
                });
            }, 5000);
        }

        /**
         * Main render function that redraws the UI components.
         */
        function render() {
            renderHeader();
            renderContent(currentState.activeTab);
            renderModals();
        }
        
        /**
         * Renders the modals based on the current language.
         */
        function renderModals() {
            const content = dictionary[currentState.language];
            
            // Discharge Modal content
            getEl('modal-staff-label').textContent = content.modal.staffLabel;
            getEl('modal-date-label').textContent = content.modal.dateLabel;
            getEl('modal-cancel-btn').textContent = content.modal.cancelBtn;
            getEl('modal-confirm-btn').textContent = content.modal.confirmBtn;
            
            // Clear Archive Modal content
            getEl('clear-modal-title').textContent = content.clearModal.title;
            getEl('clear-modal-message').textContent = content.clearModal.message;
            getEl('clear-modal-cancel-btn').textContent = content.clearModal.cancelBtn;
            getEl('clear-modal-confirm-btn').textContent = content.clearModal.confirmBtn;

            lucide.createIcons();
        }

        // --- Initialization ---

        window.onload = () => {
            initializeFirebase();
            render();
        };

    </script>
</head>
<body class="min-h-screen">

    <!-- Main Application Container -->
    <div id="app-header">
        <!-- Header will be rendered here -->
    </div>

    <main id="app-content" class="min-h-[calc(100vh-100px)] p-4 pt-0">
        <!-- Content based on active tab will be rendered here -->
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 text-center text-xs text-gray-500">
            &copy; 2024 SAMS Emergency Flow System. 
            <span id="footer-rights">${dictionary.en.footer.rights}</span>
        </div>
    </footer>

    <!-- 1. Discharge Confirmation Modal (Hidden by default) -->
    <div id="discharge-modal" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transition duration-300 transform scale-100" onclick="event.stopPropagation()">
            <h3 id="modal-patient-name" class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Confirm Patient Discharge</h3>
            
            <!-- Message area for modal errors -->
            <div id="discharge-modal-message" class="hidden p-3 mb-4 rounded-lg text-sm font-medium bg-red-100 text-red-800"></div>

            <form onsubmit="window.dischargePatient(event)">
                <div class="space-y-4">
                    <div>
                        <label id="modal-staff-label" for="discharge-staff" class="block text-sm font-medium text-gray-700">Staff Name (Doctor/Nurse)</label>
                        <input type="text" id="discharge-staff" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="e.g. Dr. A. Smith">
                    </div>
                    <div>
                        <label id="modal-date-label" for="discharge-date" class="block text-sm font-medium text-gray-700">Discharge Date</label>
                        <input type="date" id="discharge-date" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                </div>
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="modal-cancel-btn" onclick="window.closeModal('discharge-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-200">Cancel</button>
                    <button type="submit" id="modal-confirm-btn" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">Confirm & Archive</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. Clear All Confirmation Modal (Hidden by default) -->
    <div id="clear-archive-modal" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 opacity-0">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transition duration-300 transform scale-100" onclick="event.stopPropagation()">
            <h3 id="clear-modal-title" class="text-xl font-bold text-red-600 mb-4 border-b pb-2">Confirmation: Clear All Patient Data</h3>
            
            <div class="flex items-start space-x-4 mb-6">
                <span data-lucide="alert-triangle" class="w-8 h-8 text-yellow-500 flex-shrink-0 mt-1"></span>
                <p id="clear-modal-message" class="text-gray-700">Are you sure you want to permanently delete ALL patient records (Receiving, Station, and Archive)? This action cannot be undone.</p>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="clear-modal-cancel-btn" onclick="window.closeModal('clear-archive-modal')" class="py-2 px-4 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-200">Cancel</button>
                <button type="button" id="clear-modal-confirm-btn" onclick="window.clearAllPatients()" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200">Delete All Records</button>
            </div>
        </div>
    </div>

</body>
</html>
