<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS | Emergency Patient Flow</title>
    <!-- Add a favicon link to resolve the 404 error in the console -->
    <link rel="icon" href="https://placehold.co/32x32/3b82f6/ffffff?text=S" type="image/png"> 
    
    <!-- Load Firebase/Tailwind/Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- NOTE: The console warns that cdn.tailwindcss.com should not be used in production. -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font import for a professional look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .main-container {
            min-height: calc(100vh - 80px); /* Account for header */
        }
        /* Custom focus state for accessibility */
        .tab-btn:focus, .lang-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); /* Blue ring */
        }
        /* CSS for the blinking effect */
        .blinking-red {
            animation: blink-animation 1s steps(5, start) infinite;
            background-color: #fecaca !important; /* Red-200 */
            color: #991b1b !important; /* Red-800 */
        }
        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Brand -->
            <div class="flex items-center space-x-2">
                <div class="text-2xl font-extrabold text-blue-600">SAMS</div>
                <div id="header-slogan" class="text-sm text-gray-500 hidden sm:block"></div>
            </div>

            <div class="flex items-center space-x-4">
                <!-- User ID Display (Important for multi-user context) -->
                <div class="text-xs text-gray-500">
                    <span id="user-id-text">User ID:</span> <span id="user-id-display" class="font-mono text-gray-700">Loading...</span>
                </div>
                <!-- Language Toggle -->
                <button id="language-toggle" onclick="window.toggleLanguage()" class="lang-btn flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-3 rounded-lg transition duration-200 text-sm">
                    <span id="current-lang-text">EN</span>
                    <span data-lucide="globe" class="w-4 h-4 ml-2"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Title -->
        <h1 id="page-title" class="text-3xl sm:text-4xl font-bold text-blue-800 mb-6 text-center"></h1>
        
        <!-- Tab Navigation (Desktop and Mobile) -->
        <div class="bg-white p-2 rounded-xl shadow-lg mb-8 overflow-x-auto">
            <nav id="tab-nav" class="flex space-x-1 sm:space-x-2 justify-center">
                <!-- Tab buttons will be inserted here by JavaScript -->
            </nav>
        </div>

        <!-- Dynamic Content Section -->
        <div id="content-container" class="space-y-8">
            
            <!-- Home/Start Content -->
            <div id="tab-home" class="tab-content bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-blue-600">
                <h2 id="home-heading" class="text-2xl font-semibold text-gray-900 mb-4"></h2>
                <p id="home-paragraph-1" class="text-gray-600 mb-4 leading-relaxed"></p>
                <p id="home-paragraph-2" class="text-gray-600 leading-relaxed"></p>
            </div>

            <!-- Patient Entry / Patienteneingabe Content -->
            <div id="tab-patientEntry" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-green-600">
                <h2 id="patientEntry-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="user-plus" class="w-6 h-6 mr-2 text-green-600"></span>
                </h2>
                
                <form id="patient-entry-form" class="space-y-4 max-w-lg mx-auto">
                    <!-- Patient Details -->
                    <div>
                        <label for="p-name" id="p-name-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <input type="text" id="p-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="p-dob" id="p-dob-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <input type="date" id="p-dob" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="p-complaint" id="p-complaint-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <textarea id="p-complaint" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>

                    <!-- Vitals Section -->
                    <div class="pt-4 border-t border-gray-200">
                        <h3 id="vitals-heading" class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                            <span data-lucide="heart-pulse" class="w-5 h-5 mr-2 text-red-500"></span>
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="p-bpm" id="p-bpm-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                                <input type="number" id="p-bpm" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="e.g. 85">
                            </div>
                            <div>
                                <label for="p-bp" id="p-bp-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                                <input type="text" id="p-bp" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="e.g. 120/80">
                            </div>
                        </div>
                    </div>

                    <!-- Paramedic & Priority Section -->
                    <div class="pt-4 border-t border-gray-200 space-y-4">
                        <div>
                            <label for="p-paramedic" id="p-paramedic-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                            <input type="text" id="p-paramedic" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" placeholder="e.g. EMT Smith / Ambulance Team 4">
                        </div>
                        <div>
                            <label for="p-priority" id="p-priority-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                            <select id="p-priority" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                                <!-- Options populated by JS render function -->
                            </select>
                        </div>
                    </div>

                    <button type="submit" id="patientEntry-submit-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-md"></button>
                    <div id="patient-message-box" class="mt-4 p-3 rounded-lg text-center hidden" role="alert"></div>
                </form>
            </div>

            <!-- Receiving / Empfang Content -->
            <div id="tab-receiving" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-red-600">
                <h2 id="receiving-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-red-600"></span>
                </h2>
                <div id="receiving-list-container" class="space-y-4">
                    <!-- Patient cards/loading/empty states will be rendered here by JS -->
                </div>
            </div>

            <!-- Station / Station Content -->
            <div id="tab-station" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-blue-600">
                <h2 id="station-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="hospital" class="w-6 h-6 mr-2 text-blue-600"></span>
                </h2>
                
                <!-- Capacity Counters -->
                <div id="capacity-display" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                    <!-- Capacity details will be rendered here -->
                </div>

                <!-- Recovery Section -->
                <div class="mb-8">
                    <h3 id="recovery-heading" class="text-xl font-bold text-green-700 mb-4 flex items-center border-b pb-2">
                        <span data-lucide="bed" class="w-5 h-5 mr-2"></span>
                    </h3>
                    <div id="recovery-list-container" class="space-y-4">
                        <!-- Recovery patient cards will be rendered here -->
                    </div>
                </div>

                <!-- ICU Section -->
                <div>
                    <h3 id="icu-heading" class="text-xl font-bold text-red-700 mb-4 flex items-center border-b pb-2">
                        <span data-lucide="heart-pulse" class="w-5 h-5 mr-2"></span>
                    </h3>
                    <div id="icu-list-container" class="space-y-4">
                        <!-- ICU patient cards will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Archive / Archiv Content -->
            <div id="tab-archive" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-gray-400">
                <h2 id="archive-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="archive" class="w-6 h-6 mr-2 text-gray-600"></span>
                </h2>
                <div id="archive-list-container" class="space-y-4">
                    <!-- Patient cards will be rendered here -->
                </div>
            </div>

            <!-- Contact / Kontakt Content -->
            <div id="tab-contact" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-gray-600">
                <h2 id="contact-heading" class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <span data-lucide="mail" class="w-6 h-6 mr-2 text-gray-600"></span>
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 id="contact-address-title" class="font-bold text-lg text-gray-700 mb-2"></h3>
                        <p class="text-gray-600">
                            San Andres Medical Service (SAMS)<br>
                            123 Health Ave, San Andres City<br>
                            CA 90210, Country<br>
                        </p>
                    </div>
                    <div>
                        <h3 id="contact-details-title" class="font-bold text-lg text-gray-700 mb-2"></h3>
                        <p id="contact-phone" class="text-gray-600 mb-1">Phone: +1 555-SAMS-HELP</p>
                        <p id="contact-email" class="text-gray-600">Email: info@sams.com</p>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 id="contact-form-title" class="font-bold text-lg text-gray-700 mb-4"></h3>
                    <form>
                        <input id="contact-name-placeholder" type="text" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input id="contact-email-placeholder" type="email" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <textarea id="contact-message-placeholder" rows="4" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button id="contact-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-10 p-4">
        <div class="max-w-7xl mx-auto text-center text-sm">
            &copy; <span id="footer-year"></span> San Andres Medical Service (SAMS). <span id="footer-rights"></span>
        </div>
    </footer>

    <!-- 1. Discharge Confirmation Modal -->
    <div id="discharge-modal" class="modal-backdrop hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <h3 id="modal-title" class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                <span data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></span>
            </h3>
            <p id="modal-patient-name" class="text-lg text-gray-700 mb-4"></p>
            
            <form id="discharge-form" class="space-y-4">
                <div>
                    <label for="discharge-staff-name" id="modal-staff-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="text" id="discharge-staff-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Dr. John Doe">
                </div>
                <div>
                    <label for="discharge-date" id="modal-date-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="date" id="discharge-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="window.closeModal('discharge-modal')" id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-200"></button>
                    <button type="submit" id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Discharge Confirmation Modal -->
    
    <!-- 2. Area Assignment Modal (Receiving -> Station) -->
    <div id="area-assignment-modal" class="modal-backdrop hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <h3 id="area-modal-title" class="text-2xl font-bold text-red-700 mb-4 flex items-center">
                <span data-lucide="link" class="w-6 h-6 mr-2"></span>
            </h3>
            <p id="area-modal-patient-name" class="text-lg text-gray-700 mb-4"></p>
            
            <form id="area-assignment-form" class="space-y-4">
                <div>
                    <label for="target-area" id="area-modal-target-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <select id="target-area" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 bg-white">
                        <option value="recovery" id="area-option-recovery"></option>
                        <option value="icu" id="area-option-icu"></option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="window.closeModal('area-assignment-modal')" id="area-modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-200"></button>
                    <button type="submit" id="area-modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition duration-200 shadow-md"></button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Area Assignment Modal -->
    
    <!-- 3. Staff & Notes Modal (Station View Updates) -->
    <div id="staff-notes-modal" class="modal-backdrop hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <h3 id="staff-notes-modal-title" class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                <span data-lucide="clipboard-edit" class="w-6 h-6 mr-2"></span>
            </h3>
            <p id="staff-notes-modal-patient-name" class="text-lg text-gray-700 mb-4"></p>
            
            <form id="staff-notes-form" class="space-y-4">
                <div>
                    <label for="update-staff-name" id="staff-notes-staff-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="text" id="update-staff-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Dr. Jane Smith">
                </div>
                <div>
                    <label for="update-notes" id="staff-notes-notes-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <textarea id="update-notes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Add clinical notes, medication, or status updates..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="window.closeModal('staff-notes-modal')" id="staff-notes-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-200"></button>
                    <button type="submit" id="staff-notes-confirm-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Staff & Notes Modal -->


    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');
        
        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Instances
        let app, db, auth, userId = null;
        let isAuthReady = false;
        let useMockDb = false;
        
        // --- System Constants ---
        const CAPACITIES = {
            recovery: 6, // Aufwachraum: 6 Betten
            icu: 4       // ICU: 4 rooms
        };

        // All patients loaded from DB/Mock DB
        let allPatients = []; 
        // Derived lists for UI
        let receivingPatients = []; 
        let icuPatients = [];
        let recoveryPatients = [];
        let archivedPatients = [];
        let mockPatients = []; // Mock database for when Firebase is unavailable

        // State for the modals
        let dischargeModalPatientId = null;
        let areaModalPatientId = null;
        let staffNotesModalPatientId = null;

        
        // Dictionary for multilingual content
        const dictionary = {
            en: {
                title: "SAMS | Emergency Patient Flow",
                slogan: "Real-time Clinical Intake & Triage",
                userIdText: "User ID:",
                nav: {
                    home: "Home",
                    patientEntry: "Patient Entry",
                    receiving: "Receiving",
                    station: "Station View",
                    archive: "Archive",
                    contact: "Contact"
                },
                home: {
                    heading: "Welcome to SAMS Intake System",
                    p1: "This interface is designed for rapid patient entry and triage management in the Emergency Room. Please use the Patient Entry tab to log incoming patients immediately.",
                    p2: "The Receiving tab shows all pending patients awaiting clinical assignment. The Station tab tracks active patients in ICU/Recovery, and the Archive tab holds discharged records. This list is updated in real-time.",
                },
                patientEntry: {
                    heading: "ER Patient Quick Entry",
                    nameLabel: "Patient Full Name",
                    dobLabel: "Date of Birth (DOB)",
                    complaintLabel: "Chief Complaint (Symptoms/Injury)",
                    vitalsHeading: "Initial Vitals", 
                    bpmLabel: "BPM (Heart Rate)", 
                    bpLabel: "Blood Pressure (Sys/Dia)", 
                    paramedicLabel: "Paramedic/Sending Team Name", 
                    priorityLabel: "Triage Priority",
                    priorities: { low: "Low (Scheduled/Stable)", medium: "Medium (Urgent)", high: "High (Critical)" },
                    submitBtn: "Log Patient Entry",
                    success: "Patient entry logged successfully. The Receiving team has been notified.",
                    error: "Error saving patient. Check console for details (Mock DB is active if no Firebase connection).",
                },
                receiving: {
                    heading: "Incoming Patients (Awaiting Triage)",
                    loading: "Loading patients...",
                    empty: "No patients currently awaiting triage.",
                    receiveBtn: "Assign Area & Move to Station", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time:",
                    submitter: "Submitted by:",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                },
                station: {
                    heading: "Active Patients (ICU & Recovery)",
                    capacity: "Capacity:",
                    icu: {
                        heading: "Intensive Care Unit (ICU)",
                        subtext: `Max ${CAPACITIES.icu} Rooms`
                    },
                    recovery: {
                        heading: "Recovery Room (Aufwachraum)",
                        subtext: `Max ${CAPACITIES.recovery} Beds`
                    },
                    loading: "Loading active patients...",
                    empty: "No patients currently assigned to this area.",
                    releaseBtn: "Release Patient / Archive", 
                    updateBtn: "Update Clinical Details",
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time at Station:",
                    submitter: "Triage/Assignment by:",
                    assignedStaff: "Assigned Staff:",
                    notes: "Clinical Notes:",
                    unassigned: "Unassigned",
                    vitals: "Vitals:", 
                    paramedic: "Paramedic:", 
                },
                archive: {
                    heading: "Archived/Discharged Patients",
                    loading: "Loading archived records...",
                    empty: "No patients currently in the archive.",
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Archived:",
                    dischargedBy: "Discharged by:", 
                    dischargeDate: "Discharge Date:", 
                    submitter: "Triage/Assignment by:", 
                    cleared: "Archive cleared successfully.",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                },
                contact: {
                    heading: "Contact Us",
                    addressTitle: "Our Location",
                    detailsTitle: "General Inquiries",
                    formTitle: "Send a Message",
                    namePlaceholder: "Your Name",
                    emailPlaceholder: "Your Email",
                    messagePlaceholder: "Your Message",
                    submitBtn: "Send Message",
                },
                modal: { 
                    dischargeTitle: "Confirm Patient Discharge",
                    staffLabel: "Staff Name (Doctor/Nurse)",
                    dateLabel: "Discharge Date",
                    cancelBtn: "Cancel",
                    confirmBtn: "Confirm & Archive",
                    dischargeFailed: "Discharge failed. Please check the form and try again.",
                    
                    areaTitle: "Assign Area to Patient",
                    targetLabel: "Select Station Area",
                    assignBtn: "Move to Station",
                    
                    notesTitle: "Update Clinical Details",
                    notesStaffLabel: "Assigned Staff Name (Free Text)",
                    notesNotesLabel: "Add/Edit Clinical Notes",
                    notesSaveBtn: "Save Details",
                },
                footer: {
                    rights: "All rights reserved."
                }
            },
            de: {
                title: "SAMS | Notfall Patientenfluss",
                slogan: "Echtzeit Klinische Aufnahme & Triage",
                userIdText: "Benutzer-ID:",
                nav: {
                    home: "Startseite",
                    patientEntry: "Patienteneingabe",
                    receiving: "Empfang",
                    station: "Stationsansicht",
                    archive: "Archiv",
                    contact: "Kontakt"
                },
                home: {
                    heading: "Willkommen beim SAMS Aufnahmesystem",
                    p1: "Diese Oberfläche dient der schnellen Patientenaufnahme und dem Triage-Management in der Notaufnahme. Bitte verwenden Sie den Reiter Patienteneingabe, um eintreffende Patienten sofort zu protokollieren.",
                    p2: "Der Empfangs-Reiter zeigt alle ausstehenden Patienten an, die auf eine klinische Zuweisung warten. Der Stations-Reiter verfolgt aktive Patienten in ICU/Aufwachraum, und das Archiv enthält entlassene Aufzeichnungen. Diese Listen werden in Echtzeit aktualisiert.",
                },
                patientEntry: {
                    heading: "Notfall Patientenschnelleingabe",
                    nameLabel: "Voller Name des Patienten",
                    dobLabel: "Geburtsdatum (Geb.)",
                    complaintLabel: "Hauptbeschwerde (Symptome/Verletzung)",
                    vitalsHeading: "Anfangsvitalwerte", 
                    bpmLabel: "BPM (Herzfrequenz)", 
                    bpLabel: "Blutdruck (Sys/Dia)", 
                    paramedicLabel: "Name des Notarztes/Teams", 
                    priorityLabel: "Triage-Priorität",
                    priorities: { low: "Niedrig (Geplant/Stabil)", medium: "Mittel (Dringend)", high: "Hoch (Kritisch)" },
                    submitBtn: "Patienteneintrag Protokollieren",
                    success: "Patienteneintrag erfolgreich protokolliert. Das Empfangsteam wurde benachrichtigt.",
                    error: "Fehler beim Speichern des Patienten. Überprüfen Sie die Konsole (Mock-Datenbank ist aktiv, wenn keine Firebase-Verbindung besteht).",
                },
                receiving: {
                    heading: "Eintreffende Patienten (Warten auf Triage)",
                    loading: "Patienten werden geladen...",
                    empty: "Derzeit warten keine Patienten auf die Triage.",
                    receiveBtn: "Bereich Zuweisen & Auf Station Verschieben", 
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit:",
                    submitter: "Eingereicht von:",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                },
                station: {
                    heading: "Aktive Patienten (ICU & Aufwachraum)",
                    capacity: "Kapazität:",
                    icu: {
                        heading: "Intensivstation (ICU)",
                        subtext: `Max ${CAPACITIES.icu} Räume`
                    },
                    recovery: {
                        heading: "Aufwachraum",
                        subtext: `Max ${CAPACITIES.recovery} Betten`
                    },
                    loading: "Aktive Patienten werden geladen...",
                    empty: "Derzeit ist kein Patient diesem Bereich zugewiesen.",
                    releaseBtn: "Patient Entlassen / Archiv",
                    updateBtn: "Klinische Details Aktualisieren",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit auf Station:",
                    submitter: "Triage/Zuweisung durch:",
                    assignedStaff: "Zugewiesener Mitarbeiter:",
                    notes: "Klinische Notizen:",
                    unassigned: "Nicht Zugewiesen",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                },
                archive: {
                    heading: "Archivierte/Entlassene Patienten",
                    loading: "Archivierte Aufzeichnungen werden geladen...",
                    empty: "Derzeit keine Patienten im Archiv.",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Archiviert:",
                    dischargedBy: "Entlassen durch:",
                    dischargeDate: "Entlassungsdatum:",
                    submitter: "Triage/Zuweisung durch:", 
                    cleared: "Archiv erfolgreich gelöscht.",
                    vitals: "Vitalwerte:", 
                    paramedic: "Notarzt/Team:", 
                },
                contact: {
                    heading: "Kontaktieren Sie uns",
                    addressTitle: "Unser Standort",
                    detailsTitle: "Allgemeine Anfragen",
                    formTitle: "Nachricht senden",
                    namePlaceholder: "Ihr Name",
                    emailPlaceholder: "Ihre E-Mail",
                    messagePlaceholder: "Ihre Nachricht",
                    submitBtn: "Nachricht senden",
                },
                modal: { 
                    dischargeTitle: "Bestätigung der Patientenentlassung",
                    staffLabel: "Mitarbeitername (Arzt/Krankenschwester)",
                    dateLabel: "Entlassungsdatum",
                    cancelBtn: "Abbrechen",
                    confirmBtn: "Bestätigen & Archivieren",
                    dischargeFailed: "Entlassung fehlgeschlagen. Bitte überprüfen Sie das Formular und versuchen Sie es erneut.",

                    areaTitle: "Bereich zuweisen",
                    targetLabel: "Stationsbereich auswählen",
                    assignBtn: "Auf Station Verschieben",

                    notesTitle: "Klinische Details Aktualisieren",
                    notesStaffLabel: "Zugewiesener Mitarbeitername (Freitext)",
                    notesNotesLabel: "Klinische Notizen Hinzufügen/Bearbeiten",
                    notesSaveBtn: "Details Speichern",
                },
                footer: {
                    rights: "Alle Rechte vorbehalten."
                }
            }
        };

        // --- Core Application State & Logic ---
        
        const tabs = ['home', 'patientEntry', 'receiving', 'station', 'archive', 'contact'];
        
        // Load initial state from localStorage or use defaults
        const savedLang = localStorage.getItem('samsAppLanguage');
        const savedTab = localStorage.getItem('samsAppActiveTab');

        let currentState = {
            // Load language, default to 'en' if not found or invalid
            language: (savedLang && dictionary[savedLang]) ? savedLang : 'en', 
            // Load active tab, default to 'home' if not found or invalid
            activeTab: (savedTab && tabs.includes(savedTab)) ? savedTab : 'home'
        };
        
        // Utility to format date to YYYY-MM-DD
        const getTodayDateString = () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        // Utility to safely retrieve DOM elements
        const getEl = (id) => document.getElementById(id);

        /**
         * Renders the UI elements based on the current state (language and activeTab).
         */
        function render() {
            const lang = currentState.language;
            const content = dictionary[lang];
            const activeTab = currentState.activeTab;

            // 1. Update Global Text Elements
            document.title = content.title;
            getEl('header-slogan').textContent = content.slogan;
            getEl('page-title').textContent = content.title.split(' | ')[0];
            getEl('current-lang-text').textContent = lang.toUpperCase();
            getEl('user-id-text').textContent = content.userIdText;
            
            // Update User ID Display
            const userIdDisplay = getEl('user-id-display');
            if(userIdDisplay) {
                userIdDisplay.textContent = userId || 'Loading...';
            }

            // 2. Determine if Receiving Tab needs to blink (unreceived patients exist)
            const shouldBlink = activeTab !== 'receiving' && receivingPatients.length > 0;

            // 3. Render Navigation Tabs
            const tabNav = getEl('tab-nav');
            tabNav.innerHTML = tabs.map(tab => {
                const isActive = tab === activeTab;
                let baseClasses = "tab-btn px-3 py-2 sm:px-4 sm:py-2 text-sm font-medium rounded-lg transition duration-200 cursor-pointer whitespace-nowrap";
                let activeClasses = "bg-blue-600 text-white shadow-lg";
                let inactiveClasses = "text-gray-700 hover:bg-gray-100";
                
                // Add blinking class if conditions met
                if (tab === 'receiving' && shouldBlink) {
                    baseClasses += ' blinking-red';
                    inactiveClasses = "text-red-800 hover:bg-red-50"; 
                    activeClasses = "bg-red-700 text-white shadow-lg"; // Make active red too
                }

                return `<button 
                    class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}" 
                    data-tab="${tab}" 
                    onclick="window.switchTab('${tab}')">${content.nav[tab]}
                ${tab === 'receiving' && receivingPatients.length > 0 ? `<span class="ml-2 inline-flex items-center justify-center h-5 w-5 rounded-full bg-white text-xs font-bold ${shouldBlink ? 'text-red-700' : 'text-blue-600'}">${receivingPatients.length}</span>` : ''}
                </button>`;
            }).join(''); 

            // 4. Show/Hide Content and Render Tab Specific Content
            tabs.forEach(tab => {
                const tabEl = getEl(`tab-${tab}`);
                if (tabEl) {
                    tabEl.classList.toggle('hidden', tab !== activeTab);
                }
            });

            // Home Content
            getEl('home-heading').textContent = content.home.heading;
            getEl('home-paragraph-1').textContent = content.home.p1;
            getEl('home-paragraph-2').textContent = content.home.p2;
            
            // Patient Entry Content
            renderPatientEntryForm(content.patientEntry);

            // Receiving, Station, Archive Content
            renderPatientLists();
            
            // Contact Content
            getEl('contact-heading').innerHTML = `<span data-lucide="mail" class="w-6 h-6 mr-2 text-gray-600"></span> ${content.contact.heading}`;
            getEl('contact-address-title').textContent = content.contact.addressTitle;
            getEl('contact-details-title').textContent = content.contact.detailsTitle;
            getEl('contact-form-title').textContent = content.contact.formTitle;
            getEl('contact-name-placeholder').placeholder = content.contact.namePlaceholder;
            getEl('contact-email-placeholder').placeholder = content.contact.emailPlaceholder;
            getEl('contact-message-placeholder').placeholder = content.contact.messagePlaceholder;
            getEl('contact-submit-btn').textContent = content.contact.submitBtn;

            // Modal Content (Discharge)
            getEl('modal-title').innerHTML = `<span data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></span> ${content.modal.dischargeTitle}`;
            getEl('modal-staff-label').textContent = content.modal.staffLabel;
            getEl('modal-date-label').textContent = content.modal.dateLabel;
            getEl('modal-cancel-btn').textContent = content.modal.cancelBtn;
            getEl('modal-confirm-btn').textContent = content.modal.confirmBtn;
            getEl('discharge-date').value = getTodayDateString();

            // Modal Content (Area Assignment)
            getEl('area-modal-title').innerHTML = `<span data-lucide="link" class="w-6 h-6 mr-2 text-red-700"></span> ${content.modal.areaTitle}`;
            getEl('area-modal-target-label').textContent = content.modal.targetLabel;
            getEl('area-option-recovery').textContent = content.station.recovery.heading;
            getEl('area-option-icu').textContent = content.station.icu.heading;
            getEl('area-modal-cancel-btn').textContent = content.modal.cancelBtn;
            getEl('area-modal-confirm-btn').textContent = content.modal.assignBtn;

            // Modal Content (Staff & Notes)
            getEl('staff-notes-modal-title').innerHTML = `<span data-lucide="clipboard-edit" class="w-6 h-6 mr-2 text-blue-800"></span> ${content.modal.notesTitle}`;
            getEl('staff-notes-staff-label').textContent = content.modal.notesStaffLabel;
            getEl('staff-notes-notes-label').textContent = content.modal.notesNotesLabel;
            getEl('staff-notes-cancel-btn').textContent = content.modal.cancelBtn;
            getEl('staff-notes-confirm-btn').textContent = content.modal.notesSaveBtn;

            // Footer Content
            getEl('footer-year').textContent = new Date().getFullYear();
            getEl('footer-rights').textContent = content.footer.rights;

            // Replace Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * Renders the input fields and buttons for the Patient Entry form based on the current language.
         * @param {Object} content - The language specific text for the patient entry section.
         */
        function renderPatientEntryForm(content) {
            getEl('patientEntry-heading').innerHTML = `<span data-lucide="user-plus" class="w-6 h-6 mr-2 text-green-600"></span> ${content.heading}`;
            getEl('p-name-label').textContent = content.nameLabel;
            getEl('p-dob-label').textContent = content.dobLabel;
            getEl('p-complaint-label').textContent = content.complaintLabel;
            getEl('vitals-heading').innerHTML = `<span data-lucide="heart-pulse" class="w-5 h-5 mr-2 text-red-500"></span> ${content.vitalsHeading}`;
            getEl('p-bpm-label').textContent = content.bpmLabel;
            getEl('p-bp-label').textContent = content.bpLabel;
            getEl('p-paramedic-label').textContent = content.paramedicLabel;
            getEl('p-priority-label').textContent = content.priorityLabel;
            getEl('patientEntry-submit-btn').textContent = content.submitBtn;

            // Populate Priority Select
            const prioritySelect = getEl('p-priority');
            prioritySelect.innerHTML = Object.keys(content.priorities).map(key => {
                return `<option value="${key}">${content.priorities[key]}</option>`;
            }).join('');
        }

        /**
         * Handles switching the active tab and saves the state.
         * @param {string} tabId - The ID of the tab to switch to.
         */
        window.switchTab = (tabId) => {
            if (currentState.activeTab !== tabId && tabs.includes(tabId)) {
                currentState.activeTab = tabId;
                localStorage.setItem('samsAppActiveTab', tabId);
                render();
            }
        };

        /**
         * Toggles the language between English ('en') and German ('de').
         */
        window.toggleLanguage = () => {
            const newLang = currentState.language === 'en' ? 'de' : 'en';
            currentState.language = newLang;
            localStorage.setItem('samsAppLanguage', newLang);
            render();
        };

        /**
         * Utility function to retry a promise with exponential backoff.
         * @param {Function} fn - The function returning a Promise.
         * @param {number} maxRetries - Maximum number of retries.
         * @param {number} delay - Initial delay in milliseconds.
         * @returns {Promise<any>}
         */
        async function retryWithBackoff(fn, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Re-throw if last retry failed
                    }
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
        }

        // --- Firebase and Data Management ---

        /**
         * Initializes Firebase and Firestore instances.
         */
        function initFirebase() {
            if (firebaseConfig && Object.keys(firebaseConfig).length > 0) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase Initialized.");
                    return true;
                } catch (e) {
                    console.error("Firebase initialization failed, falling back to Mock DB:", e);
                    useMockDb = true;
                    return false;
                }
            } else {
                console.warn("Firebase config missing. Using Mock DB.");
                useMockDb = true;
                return false;
            }
        }

        /**
         * Sets up Firebase authentication.
         */
        async function setupAuth() {
            if (useMockDb) {
                userId = 'MOCK_USER_' + Math.random().toString(16).slice(2);
                isAuthReady = true;
                subscribeToPatients(); // Start mock data subscription
                render();
                return;
            }
            
            try {
                if (initialAuthToken) {
                    await retryWithBackoff(() => signInWithCustomToken(auth, initialAuthToken));
                    console.log("Signed in with custom token.");
                } else {
                    await retryWithBackoff(() => signInAnonymously(auth));
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Authentication failed:", error);
            }

            // Setup auth state listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    userId = 'anonymous';
                }
                isAuthReady = true;
                subscribeToPatients();
                render();
            });
        }

        /**
         * Sets up a real-time listener to the 'patients' collection.
         */
        function subscribeToPatients() {
            if (!isAuthReady) return;

            if (useMockDb) {
                // Initialize with mock data if needed (for demonstration)
                if (mockPatients.length === 0) {
                    mockPatients = [
                        createMockPatient('Emily Johnson', 'high', 'Severe chest pain and shortness of breath.', 'EMT Alpha'),
                        createMockPatient('Michael Brown', 'medium', 'Deep laceration on forearm, uncontrolled bleeding.', 'Ambulance 7'),
                        createMockPatient('Sophia Lee', 'low', 'Sprained ankle from sports injury.', 'Self-Admitted'),
                    ];
                    // Assign some mock patients directly to station areas
                    mockPatients.push({
                        ...createMockPatient('John Doe', 'medium', 'Fever, cough, and fatigue.', 'Paramedic 1'),
                        status: 'station',
                        area: 'recovery',
                        stationTime: new Date(Date.now() - 600000),
                        assignedStaff: 'Nurse Jane'
                    });
                    mockPatients.push({
                        ...createMockPatient('Anna Green', 'high', 'Post-op observation.', 'OR Team'),
                        status: 'station',
                        area: 'icu',
                        stationTime: new Date(Date.now() - 1200000),
                        assignedStaff: 'Dr. Smith'
                    });
                }
                processPatientData(mockPatients);
                return;
            }

            // Firestore Collection path: /artifacts/{appId}/public/data/patients
            const patientsRef = collection(db, `artifacts/${appId}/public/data/patients`);
            const q = query(patientsRef); // Get all documents

            onSnapshot(q, (snapshot) => {
                console.log("Firestore update received.");
                allPatients = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Convert Timestamp to JS Date if necessary
                    entryTime: doc.data().entryTime?.toDate ? doc.data().entryTime.toDate() : doc.data().entryTime,
                    stationTime: doc.data().stationTime?.toDate ? doc.data().stationTime.toDate() : doc.data().stationTime,
                    dischargeTime: doc.data().dischargeTime?.toDate ? doc.data().dischargeTime.toDate() : doc.data().dischargeTime,
                }));
                processPatientData(allPatients);
            }, (error) => {
                console.error("Firestore subscription failed:", error);
            });
        }

        /**
         * Filters and sorts the patients into their respective lists and triggers a re-render.
         * @param {Array} patients - The full list of patients.
         */
        function processPatientData(patients) {
            // Sort by priority (High > Medium > Low) and then by entry time (oldest first)
            const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };
            
            patients.sort((a, b) => {
                // 1. Compare by Priority
                const priorityA = priorityOrder[a.priority.toLowerCase()] || 4;
                const priorityB = priorityOrder[b.priority.toLowerCase()] || 4;
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                // 2. If priorities are equal, compare by entry time (ascending)
                return new Date(a.entryTime).getTime() - new Date(b.entryTime).getTime();
            });

            // Filter into lists based on status and area
            receivingPatients = patients.filter(p => p.status === 'receiving');
            recoveryPatients = patients.filter(p => p.status === 'station' && p.area === 'recovery');
            icuPatients = patients.filter(p => p.status === 'station' && p.area === 'icu');
            archivedPatients = patients.filter(p => p.status === 'archived');
            
            // Re-combine station patients for general data consistency if needed, but not used directly
            // stationPatients = recoveryPatients.concat(icuPatients); 
            
            render();
        }

        /**
         * Saves a new patient record to the database (or mock database).
         * @param {Object} patientData - The data for the new patient.
         */
        async function savePatient(patientData) {
            const record = {
                ...patientData,
                status: 'receiving', // Initial status
                area: null,         // New field: Initial area is null
                notes: '',          // New field: Initial notes are empty
                entryTime: useMockDb ? new Date() : serverTimestamp(),
                submittedBy: userId,
            };

            try {
                if (useMockDb) {
                    record.id = crypto.randomUUID(); // Add mock ID
                    mockPatients.push(record);
                    processPatientData(mockPatients); // Manually trigger update
                } else {
                    const patientsRef = collection(db, `artifacts/${appId}/public/data/patients`);
                    await retryWithBackoff(() => addDoc(patientsRef, record));
                }
                return true;
            } catch (e) {
                console.error("Error saving patient:", e);
                return false;
            }
        }

        /**
         * Updates the status and other fields of an existing patient record.
         * @param {string} patientId - The ID of the patient document.
         * @param {Object} fieldsToUpdate - Object containing the fields to update.
         */
        async function updatePatientStatus(patientId, fieldsToUpdate) {
            try {
                if (useMockDb) {
                    const index = mockPatients.findIndex(p => p.id === patientId);
                    if (index !== -1) {
                        mockPatients[index] = { ...mockPatients[index], ...fieldsToUpdate };
                        processPatientData(mockPatients); // Manually trigger update
                    }
                } else {
                    const patientDocRef = doc(db, `artifacts/${appId}/public/data/patients`, patientId);
                    await retryWithBackoff(() => updateDoc(patientDocRef, fieldsToUpdate));
                }
                return true;
            } catch (e) {
                console.error("Error updating patient status:", e);
                return false;
            }
        }

        // --- UI Utility Functions ---

        /**
         * Returns Tailwind CSS classes for a given priority level.
         * @param {string} priority - The priority level ('low', 'medium', 'high').
         * @returns {string} Tailwind classes for badge and border.
         */
        function getPriorityClasses(priority) {
            switch (priority?.toLowerCase()) {
                case 'high':
                    return { badge: 'bg-red-500 text-white', border: 'border-l-4 border-red-600' };
                case 'medium':
                    return { badge: 'bg-yellow-500 text-gray-900', border: 'border-l-4 border-yellow-600' };
                case 'low':
                    return { badge: 'bg-green-500 text-white', border: 'border-l-4 border-green-600' };
                default:
                    return { badge: 'bg-gray-400 text-white', border: 'border-l-4 border-gray-500' };
            }
        }

        /**
         * Formats a time difference into a readable "X min/hr ago" string.
         * @param {Date | number} timestamp - The starting date/time object.
         * @returns {string} Formatted time string.
         */
        function formatTimeSince(timestamp) {
            if (!timestamp) return 'N/A';
            const start = new Date(timestamp).getTime();
            const now = new Date().getTime();
            const seconds = Math.floor((now - start) / 1000);
            
            // Get the localized label for time (e.g., "Time:", "Zeit:") and strip extra space/colon
            const timeLabel = dictionary[currentState.language].receiving.time.replace(/Time:|Zeit:/, '').trim();

            if (seconds < 60) {
                return `${timeLabel}: ${seconds}s`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                return `${timeLabel}: ${minutes}m`;
            } else {
                const hours = Math.floor(seconds / 3600);
                return `${timeLabel}: ${hours}h`;
            }
        }

        /**
         * Utility to create mock patient data (for mock DB mode).
         */
        function createMockPatient(name, priority, complaint, paramedic) {
            return {
                id: crypto.randomUUID(),
                name: name,
                dob: '1985-01-15',
                complaint: complaint,
                bpm: Math.floor(Math.random() * (120 - 60 + 1)) + 60,
                bp: `${Math.floor(Math.random() * (140 - 90 + 1)) + 90}/${Math.floor(Math.random() * (90 - 60 + 1)) + 60}`,
                paramedic: paramedic,
                priority: priority,
                status: 'receiving',
                area: null,
                notes: '',
                entryTime: new Date(Date.now() - Math.floor(Math.random() * 3600000)), // up to 1 hour ago
                submittedBy: 'System',
            };
        }

        // --- Patient Card Rendering ---

        /**
         * Generates the HTML for a single patient card based on its status.
         * @param {Object} patient - The patient data object.
         * @param {Object} langContent - The language content object for the current tab.
         * @returns {string} The HTML string for the patient card.
         */
        function renderPatientCard(patient, langContent) {
            const { badge, border } = getPriorityClasses(patient.priority);
            const isReceiving = patient.status === 'receiving';
            const isStation = patient.status === 'station';
            const isArchive = patient.status === 'archived';
            
            const timeField = isArchive ? langContent.time.replace('Archived:', '').trim() : langContent.time.replace(/Time at Station:|Time:/, '').trim();
            const timeValue = isArchive ? (patient.dischargeTime ? new Date(patient.dischargeTime).toLocaleString() : 'N/A') : formatTimeSince(isStation ? patient.stationTime : patient.entryTime);
            
            const staffNotesHtml = isStation ? `
                <div class="mt-3 pt-3 border-t border-gray-100 space-y-2">
                    <div class="text-sm font-semibold text-gray-700">
                        ${langContent.assignedStaff}
                        <span class="font-normal text-blue-600">${patient.assignedStaff || langContent.unassigned}</span>
                    </div>
                    <p class="text-sm text-gray-500">
                        <span class="font-semibold text-gray-700">${langContent.notes}</span> ${patient.notes || 'No notes added.'}
                    </p>
                </div>
                <div class="flex justify-end mt-4">
                    <button onclick="window.openStaffNotesModal('${patient.id}', '${patient.name}', '${patient.assignedStaff || ''}', '${patient.notes || ''}')" class="text-xs font-medium px-3 py-1 rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200 transition duration-200 flex items-center">
                        <span data-lucide="clipboard-edit" class="w-4 h-4 mr-1"></span> ${langContent.updateBtn}
                    </button>
                </div>
            ` : '';


            const actionButtonHtml = isReceiving ? `
                <button onclick="window.openAreaAssignmentModal('${patient.id}', '${patient.name}')" class="w-full sm:w-auto bg-red-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-red-700 transition duration-200 flex items-center justify-center shadow-md">
                    <span data-lucide="chevrons-right" class="w-5 h-5 mr-2"></span> ${langContent.receiveBtn}
                </button>
            ` : isStation ? `
                <button onclick="window.openDischargeModal('${patient.id}', '${patient.name}')" class="w-full sm:w-auto bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-200 flex items-center justify-center shadow-md">
                    <span data-lucide="archive" class="w-5 h-5 mr-2"></span> ${langContent.releaseBtn}
                </button>
            ` : '';

            const archiveDetailsHtml = isArchive ? `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-500 mt-3 pt-3 border-t border-gray-100">
                    <div><span class="font-medium">${langContent.dischargedBy}</span> ${patient.dischargedBy || 'N/A'}</div>
                    <div><span class="font-medium">${langContent.dischargeDate}</span> ${patient.dischargeDate || 'N/A'}</div>
                </div>
                ${patient.notes ? `<p class="text-sm text-gray-500 mt-2"><span class="font-semibold text-gray-700">${langContent.notes}</span> ${patient.notes}</p>` : ''}
            ` : '';

            return `
                <div class="bg-white p-5 rounded-xl shadow-md hover:shadow-lg transition duration-300 ${border}">
                    <div class="flex justify-between items-start mb-3">
                        <!-- Patient Name & DOB -->
                        <div>
                            <h3 class="text-xl font-bold text-gray-900">${patient.name}</h3>
                            <p class="text-xs text-gray-500 mt-1">DOB: ${patient.dob} | ID: ${patient.id.substring(0, 8)}...</p>
                        </div>
                        <!-- Priority Badge -->
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${badge} shadow-sm whitespace-nowrap">
                            ${langContent.priority} ${patient.priority.toUpperCase()}
                        </span>
                    </div>

                    <!-- Details -->
                    <div class="text-sm space-y-2 mt-2">
                        <p><span class="font-medium text-gray-700">${langContent.complaint}</span> ${patient.complaint}</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-gray-500">
                            <p><span class="font-medium">${langContent.vitals}</span> ${patient.bpm || '?'} BPM, ${patient.bp || '??/??'} BP</p>
                            <p><span class="font-medium">${langContent.paramedic}</span> ${patient.paramedic}</p>
                            <p><span class="font-medium">${timeField}</span> ${timeValue}</p>
                            ${isArchive ? '' : `<p><span class="font-medium">${langContent.submitter}</span> ${patient.submittedBy || 'N/A'}</p>`}
                        </div>
                    </div>
                    
                    ${staffNotesHtml}
                    ${archiveDetailsHtml}
                    
                    <!-- Action Button (only for receiving and archive) -->
                    ${!isStation ? `<div class="mt-4 flex justify-end">${actionButtonHtml}</div>` : ''}
                </div>
            `;
        }

        /**
         * Renders the lists for Receiving, Station, and Archive tabs.
         */
        function renderPatientLists() {
            if (!isAuthReady) return;

            const lang = currentState.language;
            const content = dictionary[lang];
            const stationContent = content.station;

            // --- Receiving List ---
            getEl('receiving-heading').innerHTML = `<span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-red-600"></span> ${content.receiving.heading}`;
            const receivingContainer = getEl('receiving-list-container');
            if (receivingPatients.length === 0) {
                receivingContainer.innerHTML = `<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">${content.receiving.empty}</p>`;
            } else {
                receivingContainer.innerHTML = receivingPatients.map(p => renderPatientCard(p, content.receiving)).join('');
            }

            // --- Station List (ICU & Recovery) ---
            getEl('station-heading').innerHTML = `<span data-lucide="hospital" class="w-6 h-6 mr-2 text-blue-600"></span> ${stationContent.heading}`;
            
            // Render Capacity Display
            const recoveryCount = recoveryPatients.length;
            const icuCount = icuPatients.length;
            
            getEl('capacity-display').innerHTML = `
                <div class="p-4 rounded-xl shadow-lg border-l-4 ${recoveryCount >= CAPACITIES.recovery ? 'border-red-500 bg-red-50' : 'border-green-500 bg-green-50'}">
                    <div class="flex items-center justify-between">
                        <h4 class="text-lg font-bold ${recoveryCount >= CAPACITIES.recovery ? 'text-red-700' : 'text-green-700'}">${stationContent.recovery.heading}</h4>
                        <span class="text-sm font-medium text-gray-500">${stationContent.recovery.subtext}</span>
                    </div>
                    <div class="text-4xl font-extrabold mt-2 ${recoveryCount >= CAPACITIES.recovery ? 'text-red-600' : 'text-green-600'}">${recoveryCount} / ${CAPACITIES.recovery}</div>
                    <p class="text-xs mt-1 ${recoveryCount >= CAPACITIES.recovery ? 'text-red-500' : 'text-green-500'}">${recoveryCount >= CAPACITIES.recovery ? 'Capacity Reached!' : 'Available'}</p>
                </div>
                <div class="p-4 rounded-xl shadow-lg border-l-4 ${icuCount >= CAPACITIES.icu ? 'border-red-500 bg-red-50' : 'border-blue-500 bg-blue-50'}">
                    <div class="flex items-center justify-between">
                        <h4 class="text-lg font-bold ${icuCount >= CAPACITIES.icu ? 'text-red-700' : 'text-blue-700'}">${stationContent.icu.heading}</h4>
                        <span class="text-sm font-medium text-gray-500">${stationContent.icu.subtext}</span>
                    </div>
                    <div class="text-4xl font-extrabold mt-2 ${icuCount >= CAPACITIES.icu ? 'text-red-600' : 'text-blue-600'}">${icuCount} / ${CAPACITIES.icu}</div>
                    <p class="text-xs mt-1 ${icuCount >= CAPACITIES.icu ? 'text-red-500' : 'text-blue-500'}">${icuCount >= CAPACITIES.icu ? 'Capacity Reached!' : 'Available'}</p>
                </div>
            `;
            
            // Render Recovery List
            getEl('recovery-heading').innerHTML = `<span data-lucide="bed" class="w-5 h-5 mr-2"></span> ${stationContent.recovery.heading}`;
            const recoveryContainer = getEl('recovery-list-container');
            if (recoveryPatients.length === 0) {
                recoveryContainer.innerHTML = `<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">${stationContent.empty}</p>`;
            } else {
                recoveryContainer.innerHTML = recoveryPatients.map(p => renderPatientCard(p, stationContent)).join('');
            }
            
            // Render ICU List
            getEl('icu-heading').innerHTML = `<span data-lucide="heart-pulse" class="w-5 h-5 mr-2"></span> ${stationContent.icu.heading}`;
            const icuContainer = getEl('icu-list-container');
            if (icuPatients.length === 0) {
                icuContainer.innerHTML = `<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">${stationContent.empty}</p>`;
            } else {
                icuContainer.innerHTML = icuPatients.map(p => renderPatientCard(p, stationContent)).join('');
            }

            // --- Archive List ---
            getEl('archive-heading').innerHTML = `<span data-lucide="archive" class="w-6 h-6 mr-2 text-gray-600"></span> ${content.archive.heading}`;
            const archiveContainer = getEl('archive-list-container');
            const sortedArchive = [...archivedPatients].sort((a, b) => new Date(b.dischargeTime || 0).getTime() - new Date(a.dischargeTime || 0).getTime());
            
            if (sortedArchive.length === 0) {
                archiveContainer.innerHTML = `<p class="text-center text-gray-500 p-8 border border-dashed rounded-lg">${content.archive.empty}</p>`;
            } else {
                archiveContainer.innerHTML = sortedArchive.map(p => renderPatientCard(p, content.archive)).join('');
            }
            
            // Re-render Lucide icons after DOM update
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // --- Action Handlers ---

        /**
         * Handles the submission of a new patient entry.
         */
        async function handlePatientEntrySubmit(event) {
            event.preventDefault();
            const msgBox = getEl('patient-message-box');
            const submitBtn = getEl('patientEntry-submit-btn');
            const langContent = dictionary[currentState.language].patientEntry;

            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
            msgBox.classList.add('hidden');

            const patientData = {
                name: getEl('p-name').value.trim(),
                dob: getEl('p-dob').value,
                complaint: getEl('p-complaint').value.trim(),
                bpm: getEl('p-bpm').value.trim(),
                bp: getEl('p-bp').value.trim(),
                paramedic: getEl('p-paramedic').value.trim(),
                priority: getEl('p-priority').value.trim(),
            };

            const success = await savePatient(patientData);

            if (success) {
                msgBox.textContent = langContent.success;
                msgBox.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-800';
                event.target.reset(); // Clear form on success
                window.switchTab('receiving'); // Auto-switch to receiving view
            } else {
                msgBox.textContent = langContent.error;
                msgBox.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-800';
            }
            
            msgBox.classList.remove('hidden');
            submitBtn.disabled = false;
            submitBtn.textContent = langContent.submitBtn;
        }

        // --- Modal Logic ---
        
        /**
         * Generic function to open a modal.
         * @param {string} modalId - The ID of the modal div.
         */
        function openModal(modalId) {
            const modal = getEl(modalId);
            modal.classList.remove('hidden', 'opacity-0');
            modal.classList.add('opacity-100');
        }

        /**
         * Generic function to close a modal.
         * @param {string} modalId - The ID of the modal div.
         */
        window.closeModal = (modalId) => {
            const modal = getEl(modalId);
            modal.classList.remove('opacity-100');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); // Wait for transition
        };

        /**
         * Opens the discharge modal.
         */
        window.openDischargeModal = (id, name) => {
            dischargeModalPatientId = id;
            const langContent = dictionary[currentState.language].modal;

            getEl('modal-patient-name').textContent = `${langContent.confirmBtn.split(' ')[0]} ${name}?`;
            getEl('discharge-date').value = getTodayDateString(); // Set today's date
            getEl('discharge-staff-name').value = ''; // Clear staff name
            
            openModal('discharge-modal');
        };

        /**
         * Handles the final discharge and archiving process.
         */
        async function handleDischargeSubmit(event) {
            event.preventDefault();
            
            if (!dischargeModalPatientId) return;

            const staffName = getEl('discharge-staff-name').value.trim();
            const dischargeDate = getEl('discharge-date').value;
            const confirmBtn = getEl('modal-confirm-btn');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Processing...';

            const success = await updatePatientStatus(dischargeModalPatientId, {
                status: 'archived',
                dischargeTime: useMockDb ? new Date() : serverTimestamp(),
                dischargedBy: staffName,
                dischargeDate: dischargeDate,
            });

            if (success) {
                window.closeModal('discharge-modal');
                window.switchTab('archive');
            } else {
                console.error("Discharge attempt failed.");
            }
            
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
            dischargeModalPatientId = null;
        }

        /**
         * Opens the Area Assignment Modal.
         * @param {string} id - Patient ID.
         * @param {string} name - Patient Name.
         */
        window.openAreaAssignmentModal = (id, name) => {
            areaModalPatientId = id;
            const langContent = dictionary[currentState.language].modal;
            
            getEl('area-modal-patient-name').textContent = `${langContent.assignBtn.split(' ')[0]} ${name}:`;
            getEl('target-area').value = 'recovery'; // Default selection

            openModal('area-assignment-modal');
        };

        /**
         * Handles the submission of the Area Assignment Modal.
         */
        async function handleAreaAssignmentSubmit(event) {
            event.preventDefault();
            if (!areaModalPatientId) return;

            const targetArea = getEl('target-area').value;
            const confirmBtn = getEl('area-modal-confirm-btn');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Moving...';

            // Check capacity before moving
            const currentCount = targetArea === 'icu' ? icuPatients.length : recoveryPatients.length;
            const maxCapacity = CAPACITIES[targetArea];

            if (currentCount >= maxCapacity) {
                alert(`Cannot move patient: ${targetArea.toUpperCase()} capacity is full (${maxCapacity} / ${maxCapacity}).`);
                confirmBtn.disabled = false;
                confirmBtn.textContent = originalText;
                return;
            }

            const success = await updatePatientStatus(areaModalPatientId, {
                status: 'station',
                area: targetArea,
                stationTime: useMockDb ? new Date() : serverTimestamp(),
                assignedBy: userId,
                assignedStaff: 'Unassigned',
                notes: '',
            });

            if (success) {
                window.closeModal('area-assignment-modal');
                window.switchTab('station');
            } else {
                console.error("Area assignment failed.");
            }

            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
            areaModalPatientId = null;
        }

        /**
         * Opens the Staff & Notes Modal.
         * @param {string} id - Patient ID.
         * @param {string} name - Patient Name.
         * @param {string} currentStaff - Current staff name (or 'Unassigned').
         * @param {string} currentNotes - Current clinical notes.
         */
        window.openStaffNotesModal = (id, name, currentStaff, currentNotes) => {
            staffNotesModalPatientId = id;
            const langContent = dictionary[currentState.language].modal;

            getEl('staff-notes-modal-patient-name').textContent = `${langContent.notesTitle.split(' ')[0]} ${name}:`;
            
            // Populate fields
            getEl('update-staff-name').value = currentStaff === 'Unassigned' ? '' : currentStaff;
            getEl('update-notes').value = currentNotes;
            
            openModal('staff-notes-modal');
        };
        
        /**
         * Handles the submission of the Staff & Notes Modal.
         */
        async function handleStaffNotesSubmit(event) {
            event.preventDefault();
            if (!staffNotesModalPatientId) return;

            const staffName = getEl('update-staff-name').value.trim() || 'Unassigned';
            const clinicalNotes = getEl('update-notes').value.trim();
            const confirmBtn = getEl('staff-notes-confirm-btn');
            const originalText = confirmBtn.textContent;
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Saving...';

            const success = await updatePatientStatus(staffNotesModalPatientId, {
                assignedStaff: staffName,
                notes: clinicalNotes,
            });

            if (success) {
                window.closeModal('staff-notes-modal');
                render(); // Force re-render just to be sure, although onSnapshot should handle it
            } else {
                console.error("Staff/Notes update failed.");
            }

            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
            staffNotesModalPatientId = null;
        }


        // --- Initialization and Event Wiring ---

        window.onload = () => {
            // 1. Global Setup
            initFirebase();
            setupAuth(); // This triggers subscribeToPatients and initial render

            // 2. Attach Event Listeners
            getEl('language-toggle').addEventListener('click', window.toggleLanguage);
            getEl('patient-entry-form').addEventListener('submit', handlePatientEntrySubmit);
            getEl('discharge-form').addEventListener('submit', handleDischargeSubmit);
            getEl('area-assignment-form').addEventListener('submit', handleAreaAssignmentSubmit);
            getEl('staff-notes-form').addEventListener('submit', handleStaffNotesSubmit);
            
            // Prevent contact form submission
            const contactForm = getEl('tab-contact').querySelector('form');
            contactForm.addEventListener('submit', (e) => { e.preventDefault(); console.log("Contact Message Sent (Simulated)"); }); 
        };

    </script>
</body>
</html>
