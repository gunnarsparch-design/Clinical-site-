<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAMS | Emergency Patient Flow</title>
    <!-- Load Firebase/Tailwind/Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font import for a professional look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Light gray background */
        }
        .main-container {
            min-height: calc(100vh - 80px); /* Account for header */
        }
        /* Custom focus state for accessibility */
        .tab-btn:focus, .lang-btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5); /* Blue ring */
        }
        /* CSS for the blinking effect */
        .blinking-red {
            animation: blink-animation 1s steps(5, start) infinite;
            background-color: #fecaca !important; /* Red-200 */
            color: #991b1b !important; /* Red-800 */
        }
        @keyframes blink-animation {
            to {
                visibility: hidden;
            }
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header & Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <!-- Logo/Brand -->
            <div class="flex items-center space-x-2">
                <div class="text-2xl font-extrabold text-blue-600">SAMS</div>
                <div id="header-slogan" class="text-sm text-gray-500 hidden sm:block"></div>
            </div>

            <div class="flex items-center space-x-4">
                <!-- User ID Display (Important for multi-user context) -->
                <div class="text-xs text-gray-500">
                    <span id="user-id-text">User ID:</span> <span id="user-id-display" class="font-mono text-gray-700">Loading...</span>
                </div>
                <!-- Language Toggle -->
                <button id="language-toggle" class="lang-btn flex items-center bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-3 rounded-lg transition duration-200 text-sm">
                    <span id="current-lang-text">EN</span>
                    <span data-lucide="globe" class="w-4 h-4 ml-2"></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="main-container max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Title -->
        <h1 id="page-title" class="text-3xl sm:text-4xl font-bold text-blue-800 mb-6 text-center"></h1>
        
        <!-- Tab Navigation (Desktop and Mobile) -->
        <div class="bg-white p-2 rounded-xl shadow-lg mb-8 overflow-x-auto">
            <nav id="tab-nav" class="flex space-x-1 sm:space-x-2 justify-center">
                <!-- Tab buttons will be inserted here by JavaScript -->
            </nav>
        </div>

        <!-- Dynamic Content Section -->
        <div id="content-container" class="space-y-8">
            
            <!-- Home/Start Content -->
            <div id="tab-home" class="tab-content bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-blue-600">
                <h2 id="home-heading" class="text-2xl font-semibold text-gray-900 mb-4"></h2>
                <p id="home-paragraph-1" class="text-gray-600 mb-4 leading-relaxed"></p>
                <p id="home-paragraph-2" class="text-gray-600 leading-relaxed"></p>
            </div>

            <!-- Patient Entry / Patienteneingabe Content -->
            <div id="tab-patientEntry" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-green-600">
                <h2 id="patientEntry-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="user-plus" class="w-6 h-6 mr-2 text-green-600"></span>
                </h2>
                
                <form id="patient-entry-form" class="space-y-4 max-w-lg mx-auto">
                    <div>
                        <label for="p-name" id="p-name-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <input type="text" id="p-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="p-dob" id="p-dob-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <input type="date" id="p-dob" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="p-complaint" id="p-complaint-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <textarea id="p-complaint" rows="3" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>
                    <div>
                        <label for="p-priority" id="p-priority-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                        <select id="p-priority" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 bg-white">
                            <!-- Options populated by JS render function -->
                        </select>
                    </div>
                    <button type="submit" id="patientEntry-submit-btn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-200 shadow-md"></button>
                    <div id="patient-message-box" class="mt-4 p-3 rounded-lg text-center hidden" role="alert"></div>
                </form>
            </div>

            <!-- Receiving / Empfang Content -->
            <div id="tab-receiving" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-red-600">
                <h2 id="receiving-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="clipboard-list" class="w-6 h-6 mr-2 text-red-600"></span>
                </h2>
                <div id="receiving-list-container" class="space-y-4">
                    <!-- Patient cards/loading/empty states will be rendered here by JS -->
                </div>
            </div>

            <!-- Station / Station Content -->
            <div id="tab-station" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-blue-600">
                <h2 id="station-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="hospital" class="w-6 h-6 mr-2 text-blue-600"></span>
                </h2>
                <div id="station-list-container" class="space-y-4">
                    <!-- Patient cards will be rendered here -->
                </div>
            </div>

            <!-- Archive / Archiv Content -->
            <div id="tab-archive" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-gray-400">
                <h2 id="archive-heading" class="text-2xl font-semibold text-gray-900 mb-6 flex items-center">
                    <span data-lucide="archive" class="w-6 h-6 mr-2 text-gray-600"></span>
                </h2>
                <div id="archive-list-container" class="space-y-4">
                    <!-- Patient cards will be rendered here -->
                </div>
            </div>

            <!-- Contact / Kontakt Content -->
            <div id="tab-contact" class="tab-content hidden bg-white p-6 sm:p-10 rounded-xl shadow-lg border-t-4 border-gray-600">
                <h2 id="contact-heading" class="text-2xl font-semibold text-gray-900 mb-4 flex items-center">
                    <span data-lucide="mail" class="w-6 h-6 mr-2 text-gray-600"></span>
                </h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 id="contact-address-title" class="font-bold text-lg text-gray-700 mb-2"></h3>
                        <p class="text-gray-600">
                            San Andres Medical Service (SAMS)<br>
                            123 Health Ave, San Andres City<br>
                            CA 90210, Country<br>
                        </p>
                    </div>
                    <div>
                        <h3 id="contact-details-title" class="font-bold text-lg text-gray-700 mb-2"></h3>
                        <p id="contact-phone" class="text-gray-600 mb-1">Phone: +1 555-SAMS-HELP</p>
                        <p id="contact-email" class="text-gray-600">Email: info@sams.com</p>
                    </div>
                </div>
                <div class="mt-8">
                    <h3 id="contact-form-title" class="font-bold text-lg text-gray-700 mb-4"></h3>
                    <form>
                        <input id="contact-name-placeholder" type="text" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <input id="contact-email-placeholder" type="email" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <textarea id="contact-message-placeholder" rows="4" placeholder="" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                        <button id="contact-submit-btn" type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                    </form>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-10 p-4">
        <div class="max-w-7xl mx-auto text-center text-sm">
            &copy; <span id="footer-year"></span> San Andres Medical Service (SAMS). <span id="footer-rights"></span>
        </div>
    </footer>

    <!-- Discharge Confirmation Modal -->
    <div id="discharge-modal" class="modal-backdrop hidden transition-opacity duration-300 opacity-0">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-95">
            <h3 id="modal-title" class="text-2xl font-bold text-blue-800 mb-4 flex items-center">
                <span data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></span>
            </h3>
            <p id="modal-patient-name" class="text-lg text-gray-700 mb-4"></p>
            
            <form id="discharge-form" class="space-y-4">
                <div>
                    <label for="discharge-staff-name" id="modal-staff-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="text" id="discharge-staff-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g. Dr. John Doe">
                </div>
                <div>
                    <label for="discharge-date" id="modal-date-label" class="block text-sm font-medium text-gray-700 mb-1"></label>
                    <input type="date" id="discharge-date" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="window.closeModal()" id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 font-medium rounded-lg hover:bg-gray-300 transition duration-200"></button>
                    <button type="submit" id="modal-confirm-btn" class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition duration-200 shadow-md"></button>
                </div>
            </form>
        </div>
    </div>
    <!-- End Discharge Confirmation Modal -->

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase Log Level to Debug
        setLogLevel('Debug');
        
        // --- Global Variables (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Core Application State & Logic ---
        
        let currentState = {
            language: 'en', // 'en' or 'de'
            activeTab: 'home' // 'home', 'patientEntry', 'receiving', 'station', 'archive', 'contact'
        };
        
        // State for the modal
        let modalPatientId = null;

        // All patients loaded from DB/Mock DB
        let allPatients = []; 
        // Derived lists for UI
        let receivingPatients = []; 
        let stationPatients = [];
        let archivedPatients = [];
        let mockPatients = []; // Mock database for when Firebase is unavailable

        // Mock Staff for assignment feature
        const mockStaff = [
            { id: 'DR101', name: 'Dr. Emily Carter', role: 'Doctor' },
            { id: 'DR102', name: 'Dr. Ben Jones', role: 'Doctor' },
            { id: 'NR201', name: 'Nurse Lisa Kim', role: 'Nurse' },
            { id: 'NR202', name: 'Nurse David Chen', role: 'Nurse' },
        ];

        // Firebase Instances
        let app, db, auth, userId = null;
        let isAuthReady = false;
        let useMockDb = false;

        const tabs = ['home', 'patientEntry', 'receiving', 'station', 'archive', 'contact'];
        
        // Utility to format date to YYYY-MM-DD
        const getTodayDateString = () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        };

        // Dictionary for multilingual content
        const dictionary = {
            en: {
                title: "SAMS | Emergency Patient Flow",
                slogan: "Real-time Clinical Intake & Triage",
                userIdText: "User ID:",
                nav: {
                    home: "Home",
                    patientEntry: "Patient Entry",
                    receiving: "Receiving",
                    station: "Station View",
                    archive: "Archive"
                },
                home: {
                    heading: "Welcome to SAMS Intake System",
                    p1: "This interface is designed for rapid patient entry and triage management in the Emergency Room. Please use the Patient Entry tab to log incoming patients immediately.",
                    p2: "The Receiving tab shows all pending patients awaiting clinical assignment. The Station tab tracks active patients, and the Archive tab holds discharged records. This list is updated in real-time.",
                },
                patientEntry: {
                    heading: "ER Patient Quick Entry",
                    nameLabel: "Patient Full Name",
                    dobLabel: "Date of Birth (DOB)",
                    complaintLabel: "Chief Complaint (Symptoms/Injury)",
                    priorityLabel: "Triage Priority",
                    priorities: { low: "Low (Scheduled/Stable)", medium: "Medium (Urgent)", high: "High (Critical)" },
                    submitBtn: "Log Patient Entry",
                    success: "Patient entry logged successfully. The Receiving team has been notified.",
                    error: "Error saving patient. Check console for details (Mock DB is active if no Firebase connection).",
                },
                receiving: {
                    heading: "Incoming Patients (Awaiting Triage)",
                    loading: "Loading patients...",
                    empty: "No patients currently awaiting triage.",
                    receiveBtn: "Move to Station", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time:",
                    submitter: "Submitted by:",
                },
                station: {
                    heading: "Active Patients (Assigned Station)",
                    loading: "Loading active patients...",
                    empty: "No patients currently assigned to a station.",
                    releaseBtn: "Release Patient / Archive", 
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Time at Station:",
                    submitter: "Triage/Assignment by:",
                    assigned: "Assigned:",
                    assignBtn: "Assign Staff",
                    unassigned: "Unassigned"
                },
                archive: {
                    heading: "Archived/Discharged Patients",
                    loading: "Loading archived records...",
                    empty: "No patients currently in the archive.",
                    priority: "Priority:",
                    complaint: "Complaint:",
                    time: "Archived:",
                    dischargedBy: "Discharged by:", // New label
                    dischargeDate: "Discharge Date:", // New label
                    submitter: "Triage/Assignment by:", // Use previous submitter for context
                    cleared: "Archive cleared successfully."
                },
                contact: {
                    heading: "Contact Us",
                    addressTitle: "Our Location",
                    detailsTitle: "General Inquiries",
                    formTitle: "Send a Message",
                    namePlaceholder: "Your Name",
                    emailPlaceholder: "Your Email",
                    messagePlaceholder: "Your Message",
                    submitBtn: "Send Message",
                },
                modal: { // NEW MODAL CONTENT
                    title: "Confirm Patient Discharge",
                    staffLabel: "Staff Name (Doctor/Nurse)",
                    dateLabel: "Discharge Date",
                    cancelBtn: "Cancel",
                    confirmBtn: "Confirm & Archive",
                    dischargeFailed: "Discharge failed. Please check the form and try again."
                },
                footer: {
                    rights: "All rights reserved."
                }
            },
            de: {
                title: "SAMS | Notfall Patientenfluss",
                slogan: "Echtzeit Klinische Aufnahme & Triage",
                userIdText: "Benutzer-ID:",
                nav: {
                    home: "Startseite",
                    patientEntry: "Patienteneingabe",
                    receiving: "Empfang",
                    station: "Stationsansicht",
                    archive: "Archiv",
                    contact: "Kontakt"
                },
                home: {
                    heading: "Willkommen beim SAMS Aufnahmesystem",
                    p1: "Diese Oberfläche dient der schnellen Patientenaufnahme und dem Triage-Management in der Notaufnahme. Bitte verwenden Sie den Reiter Patienteneingabe, um eintreffende Patienten sofort zu protokollieren.",
                    p2: "Der Empfangs-Reiter zeigt alle ausstehenden Patienten an, die auf eine klinische Zuweisung warten. Der Stations-Reiter verfolgt aktive Patienten, und das Archiv enthält entlassene Aufzeichnungen. Diese Listen werden in Echtzeit aktualisiert.",
                },
                patientEntry: {
                    heading: "Notfall Patientenschnelleingabe",
                    nameLabel: "Voller Name des Patienten",
                    dobLabel: "Geburtsdatum (Geb.)",
                    complaintLabel: "Hauptbeschwerde (Symptome/Verletzung)",
                    priorityLabel: "Triage-Priorität",
                    priorities: { low: "Niedrig (Geplant/Stabil)", medium: "Mittel (Dringend)", high: "Hoch (Kritisch)" },
                    submitBtn: "Patienteneintrag Protokollieren",
                    success: "Patienteneintrag erfolgreich protokolliert. Das Empfangsteam wurde benachrichtigt.",
                    error: "Fehler beim Speichern des Patienten. Überprüfen Sie die Konsole (Mock-Datenbank ist aktiv, wenn keine Firebase-Verbindung besteht).",
                },
                receiving: {
                    heading: "Eintreffende Patienten (Warten auf Triage)",
                    loading: "Patienten werden geladen...",
                    empty: "Derzeit warten keine Patienten auf die Triage.",
                    receiveBtn: "Auf Station Verschieben", 
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit:",
                    submitter: "Eingereicht von:",
                },
                station: {
                    heading: "Aktive Patienten (Zugewiesene Station)",
                    loading: "Aktive Patienten werden geladen...",
                    empty: "Derzeit ist kein Patient einer Station zugewiesen.",
                    releaseBtn: "Patient Entlassen / Archiv",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Zeit auf Station:",
                    submitter: "Triage/Zuweisung durch:",
                    assigned: "Zugewiesen:",
                    assignBtn: "Mitarbeiter Zuweisen",
                    unassigned: "Nicht Zugewiesen"
                },
                archive: {
                    heading: "Archivierte/Entlassene Patienten",
                    loading: "Archivierte Aufzeichnungen werden geladen...",
                    empty: "Derzeit keine Patienten im Archiv.",
                    priority: "Priorität:",
                    complaint: "Beschwerde:",
                    time: "Archiviert:",
                    dischargedBy: "Entlassen durch:",
                    dischargeDate: "Entlassungsdatum:",
                    submitter: "Triage/Zuweisung durch:",
                    cleared: "Archiv erfolgreich gelöscht."
                },
                contact: {
                    heading: "Kontaktieren Sie uns",
                    addressTitle: "Unser Standort",
                    detailsTitle: "Allgemeine Anfragen",
                    formTitle: "Nachricht senden",
                    namePlaceholder: "Ihr Name",
                    emailPlaceholder: "Ihre E-Mail",
                    messagePlaceholder: "Ihre Nachricht",
                    submitBtn: "Nachricht senden",
                },
                modal: { // NEW MODAL CONTENT
                    title: "Bestätigung der Patientenentlassung",
                    staffLabel: "Mitarbeitername (Arzt/Krankenschwester)",
                    dateLabel: "Entlassungsdatum",
                    cancelBtn: "Abbrechen",
                    confirmBtn: "Bestätigen & Archivieren",
                    dischargeFailed: "Entlassung fehlgeschlagen. Bitte überprüfen Sie das Formular und versuchen Sie es erneut."
                },
                footer: {
                    rights: "Alle Rechte vorbehalten."
                }
            }
        };

        // Utility to safely retrieve DOM elements
        const getEl = (id) => document.getElementById(id);

        /**
         * Renders the UI elements based on the current state (language and activeTab).
         */
        function render() {
            const lang = currentState.language;
            const content = dictionary[lang];
            const activeTab = currentState.activeTab;

            // 1. Update Global Text Elements
            document.title = content.title;
            getEl('header-slogan').textContent = content.slogan;
            getEl('page-title').textContent = content.title.split(' | ')[0];
            getEl('current-lang-text').textContent = lang.toUpperCase();
            getEl('user-id-text').textContent = content.userIdText;
            
            // Update User ID Display
            const userIdDisplay = getEl('user-id-display');
            if(userIdDisplay) {
                userIdDisplay.textContent = userId || 'Loading...';
            }

            // 2. Determine if Receiving Tab needs to blink (unreceived patients exist)
            const shouldBlink = activeTab !== 'receiving' && receivingPatients.length > 0;

            // 3. Render Navigation Tabs
            const tabNav = getEl('tab-nav');
            tabNav.innerHTML = tabs.map(tab => {
                const isActive = tab === activeTab;
                let baseClasses = "tab-btn px-3 py-2 sm:px-4 sm:py-2 text-sm font-medium rounded-lg transition duration-200 cursor-pointer whitespace-nowrap";
                let activeClasses = "bg-blue-600 text-white shadow-lg";
                let inactiveClasses = "text-gray-700 hover:bg-gray-100";
                
                // Add blinking class if conditions met
                if (tab === 'receiving' && shouldBlink) {
                    baseClasses += ' blinking-red';
                    inactiveClasses = "text-red-800 hover:bg-red-100";
                }

                return `
                    <button id="btn-${tab}" data-tab="${tab}" class="${baseClasses} ${isActive ? activeClasses : inactiveClasses}" onclick="window.setTab('${tab}')">
                        ${content.nav[tab]}
                    </button>
                `;
            }).join('');

            // 4. Update Content Sections and Visibility
            tabs.forEach(tab => {
                const tabEl = getEl(`tab-${tab}`);
                if (tabEl) {
                    tabEl.classList.toggle('hidden', tab !== activeTab);
                }
            });

            // Home Tab Content
            getEl('home-heading').textContent = content.home.heading;
            getEl('home-paragraph-1').textContent = content.home.p1;
            getEl('home-paragraph-2').textContent = content.home.p2;

            // Patient Entry Tab Content (Update labels and options)
            getEl('patientEntry-heading').innerHTML = `<span data-lucide="user-plus" class="w-6 h-6 mr-2 text-green-600"></span>${content.patientEntry.heading}`;
            getEl('p-name-label').textContent = content.patientEntry.nameLabel;
            getEl('p-dob-label').textContent = content.patientEntry.dobLabel;
            getEl('p-complaint-label').textContent = content.patientEntry.complaintLabel;
            getEl('p-priority-label').textContent = content.patientEntry.priorityLabel;
            getEl('patientEntry-submit-btn').textContent = content.patientEntry.submitBtn;

            const prioritySelect = getEl('p-priority');
            if (prioritySelect.options.length === 0 || prioritySelect.options[0].value !== 'low') {
                prioritySelect.innerHTML = Object.entries(content.patientEntry.priorities).map(([key, value]) => 
                    `<option value="${key}" ${key === 'medium' ? 'selected' : ''}>${value}</option>`
                ).join('');
            }

            // Modal Content (Update labels and buttons)
            getEl('modal-title').innerHTML = `<span data-lucide="shield-check" class="w-6 h-6 mr-2 text-blue-600"></span>${content.modal.title}`;
            getEl('modal-staff-label').textContent = content.modal.staffLabel;
            getEl('modal-date-label').textContent = content.modal.dateLabel;
            getEl('modal-cancel-btn').textContent = content.modal.cancelBtn;
            getEl('modal-confirm-btn').textContent = content.modal.confirmBtn;


            // Dynamic Content Rendering
            if (activeTab === 'receiving') renderPatientList(receivingPatients, 'receiving', content);
            if (activeTab === 'station') renderPatientList(stationPatients, 'station', content);
            if (activeTab === 'archive') renderPatientList(archivedPatients, 'archive', content);

            // Contact Tab Content (Remains same)
            getEl('contact-heading').innerHTML = `<span data-lucide="mail" class="w-6 h-6 mr-2 text-gray-600"></span>${content.contact.heading}`;
            getEl('contact-address-title').textContent = content.contact.addressTitle;
            getEl('contact-details-title').textContent = content.contact.detailsTitle;
            getEl('contact-form-title').textContent = content.contact.formTitle;
            getEl('contact-name-placeholder').placeholder = content.contact.namePlaceholder;
            getEl('contact-email-placeholder').placeholder = content.contact.emailPlaceholder;
            getEl('contact-message-placeholder').placeholder = content.contact.messagePlaceholder;
            getEl('contact-submit-btn').textContent = content.contact.submitBtn;

            // Footer
            getEl('footer-year').textContent = new Date().getFullYear();
            getEl('footer-rights').textContent = content.footer.rights;
            
            // Re-render Lucide icons
            lucide.createIcons();
        }

        /**
         * Renders a list of patients in the specified tab based on the provided data.
         * @param {Array<Object>} listData - The patient array (receiving, station, or archive).
         * @param {string} tabId - The ID of the tab ('receiving', 'station', 'archive').
         * @param {object} content - The dictionary content for the current language.
         */
        function renderPatientList(listData, tabId, content) {
            const container = getEl(`${tabId}-list-container`);
            const tabContent = content[tabId];
            if (!container) return; 

            if (!isAuthReady) {
                container.innerHTML = `<div class="text-center text-gray-500 italic p-4">${tabContent.loading}</div>`;
                return;
            }
            
            if (listData.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 italic p-4">${tabContent.empty}</p>`;
                return;
            }

            container.innerHTML = listData.map(entry => {
                const priorityClass = {
                    high: 'bg-red-100 text-red-800 border-red-400',
                    medium: 'bg-yellow-100 text-yellow-800 border-yellow-400',
                    low: 'bg-green-100 text-green-800 border-green-400'
                }[entry.priority] || 'bg-gray-100 text-gray-800 border-gray-400';

                const displayPriority = content.patientEntry.priorities[entry.priority] || entry.priority;
                
                // Determine Time, Submitter, and Button based on state
                let timeLabel, submitterId, buttonText, buttonAction, buttonClass, submitterLabel, extraInfo = '';

                if (tabId === 'receiving') {
                    timeLabel = content.receiving.time;
                    submitterLabel = content.receiving.submitter;
                    submitterId = entry.submitterId;
                    buttonText = content.receiving.receiveBtn;
                    buttonAction = `window.moveToStation('${entry.id}')`;
                    buttonClass = 'bg-red-600 hover:bg-red-700';
                } else if (tabId === 'station') {
                    timeLabel = content.station.time;
                    submitterLabel = content.station.submitter;
                    submitterId = entry.receiverId || 'N/A';
                    buttonText = content.station.releaseBtn;
                    // *** MODIFIED ACTION TO OPEN MODAL ***
                    buttonAction = `window.openDischargeModal('${entry.id}', '${entry.name}')`;
                    buttonClass = 'bg-blue-600 hover:bg-blue-700';

                    // --- STAFF ASSIGNMENT UI ---
                    const assignedStaff = entry.assignedStaffName ? 
                        `${entry.assignedStaffName} (${entry.assignedStaffRole})` : 
                        content.station.unassigned;
                    
                    const assignedStaffColor = entry.assignedStaffName ? 'text-blue-700 font-semibold' : 'text-gray-500 italic';

                    extraInfo = `
                        <div class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-2 sm:space-y-0 sm:space-x-4">
                            <p class="text-sm">
                                <span class="font-semibold">${content.station.assigned}</span> 
                                <span class="${assignedStaffColor}">${assignedStaff}</span>
                            </p>
                            <div class="flex items-center space-x-2">
                                <select id="staff-select-${entry.id}" class="p-2 border border-gray-300 rounded-lg text-xs sm:text-sm bg-white">
                                    <option value="">-- Select Staff --</option>
                                    ${mockStaff.map(staff => `<option value="${staff.id}" data-role="${staff.role}" ${entry.assignedStaffId === staff.id ? 'selected' : ''}>${staff.name} (${staff.role})</option>`).join('')}
                                </select>
                                <button onclick="window.assignStaff('${entry.id}')" 
                                        class="px-3 py-2 text-white font-medium rounded-lg text-xs bg-green-600 hover:bg-green-700 transition duration-200 shadow-sm">
                                    <span data-lucide="user-check" class="w-4 h-4 inline-block mr-1"></span>
                                    ${content.station.assignBtn}
                                </button>
                            </div>
                        </div>
                    `;

                } else { // archive
                    timeLabel = content.archive.time;
                    submitterLabel = content.archive.submitter;
                    submitterId = entry.receiverId || 'N/A';
                    buttonText = 'Record Archived';
                    buttonAction = `console.log('Record is safe from deletion (for now).')`;
                    buttonClass = 'bg-gray-500 cursor-default';
                    
                    // Display who was assigned before archive
                    const assignedStaff = entry.assignedStaffName ? 
                        `${entry.assignedStaffName} (${entry.assignedStaffRole})` : 
                        content.station.unassigned;

                    // Display new discharge info
                    const dischargeName = entry.releaserName || content.archive.dischargedBy + ' N/A';
                    const dischargeDate = entry.dischargeDate || 'N/A';


                    extraInfo = `
                        <p class="text-xs text-gray-700 mt-2 font-semibold">
                            ${content.archive.dischargedBy} <span class="font-normal text-gray-600">${dischargeName}</span>
                        </p>
                        <p class="text-xs text-gray-700">
                            ${content.archive.dischargeDate} <span class="font-normal text-gray-600">${dischargeDate}</span>
                        </p>
                        <p class="text-xs text-gray-500 mt-1">
                            <span class="font-semibold">${content.station.assigned}</span> ${assignedStaff}
                        </p>
                    `;
                }

                // Handle timestamp formatting
                let timestampField;
                if (tabId === 'archive') timestampField = entry.archivedAt;
                else if (tabId === 'station') timestampField = entry.receivedAt;
                else timestampField = entry.timestamp;

                let timeStr = 'N/A';
                if (timestampField && timestampField.seconds) {
                    timeStr = new Date(timestampField.seconds * 1000).toLocaleTimeString(currentState.language, { hour: '2-digit', minute: '2-digit' });
                } else if (timestampField instanceof Date) {
                    timeStr = timestampField.toLocaleTimeString(currentState.language, { hour: '2-digit', minute: '2-digit' });
                }

                const submitterDisplay = (submitterId || 'unknown').substring(0, 8) + '...';
                
                return `
                    <div class="patient-card p-4 border-l-4 ${priorityClass} rounded-lg shadow-md flex justify-between items-start flex-col space-y-3">
                        <div class="w-full">
                            <h3 class="text-xl font-bold mb-1">${entry.name} <span class="text-sm font-normal text-gray-600">(${entry.dob})</span></h3>
                            <p class="text-sm font-semibold mb-2 ${priorityClass.split(' ')[1]}">
                                ${content.receiving.priority} ${displayPriority}
                            </p>
                            <p class="text-sm text-gray-700">
                                <span class="font-semibold">${content.receiving.complaint}</span> ${entry.chiefComplaint}
                            </p>
                            <div class="text-xs text-gray-500 mt-2 space-x-4">
                                <span>${timeLabel} ${timeStr}</span>
                                <span>| ${submitterLabel} ${submitterDisplay}</span>
                                ${useMockDb ? '<span class="text-red-500 font-bold ml-4">(MOCK DB ACTIVE)</span>' : ''}
                            </div>
                            ${extraInfo}
                        </div>
                        <button onclick="${buttonAction}" 
                                class="w-full sm:w-auto mt-2 px-4 py-2 text-white font-medium rounded-lg transition duration-200 shadow-md ${buttonClass}"
                                ${tabId === 'archive' ? 'disabled' : ''}>
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');
            lucide.createIcons(); // Re-create icons for new buttons/info
        }

        /**
         * Changes the active tab and re-renders the UI.
         * @param {string} tabId - The ID of the tab to switch to.
         */
        window.setTab = function(tabId) {
            if (currentState.activeTab !== tabId) {
                currentState.activeTab = tabId;
                render();
            }
        };

        /**
         * Toggles the language between English ('en') and German ('de').
         */
        function toggleLanguage() {
            currentState.language = currentState.language === 'en' ? 'de' : 'en';
            render();
        }

        // --- MODAL FUNCTIONS ---

        /**
         * Opens the discharge modal for a specific patient.
         */
        window.openDischargeModal = function(patientId, patientName) {
            modalPatientId = patientId;
            const modalEl = getEl('discharge-modal');
            
            getEl('modal-patient-name').textContent = dictionary[currentState.language].modal.title.replace('Patient Discharge', patientName + ' Discharge');
            getEl('discharge-staff-name').value = ''; // Clear previous entry
            getEl('discharge-date').value = getTodayDateString(); // Set default date

            modalEl.classList.remove('hidden', 'opacity-0');
            modalEl.classList.add('opacity-100');
            getEl('discharge-form').addEventListener('submit', handleDischargeConfirmation, { once: true });
        };

        /**
         * Closes the modal.
         */
        window.closeModal = function() {
            const modalEl = getEl('discharge-modal');
            modalEl.classList.remove('opacity-100');
            modalEl.classList.add('opacity-0');
            setTimeout(() => {
                modalEl.classList.add('hidden');
                modalPatientId = null;
            }, 300);
        };

        /**
         * Handles the submission of the discharge form (the modal).
         */
        async function handleDischargeConfirmation(e) {
            e.preventDefault();
            
            if (!modalPatientId) {
                console.error("No patient ID associated with the modal.");
                window.closeModal();
                return;
            }

            const staffName = getEl('discharge-staff-name').value.trim();
            const dischargeDate = getEl('discharge-date').value;

            if (!staffName || !dischargeDate) {
                console.error(dictionary[currentState.language].modal.dischargeFailed);
                // Re-attach listener if validation failed and user tries again
                getEl('discharge-form').addEventListener('submit', handleDischargeConfirmation, { once: true });
                return;
            }

            // Perform the patient release/archive operation
            await releasePatient(modalPatientId, staffName, dischargeDate);
            
            window.closeModal();
        }

        // --- MOCK DB FUNCTIONS (Fallback when Firebase is unavailable) ---

        /**
         * Filters the mock database into the three main state arrays.
         */
        function filterPatients(patients) {
            receivingPatients = patients.filter(p => p.state === 'receiving');
            stationPatients = patients.filter(p => p.state === 'station');
            archivedPatients = patients.filter(p => p.state === 'archived');
            
            // Sort by time, newest first
            receivingPatients.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
            stationPatients.sort((a, b) => b.receivedAt?.getTime() - a.receivedAt?.getTime());
            archivedPatients.sort((a, b) => b.archivedAt?.getTime() - a.archivedAt?.getTime());
        }

        /**
         * Simulates the Firestore onSnapshot listener for all patients.
         */
        function setupMockListener() {
            filterPatients(mockPatients);
            render();
        }

        /**
         * Adds a new patient entry to the mock database.
         */
        function addMockPatientEntry(patientData) {
            const newEntry = {
                id: crypto.randomUUID(),
                ...patientData,
                state: 'receiving', // New state field
                timestamp: new Date(),
                submitterId: userId
            };
            mockPatients.push(newEntry);
            setupMockListener(); 
        }

        /**
         * Moves a patient from 'receiving' to 'station' in the mock database.
         */
        function moveToMockStation(patientId) {
            const patient = mockPatients.find(p => p.id === patientId);
            if (patient && patient.state === 'receiving') {
                patient.state = 'station';
                patient.receivedAt = new Date(); // Timestamp for moving to station
                patient.receiverId = userId;
                setupMockListener(); 
            }
        }
        
        /**
         * Releases a patient from 'station' to 'archived' in the mock database.
         */
        function releaseMockPatient(patientId, staffName, dischargeDate) {
            const patient = mockPatients.find(p => p.id === patientId);
            if (patient && patient.state === 'station') {
                patient.state = 'archived';
                patient.archivedAt = new Date(); // Timestamp for archiving
                patient.releaserId = userId;
                // *** NEW DISCHARGE FIELDS ***
                patient.releaserName = staffName;
                patient.dischargeDate = dischargeDate;
                // **************************
                setupMockListener(); 
            }
        }

        /**
         * Assigns staff in the mock database.
         */
        function assignMockStaff(patientId, staffId, staffName, staffRole) {
            const patient = mockPatients.find(p => p.id === patientId);
            if (patient && patient.state === 'station') {
                patient.assignedStaffId = staffId;
                patient.assignedStaffName = staffName;
                patient.assignedStaffRole = staffRole;
                setupMockListener(); 
            }
        }

        /**
         * Clears old archived patients from the mock database. (1 hour threshold for real app, using 1 minute for easy testing of logic)
         */
        function clearOldMockArchives() {
            // Using 1 minute (60000ms) for demo purposes, but simulating the hourly action
            const ONE_HOUR_MS_MOCK = 60000; 
            const oneHourAgo = new Date(Date.now() - ONE_HOUR_MS_MOCK); 
            
            const initialCount = mockPatients.length;
            mockPatients = mockPatients.filter(p => 
                p.state !== 'archived' || (p.archivedAt && p.archivedAt.getTime() > oneHourAgo.getTime())
            );
            
            const deletedCount = initialCount - mockPatients.length;
            if (deletedCount > 0) {
                console.log(`[Mock DB Cleanup] Cleared ${deletedCount} archived patient records.`);
                setupMockListener();
                localStorage.setItem('samsLastArchiveCheck', Date.now()); // Update check time
            }
        }


        // --- FIREBASE FUNCTIONS ---

        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Switching to Mock Database.");
                useMockDb = true;
                isAuthReady = true;
                userId = 'MOCK-USER-' + Math.random().toString(36).substring(2, 10);
                setupMockListener();
                render();
                // Start mock archive clearance check (using 1 minute for demo)
                setInterval(clearOldMockArchives, 60000);
                // Run check once on load if overdue
                if (Date.now() - (localStorage.getItem('samsLastArchiveCheck') || 0) > 60000) {
                    clearOldMockArchives();
                }
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                const signInPromise = new Promise((resolve) => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                        }
                        isAuthReady = true;
                        
                        const userIdDisplay = getEl('user-id-display');
                        if(userIdDisplay) { userIdDisplay.textContent = userId; }

                        render(); 
                        resolve();
                    });
                });
                
                await signInPromise;

                if (db && isAuthReady) {
                    setupRealtimeListener(db);
                }

            } catch (e) {
                console.error("Error initializing Firebase or Auth:", e);
                useMockDb = true;
                isAuthReady = true;
                userId = 'MOCK-USER-' + Math.random().toString(36).substring(2, 10);
                setupMockListener();
                render();
            }

            // Start automated archive clearance logic (1 hour interval)
            const ONE_HOUR_MS = 60 * 60 * 1000;
            setInterval(clearOldArchives, ONE_HOUR_MS);
            
            // Run check once on load if the last check was more than an hour ago
            if (Date.now() - (localStorage.getItem('samsLastArchiveCheck') || 0) > ONE_HOUR_MS) {
                clearOldArchives();
            }
        }
        
        /**
         * Sets up the real-time listener for all ER patient entries.
         * @param {Firestore} firestore - The Firestore instance.
         */
        function setupRealtimeListener(firestore) {
            const collectionPath = `artifacts/${appId}/public/data/er_patients`;
            const patientsCollection = collection(firestore, collectionPath);
            
            const q = query(patientsCollection); 

            onSnapshot(q, (snapshot) => {
                allPatients = [];
                snapshot.forEach((doc) => {
                    allPatients.push({ id: doc.id, ...doc.data() });
                });
                
                filterPatients(allPatients);
                render();
            }, (error) => {
                console.error("Error listening to patients data: ", error);
            });
        }

        /**
         * Adds a new patient entry to Firestore or the Mock DB.
         */
        async function addPatientEntry(patientData) {
            const msgBox = getEl('patient-message-box');
            const content = dictionary[currentState.language].patientEntry;

            if (useMockDb) {
                addMockPatientEntry(patientData);
                msgBox.textContent = content.success;
                msgBox.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-800';
                setTimeout(() => msgBox.classList.add('hidden'), 3000);
                document.getElementById('patient-entry-form').reset(); 
                msgBox.classList.remove('hidden');
                return;
            }

            if (!db || !userId) {
                console.error("Database not ready. Cannot add patient.");
                msgBox.textContent = content.error;
                msgBox.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-800';
                msgBox.classList.remove('hidden');
                return;
            }
            
            const collectionPath = `artifacts/${appId}/public/data/er_patients`;

            try {
                await addDoc(collection(db, collectionPath), {
                    ...patientData,
                    state: 'receiving', // Initial state
                    timestamp: serverTimestamp(),
                    submitterId: userId
                });
                
                msgBox.textContent = content.success;
                msgBox.className = 'mt-4 p-3 rounded-lg text-center bg-green-100 text-green-800';
                setTimeout(() => msgBox.classList.add('hidden'), 3000);
                document.getElementById('patient-entry-form').reset(); 
                msgBox.classList.remove('hidden');

            } catch (e) {
                msgBox.textContent = content.error;
                msgBox.className = 'mt-4 p-3 rounded-lg text-center bg-red-100 text-red-800';
                msgBox.classList.remove('hidden');
                console.error("Error adding document to Firebase: ", e);
            }
        }
        
        /**
         * Updates a patient entry's status from 'receiving' to 'station'.
         */
        window.moveToStation = async function(patientId) {
            if (useMockDb) {
                moveToMockStation(patientId);
                return;
            }

            if (!db) return console.error("Database not ready. Cannot move patient to station.");

            const docPath = `artifacts/${appId}/public/data/er_patients/${patientId}`;
            try {
                await updateDoc(doc(db, docPath), {
                    state: 'station',
                    receivedAt: serverTimestamp(),
                    receiverId: userId // Triage/Assignment officer
                });
                window.setTab('station'); // Automatically switch to the station view
            } catch (e) {
                console.error("Error updating patient status to station: ", e);
            }
        };

        /**
         * Updates a patient entry's status from 'station' to 'archived'.
         * Now requires staffName and dischargeDate.
         */
        async function releasePatient(patientId, staffName, dischargeDate) {
            if (useMockDb) {
                releaseMockPatient(patientId, staffName, dischargeDate);
                return;
            }

            if (!db) return console.error("Database not ready. Cannot release patient.");

            const docPath = `artifacts/${appId}/public/data/er_patients/${patientId}`;
            try {
                await updateDoc(doc(db, docPath), {
                    state: 'archived',
                    archivedAt: serverTimestamp(),
                    releaserId: userId, // Discharge officer ID
                    releaserName: staffName, // NEW
                    dischargeDate: dischargeDate // NEW
                });
                window.setTab('archive'); // Automatically switch to the archive view
            } catch (e) {
                console.error("Error updating patient status to archived: ", e);
            }
        };

        /**
         * Assigns a staff member to a patient on the station.
         */
        window.assignStaff = async function(patientId) {
            const selectEl = getEl(`staff-select-${patientId}`);
            if (!selectEl || !selectEl.value) {
                console.warn("Please select a staff member before assigning.");
                return;
            }

            const selectedStaffId = selectEl.value;
            const selectedStaffOption = mockStaff.find(s => s.id === selectedStaffId);
            
            if (!selectedStaffOption) {
                 console.error("Invalid staff selected.");
                 return;
            }

            const { name, role } = selectedStaffOption;

            if (useMockDb) {
                assignMockStaff(patientId, selectedStaffId, name, role);
                return;
            }

            if (!db) return console.error("Database not ready. Cannot assign staff.");

            const docPath = `artifacts/${appId}/public/data/er_patients/${patientId}`;
            try {
                await updateDoc(doc(db, docPath), {
                    assignedStaffId: selectedStaffId,
                    assignedStaffName: name,
                    assignedStaffRole: role
                });
                console.log(`Staff ${name} assigned to patient ${patientId}`);
            } catch (e) {
                console.error("Error assigning staff: ", e);
            }
        };

        /**
         * Clears archived documents older than 1 hour.
         * Runs on a timer/page load check.
         */
        async function clearOldArchives() {
            const ONE_HOUR_MS = 60 * 60 * 1000;
            const cutoffTime = Date.now() - ONE_HOUR_MS;
            const collectionPath = `artifacts/${appId}/public/data/er_patients`;
            
            // Check if Firebase is ready or if we are using mock DB
            if (useMockDb) {
                clearOldMockArchives();
                return;
            }
            
            if (!db) return console.error("Database not ready. Cannot run archive clearance.");

            console.log(`[Archive Cleanup] Checking for records archived before: ${new Date(cutoffTime).toLocaleTimeString()}`);
            
            let deletedCount = 0;
            const deletePromises = [];

            // Filter for archived patients older than the cutoff time
            const patientsToDelete = allPatients.filter(p => 
                p.state === 'archived' && p.archivedAt && (p.archivedAt.seconds * 1000) < cutoffTime
            );

            if (patientsToDelete.length > 0) {
                console.log(`[Archive Cleanup] Found ${patientsToDelete.length} records to delete...`);
                
                patientsToDelete.forEach(patient => {
                    const docRef = doc(db, collectionPath, patient.id);
                    deletePromises.push(deleteDoc(docRef).then(() => {
                        deletedCount++;
                    }).catch(e => {
                        console.error(`Error deleting doc ${patient.id}:`, e);
                    }));
                });

                await Promise.all(deletePromises);
                console.log(`[Archive Cleanup] Successfully deleted ${deletedCount} records.`);
                localStorage.setItem('samsLastArchiveCheck', Date.now());
            } else {
                console.log("[Archive Cleanup] No old records found to delete.");
            }
        }


        // --- Event Listeners and Initialization ---

        getEl('language-toggle').addEventListener('click', toggleLanguage);

        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase(); 

            // Simple contact form submission handler (prevents page reload)
            const contactForm = getEl('tab-contact').querySelector('form');
            contactForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const submitBtn = getEl('contact-submit-btn');
                const originalText = submitBtn.textContent;
                
                submitBtn.textContent = currentState.language === 'en' ? 'Message Sent! Thank you.' : 'Nachricht gesendet! Danke.';
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                
                setTimeout(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                    submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    contactForm.reset();
                }, 3000);
            });

            // Patient Entry form handler
            const patientForm = getEl('patient-entry-form');
            patientForm.addEventListener('submit', (e) => {
                e.preventDefault();

                const patientData = {
                    name: getEl('p-name').value,
                    dob: getEl('p-dob').value,
                    chiefComplaint: getEl('p-complaint').value,
                    priority: getEl('p-priority').value,
                };
                
                addPatientEntry(patientData);
            });
            
            // Set the default date for the modal form on load
            getEl('discharge-date').value = getTodayDateString();
        });
    </script>
</body>
</html>
